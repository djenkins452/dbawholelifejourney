{% extends "base.html" %}

{% block title %}{{ project.title }} - Life{% endblock %}

{% block content %}
<div class="container">
    <nav class="breadcrumb mb-4">
        <a href="{% url 'life:home' %}">Life</a>
        <span>/</span>
        <a href="{% url 'life:project_list' %}">Projects</a>
        <span>/</span>
        <span>{{ project.title }}</span>
    </nav>
    
    <div class="project-detail">
        <!-- Header -->
        <div class="project-header-detail">
            {% if project.cover_image %}
            <div class="project-cover-large" style="background-image: url('{{ project.cover_image.url }}')"></div>
            {% endif %}
            
            <div class="project-header-content">
                <div class="project-title-row">
                    <h1 class="page-title">{{ project.title }}</h1>
                    <div class="project-badges">
                        <span class="status-badge status-{{ project.status }}">{{ project.get_status_display }}</span>
                        <span class="priority-badge priority-{{ project.priority }}">{{ project.get_priority_display }}</span>
                    </div>
                </div>
                
                {% if project.category %}
                <span class="project-category">{{ project.category }}</span>
                {% endif %}
                
                <div class="project-actions">
                    <a href="{% url 'life:project_update' project.pk %}" class="btn btn-secondary">Edit Project</a>
                    <a href="{% url 'life:task_create' %}?project={{ project.pk }}" class="btn btn-primary">Add Task</a>
                </div>
            </div>
        </div>
        
        <div class="project-body">
            <!-- Main Content -->
            <div class="project-main">
                {% if project.purpose %}
                <section class="project-section">
                    <h2>Purpose</h2>
                    <p class="project-purpose">{{ project.purpose }}</p>
                </section>
                {% endif %}
                
                {% if project.description %}
                <section class="project-section">
                    <h2>Description</h2>
                    <p>{{ project.description|linebreaks }}</p>
                </section>
                {% endif %}
                
                <!-- Tasks -->
                <section class="project-section">
                    <div class="section-header">
                        <h2>Tasks</h2>
                        <a href="{% url 'life:task_create' %}?project={{ project.pk }}" class="btn btn-sm btn-secondary">Add Task</a>
                    </div>
                    
                    {% if tasks %}
                    <ul class="task-list-detail">
                        {% for task in tasks %}
                        <li class="task-item-detail {% if task.is_completed %}completed{% endif %}">
                            <form method="post" action="{% url 'life:task_toggle' task.pk %}" class="task-checkbox-form">
                                {% csrf_token %}
                                <input type="hidden" name="next" value="{{ request.path }}">
                                <button type="submit" class="task-checkbox {% if task.is_completed %}checked{% endif %}">
                                    {% if task.is_completed %}
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                                        <polyline points="22 4 12 14.01 9 11.01"/>
                                    </svg>
                                    {% else %}
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <circle cx="12" cy="12" r="10"/>
                                    </svg>
                                    {% endif %}
                                </button>
                            </form>
                            <div class="task-content">
                                <span class="task-title">{{ task.title }}</span>
                                {% if task.notes %}
                                <span class="task-notes">{{ task.notes|truncatewords:15 }}</span>
                                {% endif %}
                            </div>
                            <div class="task-meta">
                                {% if task.due_date %}
                                <span class="task-due {% if task.due_date < user_today %}overdue{% endif %}">{{ task.due_date|date:"M j" }}</span>
                                {% endif %}
                                <span class="priority-badge priority-{{ task.priority }}">{{ task.get_priority_display }}</span>
                                <a href="{% url 'life:task_update' task.pk %}" class="task-edit">Edit</a>
                            </div>
                        </li>
                        {% endfor %}
                    </ul>
                    {% else %}
                    <p class="text-muted">No tasks yet. <a href="{% url 'life:task_create' %}?project={{ project.pk }}">Add the first task</a></p>
                    {% endif %}
                </section>
                
                <!-- Reflection (for completed projects) -->
                {% if project.status == 'completed' %}
                <section class="project-section">
                    <h2>Reflection</h2>
                    {% if project.reflection %}
                    <p>{{ project.reflection|linebreaks }}</p>
                    {% else %}
                    <p class="text-muted">No reflection added yet. <a href="{% url 'life:project_update' project.pk %}">Add your thoughts</a></p>
                    {% endif %}
                </section>
                {% endif %}
            </div>
            
            <!-- Sidebar -->
            <aside class="project-sidebar">
                <div class="sidebar-card">
                    <h3>Details</h3>
                    <dl class="detail-list">
                        {% if project.start_date %}
                        <dt>Started</dt>
                        <dd>{{ project.start_date|date:"M j, Y" }}</dd>
                        {% endif %}
                        
                        {% if project.target_date %}
                        <dt>Target</dt>
                        <dd class="{% if project.target_date < user_today and project.status == 'active' %}overdue{% endif %}">{{ project.target_date|date:"M j, Y" }}</dd>
                        {% endif %}
                        
                        {% if project.completed_date %}
                        <dt>Completed</dt>
                        <dd>{{ project.completed_date|date:"M j, Y" }}</dd>
                        {% endif %}
                        
                        <dt>Created</dt>
                        <dd>{{ project.created_at|date:"M j, Y" }}</dd>
                    </dl>
                </div>
                
                {% if project.task_count > 0 %}
                <div class="sidebar-card">
                    <h3>Progress</h3>
                    <div class="progress-display">
                        <div class="progress-circle" style="--progress: {{ project.progress_percentage }}">
                            <span class="progress-number">{{ project.progress_percentage }}%</span>
                        </div>
                        <p class="progress-detail">{{ project.completed_task_count }} of {{ project.task_count }} tasks complete</p>
                    </div>
                </div>
                {% endif %}
                
                {% if events %}
                <div class="sidebar-card">
                    <h3>Upcoming Events</h3>
                    <ul class="event-list-small">
                        {% for event in events %}
                        <li>
                            <span class="event-date-small">{{ event.start_date|date:"M j" }}</span>
                            <span>{{ event.title }}</span>
                        </li>
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}
                
                <div class="sidebar-card">
                    <h3>Actions</h3>
                    <div class="action-buttons">
                        <a href="{% url 'life:project_update' project.pk %}" class="btn btn-secondary btn-block">Edit Project</a>
                        <a href="{% url 'life:project_delete' project.pk %}" class="btn btn-ghost btn-block text-error">Delete Project</a>
                    </div>
                </div>
            </aside>
        </div>
    </div>
</div>

<style>
.breadcrumb {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    font-size: var(--font-size-sm);
    color: var(--color-text-muted);
}

.breadcrumb a {
    color: var(--color-accent);
}

.project-cover-large {
    height: 200px;
    background-size: cover;
    background-position: center;
    border-radius: var(--radius-lg);
    margin-bottom: var(--space-5);
}

.project-header-content {
    margin-bottom: var(--space-6);
}

.project-title-row {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: var(--space-4);
    flex-wrap: wrap;
    margin-bottom: var(--space-2);
}

.project-badges {
    display: flex;
    gap: var(--space-2);
}

.status-badge {
    font-size: var(--font-size-xs);
    padding: var(--space-1) var(--space-2);
    border-radius: var(--radius-sm);
}

.status-active {
    background: color-mix(in srgb, #10b981 15%, transparent);
    color: #10b981;
}

.status-paused {
    background: color-mix(in srgb, #f59e0b 15%, transparent);
    color: #f59e0b;
}

.status-completed {
    background: color-mix(in srgb, var(--color-accent) 15%, transparent);
    color: var(--color-accent);
}

.status-archived {
    background: var(--color-surface);
    color: var(--color-text-muted);
}

.priority-badge {
    font-size: var(--font-size-xs);
    padding: var(--space-1) var(--space-2);
    border-radius: var(--radius-sm);
}

.priority-now {
    background: color-mix(in srgb, var(--color-error) 15%, transparent);
    color: var(--color-error);
}

.priority-soon {
    background: color-mix(in srgb, #f59e0b 15%, transparent);
    color: #f59e0b;
}

.priority-someday {
    background: var(--color-surface);
    color: var(--color-text-muted);
}

.project-category {
    display: inline-block;
    font-size: var(--font-size-sm);
    color: var(--color-text-muted);
    margin-bottom: var(--space-4);
}

.project-actions {
    display: flex;
    gap: var(--space-3);
}

.project-body {
    display: grid;
    grid-template-columns: 1fr 300px;
    gap: var(--space-6);
}

@media (max-width: 900px) {
    .project-body {
        grid-template-columns: 1fr;
    }
}

.project-section {
    margin-bottom: var(--space-8);
}

.project-section h2 {
    font-size: var(--font-size-lg);
    margin-bottom: var(--space-4);
}

.section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-4);
}

.section-header h2 {
    margin: 0;
}

.project-purpose {
    font-size: var(--font-size-lg);
    font-style: italic;
    color: var(--color-text-muted);
    border-left: 3px solid var(--color-accent);
    padding-left: var(--space-4);
}

.task-list-detail {
    list-style: none;
    padding: 0;
    margin: 0;
}

.task-item-detail {
    display: flex;
    align-items: flex-start;
    gap: var(--space-3);
    padding: var(--space-3);
    background: var(--color-background);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    margin-bottom: var(--space-2);
}

.task-item-detail.completed {
    opacity: 0.6;
}

.task-item-detail.completed .task-title {
    text-decoration: line-through;
}

.task-checkbox-form {
    /* Remove display: contents which can cause click issues */
    flex-shrink: 0;
    margin: 0;
    padding: 0;
}

.task-checkbox {
    width: 32px;
    height: 32px;
    min-width: 32px;
    min-height: 32px;
    background: none;
    border: none;
    padding: 4px;
    margin: 0;
    cursor: pointer;
    color: var(--color-text-muted);
    flex-shrink: 0;
    position: relative;
    z-index: 10;
    display: flex;
    align-items: center;
    justify-content: center;
    touch-action: manipulation;
    -webkit-tap-highlight-color: transparent;
    -webkit-touch-callout: none;
    user-select: none;
}

.task-checkbox:hover {
    color: var(--color-accent);
}

.task-checkbox:active {
    transform: scale(0.95);
}

.task-checkbox.checked {
    color: var(--color-accent);
}

.task-checkbox svg {
    width: 22px;
    height: 22px;
    pointer-events: none;
    display: block;
}

/* Task completion popup */
.task-completion-popup {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    z-index: 9999;
    background: var(--color-background);
    border: 2px solid #22c55e;
    border-radius: var(--radius-lg);
    padding: var(--space-6);
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
    text-align: center;
    cursor: pointer;
}

.task-completion-popup svg {
    width: 64px;
    height: 64px;
    color: #22c55e;
}

.task-completion-popup svg circle {
    stroke-dasharray: 62.83;
    stroke-dashoffset: 62.83;
    animation: drawCircle 0.5s ease forwards;
}

.task-completion-popup svg polyline {
    stroke-dasharray: 30;
    stroke-dashoffset: 30;
    animation: drawCheck 0.3s ease forwards 0.5s;
}

@keyframes drawCircle {
    to { stroke-dashoffset: 0; }
}

@keyframes drawCheck {
    to { stroke-dashoffset: 0; }
}

@keyframes fadeOut {
    from { opacity: 1; }
    to { opacity: 0; }
}

.task-content {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: var(--space-1);
}

.task-notes {
    font-size: var(--font-size-sm);
    color: var(--color-text-muted);
}

.task-meta {
    display: flex;
    align-items: center;
    gap: var(--space-2);
}

.task-due {
    font-size: var(--font-size-xs);
    color: var(--color-text-muted);
}

.task-due.overdue {
    color: var(--color-error);
}

.task-edit {
    font-size: var(--font-size-xs);
    color: var(--color-text-muted);
}

.sidebar-card {
    background: var(--color-background);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-lg);
    padding: var(--space-5);
    margin-bottom: var(--space-4);
}

.sidebar-card h3 {
    font-size: var(--font-size-base);
    margin: 0 0 var(--space-4) 0;
}

.detail-list {
    display: grid;
    grid-template-columns: auto 1fr;
    gap: var(--space-2) var(--space-4);
    font-size: var(--font-size-sm);
}

.detail-list dt {
    color: var(--color-text-muted);
}

.detail-list dd {
    margin: 0;
}

.detail-list dd.overdue {
    color: var(--color-error);
}

.progress-display {
    text-align: center;
}

.progress-circle {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    background: conic-gradient(var(--color-accent) calc(var(--progress) * 1%), var(--color-surface) 0);
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto var(--space-3);
    position: relative;
}

.progress-circle::before {
    content: '';
    position: absolute;
    width: 60px;
    height: 60px;
    background: var(--color-background);
    border-radius: 50%;
}

.progress-number {
    position: relative;
    font-size: var(--font-size-lg);
    font-weight: 700;
}

.progress-detail {
    font-size: var(--font-size-sm);
    color: var(--color-text-muted);
    margin: 0;
}

.event-list-small {
    list-style: none;
    padding: 0;
    margin: 0;
}

.event-list-small li {
    display: flex;
    gap: var(--space-2);
    padding: var(--space-2) 0;
    font-size: var(--font-size-sm);
    border-bottom: 1px solid var(--color-border);
}

.event-list-small li:last-child {
    border-bottom: none;
}

.event-date-small {
    color: var(--color-accent);
    font-weight: 500;
}

.action-buttons {
    display: flex;
    flex-direction: column;
    gap: var(--space-2);
}

.btn-block {
    width: 100%;
    text-align: center;
}

.text-error {
    color: var(--color-error);
}
</style>

{% if request.GET.task_completed %}
<!-- Task Completion Popup -->
<div id="task-completion-popup" class="task-completion-popup" onclick="this.remove()">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="12" cy="12" r="10"/>
        <polyline points="8 12 11 15 16 9"/>
    </svg>
</div>
<script>
(function() {
    const popup = document.getElementById('task-completion-popup');
    if (popup) {
        // Auto-hide after 3 seconds
        setTimeout(function() {
            popup.style.animation = 'fadeOut 0.3s ease forwards';
            setTimeout(function() {
                popup.remove();
            }, 300);
        }, 3000);

        // Clean up URL
        const url = new URL(window.location);
        url.searchParams.delete('task_completed');
        window.history.replaceState({}, '', url);
    }
})();
</script>
{% endif %}
{% endblock %}
