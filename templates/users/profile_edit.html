{% extends "base.html" %}

{% block title %}Edit Profile - Whole Life Journey{% endblock %}

{% block content %}
<div class="content-container">
    <nav class="breadcrumb mb-4">
        <a href="{% url 'users:preferences' %}">Settings</a>
        <span>/</span>
        <a href="{% url 'users:profile' %}">Profile</a>
        <span>/</span>
        <span>Edit</span>
    </nav>

    <div class="page-header">
        <h1 class="page-title">Edit Profile</h1>
        <p class="page-subtitle">Update your personal information</p>
    </div>
    
    <form method="post" enctype="multipart/form-data" class="profile-form">
        {% csrf_token %}
        
        <!-- Avatar Section -->
        <div class="card mb-6">
            <h2 class="card-title">Profile Photo</h2>
            
            <div class="avatar-upload-section">
                <div class="current-avatar">
                    {% if user.avatar %}
                        <img src="{{ user.avatar.url }}" alt="{{ user.get_full_name }}" class="avatar-preview">
                    {% else %}
                        <div class="avatar-placeholder">
                            <span class="avatar-initials">{{ user.get_initials }}</span>
                        </div>
                    {% endif %}
                </div>
                
                <div class="avatar-controls">
                    <div class="form-group">
                        <label for="id_avatar" class="btn btn-secondary">
                            <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                                <polyline points="17 8 12 3 7 8"/>
                                <line x1="12" y1="3" x2="12" y2="15"/>
                            </svg>
                            Upload Photo
                        </label>
                        <input 
                            type="file" 
                            name="avatar" 
                            id="id_avatar" 
                            class="form-file-input visually-hidden"
                            accept="image/*"
                            onchange="previewAvatar(this)"
                        >
                        <p class="form-help">JPG, PNG, or GIF. Max 2MB.</p>
                    </div>
                    
                    {% if user.avatar %}
                    <div class="form-group">
                        <label class="checkbox-label">
                            <input type="checkbox" name="clear_avatar" class="form-checkbox">
                            <span>Remove current photo</span>
                        </label>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- Personal Info Section -->
        <div class="card mb-6">
            <h2 class="card-title">Personal Information</h2>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="id_first_name" class="form-label">First Name</label>
                    <input 
                        type="text" 
                        name="first_name" 
                        id="id_first_name" 
                        class="form-input"
                        value="{{ form.first_name.value|default:'' }}"
                        placeholder="First name"
                    >
                </div>
                
                <div class="form-group">
                    <label for="id_last_name" class="form-label">Last Name</label>
                    <input 
                        type="text" 
                        name="last_name" 
                        id="id_last_name" 
                        class="form-input"
                        value="{{ form.last_name.value|default:'' }}"
                        placeholder="Last name"
                    >
                </div>
            </div>
        </div>
        
        <!-- Email Section -->
        <div class="card mb-6">
            <h2 class="card-title">Email Address</h2>
            
            <div class="form-group">
                <label for="id_email" class="form-label">Email</label>
                <input 
                    type="email" 
                    name="email" 
                    id="id_email" 
                    class="form-input"
                    value="{{ form.email.value|default:'' }}"
                    placeholder="Email address"
                    required
                >
                <p class="form-help">
                    <svg class="help-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <line x1="12" y1="16" x2="12" y2="12"/>
                        <line x1="12" y1="8" x2="12.01" y2="8"/>
                    </svg>
                    Changing your email will update your login credentials. You'll use the new email to sign in.
                </p>
            </div>
        </div>
        
        <!-- Form Actions -->
        <div class="form-actions">
            <button type="submit" class="btn btn-primary">Save Changes</button>
            <a href="{% url 'users:profile' %}" class="btn btn-ghost">Cancel</a>
        </div>
    </form>
</div>

<style>
.avatar-upload-section {
    display: flex;
    align-items: flex-start;
    gap: var(--space-6);
}

.current-avatar {
    flex-shrink: 0;
}

.avatar-preview {
    width: 120px;
    height: 120px;
    border-radius: var(--radius-full);
    object-fit: cover;
    border: 3px solid var(--color-border);
}

.avatar-placeholder {
    width: 120px;
    height: 120px;
    border-radius: var(--radius-full);
    background: var(--color-accent);
    display: flex;
    align-items: center;
    justify-content: center;
    border: 3px solid var(--color-border);
}

.avatar-initials {
    font-size: var(--font-size-3xl);
    font-weight: 600;
    color: white;
}

.avatar-controls {
    flex: 1;
}

.visually-hidden {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border: 0;
}

.btn-icon {
    width: 18px;
    height: 18px;
    margin-right: var(--space-2);
}

.checkbox-label {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    cursor: pointer;
    font-size: var(--font-size-sm);
    color: var(--color-text-muted);
}

.form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: var(--space-4);
}

.form-help {
    display: flex;
    align-items: flex-start;
    gap: var(--space-2);
    margin-top: var(--space-2);
    font-size: var(--font-size-sm);
    color: var(--color-text-muted);
}

.help-icon {
    width: 16px;
    height: 16px;
    flex-shrink: 0;
    margin-top: 2px;
}

.form-actions {
    display: flex;
    gap: var(--space-3);
}

@media (max-width: 640px) {
    .avatar-upload-section {
        flex-direction: column;
        align-items: center;
        text-align: center;
    }
    
    .form-row {
        grid-template-columns: 1fr;
    }
}
</style>

<script>
function previewAvatar(input) {
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        
        reader.onload = function(e) {
            // Check if preview image exists, if not create one
            let preview = document.querySelector('.avatar-preview');
            let placeholder = document.querySelector('.avatar-placeholder');
            
            if (placeholder) {
                // Replace placeholder with image
                const img = document.createElement('img');
                img.src = e.target.result;
                img.alt = 'Avatar preview';
                img.className = 'avatar-preview';
                placeholder.parentNode.replaceChild(img, placeholder);
            } else if (preview) {
                // Update existing image
                preview.src = e.target.result;
            }
        };
        
        reader.readAsDataURL(input.files[0]);
    }
}
</script>
{% endblock %}
