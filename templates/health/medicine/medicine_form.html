{% extends "base.html" %}
{% load static %}

{% block title %}{% if form.instance.pk %}Edit{% else %}Add{% endif %} Medicine - Health - Whole Life Journey{% endblock %}

{% block content %}
<div class="container">
    <nav class="breadcrumb mb-4">
        <a href="{% url 'health:home' %}">Health</a>
        <span>/</span>
        <a href="{% url 'health:medicine_home' %}">Medicines</a>
        <span>/</span>
        <span>{% if form.instance.pk %}Edit{% else %}Add{% endif %} Medicine</span>
    </nav>

    <div class="page-header">
        <h1 class="page-title">{% if form.instance.pk %}Edit {{ form.instance.name }}{% else %}Add Medicine{% endif %}</h1>
    </div>

    {% if not form.instance.pk %}
    <!-- Barcode Scanner Section (only for new medicines) -->
    <div class="scan-section">
        <div class="scan-header">
            <span class="scan-icon">ðŸ’Š</span>
            <div class="scan-info">
                <strong>Scan Medicine Barcode</strong>
                <span class="scan-hint">Quickly fill in medicine details by scanning the barcode on OTC products</span>
            </div>
        </div>
        <button type="button" id="startBarcodeScanner" class="btn btn-outline">
            <span class="btn-icon">ðŸ“±</span>
            Scan Barcode
        </button>
        {% if source == 'barcode_scan' and barcode_from_scan %}
        <div class="scan-success">
            <span class="success-icon">âœ“</span>
            Form pre-filled from barcode: {{ barcode_from_scan }}
        </div>
        {% endif %}
    </div>

    <!-- Barcode Scanner Modal -->
    <div id="barcodeScannerModal" class="scanner-modal" style="display: none;">
        <div class="scanner-modal-content">
            <div class="scanner-header">
                <h3>Scan Medicine Barcode</h3>
                <button type="button" id="closeBarcodeScanner" class="close-btn">&times;</button>
            </div>
            <div class="scanner-body">
                <div id="scannerPreview" class="scanner-preview">
                    <video id="barcodeVideo" playsinline></video>
                    <div class="scanner-overlay">
                        <div class="scanner-target"></div>
                    </div>
                </div>
                <div id="scannerStatus" class="scanner-status">
                    Point your camera at a medicine barcode
                </div>
                <div id="scannerResult" class="scanner-result" style="display: none;">
                    <div class="result-content">
                        <span class="result-label">Barcode detected:</span>
                        <span id="detectedBarcode" class="result-barcode"></span>
                    </div>
                    <div class="result-actions">
                        <button type="button" id="lookupBarcode" class="btn btn-primary btn-sm">Look Up Medicine</button>
                        <button type="button" id="rescanBarcode" class="btn btn-outline btn-sm">Scan Again</button>
                    </div>
                </div>
                <div id="lookupProgress" class="lookup-progress" style="display: none;">
                    <div class="spinner"></div>
                    <span>Looking up medicine...</span>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <form method="post" class="form-container">
        {% csrf_token %}

        {% if form.errors %}
        <div class="form-errors mb-4">
            <p class="error-title">Please fix the following errors:</p>
            <ul>
                {% for field in form %}
                    {% for error in field.errors %}
                    <li>{{ field.label }}: {{ error }}</li>
                    {% endfor %}
                {% endfor %}
                {% for error in form.non_field_errors %}
                <li>{{ error }}</li>
                {% endfor %}
            </ul>
        </div>
        {% endif %}

        <div class="form-section">
            <h2 class="form-section-title">Basic Information</h2>

            <div class="form-group">
                <label for="id_name">Medicine Name *</label>
                {{ form.name }}
                <p class="form-help">Brand name or generic name</p>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="id_dose">Dose *</label>
                    {{ form.dose }}
                    <p class="form-help">e.g., 10mg, 500mg, 1 tablet, 2 puffs</p>
                </div>
                <div class="form-group">
                    <label for="id_purpose">Purpose</label>
                    {{ form.purpose }}
                    <p class="form-help">What is this medicine for?</p>
                </div>
            </div>
        </div>

        <div class="form-section">
            <h2 class="form-section-title">Schedule</h2>

            <div class="form-row">
                <div class="form-group">
                    <label for="id_frequency">Frequency *</label>
                    {{ form.frequency }}
                </div>
                <div class="form-group checkbox-group">
                    <label class="checkbox-label">
                        {{ form.is_prn }}
                        <span>Take as needed (PRN)</span>
                    </label>
                    <p class="form-help">Check if this is an as-needed medication</p>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="id_start_date">Start Date *</label>
                    {{ form.start_date }}
                </div>
                <div class="form-group">
                    <label for="id_end_date">End Date</label>
                    {{ form.end_date }}
                    <p class="form-help">Optional - when you'll stop taking it</p>
                </div>
            </div>

            <div class="form-group">
                <label for="id_grace_period_minutes">Grace Period (minutes)</label>
                {{ form.grace_period_minutes }}
                <p class="form-help">Minutes after scheduled time before marking as overdue</p>
            </div>
        </div>

        <div class="form-section">
            <h2 class="form-section-title">Refill Tracking</h2>

            <div class="form-row">
                <div class="form-group">
                    <label for="id_current_supply">Current Supply</label>
                    {{ form.current_supply }}
                    <p class="form-help">How many doses do you have?</p>
                </div>
                <div class="form-group">
                    <label for="id_refill_threshold">Low Supply Alert</label>
                    {{ form.refill_threshold }}
                    <p class="form-help">Alert when supply drops to this level</p>
                </div>
            </div>
        </div>

        <div class="form-section collapsible">
            <h2 class="form-section-title">Prescription Details (Optional)</h2>

            <div class="form-row">
                <div class="form-group">
                    <label for="id_prescribing_doctor">Prescribing Doctor</label>
                    {{ form.prescribing_doctor }}
                </div>
                <div class="form-group">
                    <label for="id_pharmacy">Pharmacy</label>
                    {{ form.pharmacy }}
                </div>
            </div>

            <div class="form-group">
                <label for="id_rx_number">Prescription Number</label>
                {{ form.rx_number }}
            </div>
        </div>

        <div class="form-section">
            <h2 class="form-section-title">Notes</h2>

            <div class="form-group">
                <label for="id_instructions">Special Instructions</label>
                {{ form.instructions }}
                <p class="form-help">e.g., take with food, avoid grapefruit</p>
            </div>

            <div class="form-group">
                <label for="id_notes">Personal Notes</label>
                {{ form.notes }}
            </div>
        </div>

        <div class="form-actions">
            <button type="submit" class="btn btn-primary">
                {% if form.instance.pk %}Save Changes{% else %}Add Medicine{% endif %}
            </button>
            <a href="{% if form.instance.pk %}{% url 'health:medicine_detail' pk=form.instance.pk %}{% else %}{% url 'health:medicine_list' %}{% endif %}" class="btn btn-secondary">Cancel</a>
        </div>
    </form>
</div>

<style>
.form-container {
    max-width: 700px;
}

.form-section {
    margin-bottom: var(--space-6);
    padding: var(--space-5);
    background: var(--color-background);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-lg);
}

.form-section-title {
    font-size: var(--font-size-lg);
    margin-bottom: var(--space-4);
    padding-bottom: var(--space-3);
    border-bottom: 1px solid var(--color-border);
}

.form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: var(--space-4);
}

.form-group {
    margin-bottom: var(--space-4);
}

.form-group label {
    display: block;
    margin-bottom: var(--space-2);
    font-weight: 500;
}

.form-help {
    font-size: var(--font-size-sm);
    color: var(--color-text-muted);
    margin-top: var(--space-1);
}

.checkbox-group {
    display: flex;
    flex-direction: column;
    justify-content: center;
}

.checkbox-label {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    cursor: pointer;
}

.form-errors {
    padding: var(--space-4);
    background: color-mix(in srgb, var(--color-error, #ef4444) 15%, transparent);
    border: 1px solid color-mix(in srgb, var(--color-error, #ef4444) 40%, transparent);
    border-radius: var(--radius-md);
}

.error-title {
    font-weight: 600;
    margin-bottom: var(--space-2);
}

.form-errors ul {
    margin: 0;
    padding-left: var(--space-4);
}

.form-actions {
    display: flex;
    gap: var(--space-3);
    padding-top: var(--space-4);
}

@media (max-width: 640px) {
    .form-row {
        grid-template-columns: 1fr;
    }
}

/* Barcode Scanner Styles */
.scan-section {
    background: linear-gradient(135deg, color-mix(in srgb, var(--color-accent) 15%, transparent) 0%, var(--color-background) 100%);
    border: 2px dashed var(--color-accent);
    border-radius: var(--radius-lg);
    padding: var(--space-4);
    margin-bottom: var(--space-6);
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: var(--space-4);
    max-width: 700px;
}

.scan-header {
    display: flex;
    align-items: center;
    gap: var(--space-3);
}

.scan-icon {
    font-size: 2rem;
}

.scan-info {
    display: flex;
    flex-direction: column;
    gap: var(--space-1);
}

.scan-hint {
    font-size: var(--font-size-sm);
    color: var(--color-text-muted);
}

.scan-success {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    color: var(--color-success);
    font-size: var(--font-size-sm);
    margin-top: var(--space-2);
}

.success-icon {
    background: var(--color-success);
    color: white;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
}

/* Scanner Modal */
.scanner-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    z-index: 1000;
    display: flex;
    align-items: center;
    justify-content: center;
}

.scanner-modal-content {
    background: var(--color-background);
    border-radius: var(--radius-lg);
    max-width: 500px;
    width: 90%;
    max-height: 90vh;
    overflow: hidden;
}

.scanner-modal .scanner-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--space-4);
    border-bottom: 1px solid var(--color-border);
}

.scanner-modal .scanner-header h3 {
    margin: 0;
}

.close-btn {
    background: none;
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
    color: var(--color-text-muted);
}

.scanner-body {
    padding: var(--space-4);
}

.scanner-preview {
    position: relative;
    width: 100%;
    aspect-ratio: 4/3;
    background: #000;
    border-radius: var(--radius);
    overflow: hidden;
}

.scanner-preview video {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.scanner-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
}

.scanner-target {
    width: 70%;
    height: 30%;
    border: 2px solid var(--color-accent);
    border-radius: var(--radius);
    box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.5);
}

.scanner-status {
    text-align: center;
    padding: var(--space-3);
    color: var(--color-text-muted);
}

.scanner-result {
    background: color-mix(in srgb, var(--color-success) 15%, transparent);
    border: 1px solid var(--color-success);
    border-radius: var(--radius);
    padding: var(--space-3);
    margin-top: var(--space-3);
}

.result-content {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    margin-bottom: var(--space-3);
}

.result-barcode {
    font-family: monospace;
    font-weight: bold;
    font-size: var(--font-size-lg);
}

.result-actions {
    display: flex;
    gap: var(--space-2);
}

.lookup-progress {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-2);
    padding: var(--space-4);
    color: var(--color-text-muted);
}

.spinner {
    width: 20px;
    height: 20px;
    border: 2px solid var(--color-border);
    border-top-color: var(--color-accent);
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

@media (max-width: 640px) {
    .scan-section {
        flex-direction: column;
        align-items: stretch;
        text-align: center;
    }

    .scan-header {
        flex-direction: column;
    }
}
</style>

{% if not form.instance.pk %}
<!-- ZXing library for cross-browser barcode detection (Safari/iOS compatible) -->
<script src="https://cdn.jsdelivr.net/npm/@zxing/browser@0.1.5/umd/zxing-browser.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const startBtn = document.getElementById('startBarcodeScanner');
    const modal = document.getElementById('barcodeScannerModal');
    const closeBtn = document.getElementById('closeBarcodeScanner');
    const video = document.getElementById('barcodeVideo');
    const statusEl = document.getElementById('scannerStatus');
    const resultEl = document.getElementById('scannerResult');
    const detectedBarcodeEl = document.getElementById('detectedBarcode');
    const lookupBtn = document.getElementById('lookupBarcode');
    const rescanBtn = document.getElementById('rescanBarcode');
    const progressEl = document.getElementById('lookupProgress');

    let stream = null;
    let zxingReader = null;
    let detectedBarcode = '';
    let isScanning = false;
    let scanInterval = null;

    startBtn.addEventListener('click', openScanner);
    closeBtn.addEventListener('click', closeScanner);
    lookupBtn.addEventListener('click', lookupMedicine);
    rescanBtn.addEventListener('click', resetScanner);

    // Close modal when clicking outside
    modal.addEventListener('click', function(e) {
        if (e.target === modal) {
            closeScanner();
        }
    });

    // Initialize ZXing reader
    function getZXingReader() {
        if (!zxingReader && typeof ZXingBrowser !== 'undefined' && ZXingBrowser.BrowserMultiFormatReader) {
            zxingReader = new ZXingBrowser.BrowserMultiFormatReader();
            console.log('ZXing reader initialized');
        }
        return zxingReader;
    }

    async function openScanner() {
        modal.style.display = 'flex';
        resultEl.style.display = 'none';
        progressEl.style.display = 'none';
        statusEl.style.display = 'block';
        statusEl.textContent = 'Starting camera...';

        try {
            stream = await navigator.mediaDevices.getUserMedia({
                video: {
                    facingMode: 'environment',
                    width: { ideal: 1280 },
                    height: { ideal: 720 }
                }
            });
            video.srcObject = stream;
            await video.play();

            // Check if ZXing is available
            const reader = getZXingReader();
            if (reader) {
                statusEl.textContent = 'Point your camera at a medicine barcode';
                // Wait for video to be ready then start detection
                setTimeout(startDetection, 500);
            } else {
                statusEl.textContent = 'Barcode detection not supported. Enter barcode manually.';
                showManualEntry();
            }
        } catch (err) {
            console.error('Camera error:', err);
            statusEl.textContent = 'Could not access camera. Please check permissions.';
            showManualEntry();
        }
    }

    function closeScanner() {
        modal.style.display = 'none';
        stopDetection();
        if (stream) {
            stream.getTracks().forEach(track => track.stop());
            stream = null;
        }
    }

    function stopDetection() {
        isScanning = false;
        if (scanInterval) {
            clearInterval(scanInterval);
            scanInterval = null;
        }
    }

    function startDetection() {
        const reader = getZXingReader();
        if (!reader || !video || video.readyState < 2) {
            setTimeout(startDetection, 200);
            return;
        }

        isScanning = true;
        const processCanvas = document.createElement('canvas');
        let isProcessing = false;

        scanInterval = setInterval(async () => {
            if (!isScanning || isProcessing || video.paused || video.ended || video.readyState < 2) {
                return;
            }

            isProcessing = true;

            try {
                // Capture frame to canvas
                processCanvas.width = video.videoWidth;
                processCanvas.height = video.videoHeight;
                const ctx = processCanvas.getContext('2d');
                ctx.drawImage(video, 0, 0);

                // Create image for ZXing
                const imageData = processCanvas.toDataURL('image/png');
                const img = new Image();
                img.src = imageData;

                await new Promise(resolve => {
                    img.onload = resolve;
                    img.onerror = resolve;
                });

                // Decode barcode
                const result = await reader.decodeFromImageElement(img);

                if (result && result.text) {
                    const code = result.text;
                    console.log('Barcode detected:', code);

                    // Validate it looks like a product barcode
                    if (/^\d{8,14}$/.test(code)) {
                        detectedBarcode = code;
                        stopDetection();
                        showDetectedBarcode(code);

                        // Vibrate on detection
                        if (navigator.vibrate) {
                            navigator.vibrate(100);
                        }
                    }
                }
            } catch (err) {
                // NotFoundException is normal when no barcode visible
                const errName = err.name || err.constructor?.name || '';
                if (errName !== 'NotFoundException' && !errName.includes('NotFound')) {
                    // Only log unexpected errors occasionally
                }
            } finally {
                isProcessing = false;
            }
        }, 200);

        console.log('ZXing barcode detection started');
    }

    function showDetectedBarcode(barcode) {
        detectedBarcodeEl.textContent = barcode;
        resultEl.style.display = 'block';
        statusEl.style.display = 'none';
    }

    function resetScanner() {
        resultEl.style.display = 'none';
        statusEl.style.display = 'block';
        statusEl.textContent = 'Point your camera at a medicine barcode';
        detectedBarcode = '';
        startDetection();
    }

    function showManualEntry() {
        // Check if manual entry already exists
        if (document.getElementById('manualBarcode')) return;

        // Create manual entry input
        const manualInput = document.createElement('div');
        manualInput.innerHTML = `
            <div style="margin-top: var(--space-3);">
                <input type="text" id="manualBarcode" class="form-input"
                       placeholder="Enter barcode number" pattern="[0-9]*" inputmode="numeric">
                <button type="button" id="submitManualBarcode" class="btn btn-primary btn-sm"
                        style="margin-top: var(--space-2);">Look Up</button>
            </div>
        `;
        statusEl.parentNode.insertBefore(manualInput, statusEl.nextSibling);

        document.getElementById('submitManualBarcode').addEventListener('click', function() {
            detectedBarcode = document.getElementById('manualBarcode').value;
            if (detectedBarcode) {
                lookupMedicine();
            }
        });

        // Allow Enter key to submit
        document.getElementById('manualBarcode').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                detectedBarcode = this.value;
                if (detectedBarcode) {
                    lookupMedicine();
                }
            }
        });
    }

    async function lookupMedicine() {
        if (!detectedBarcode) return;

        resultEl.style.display = 'none';
        progressEl.style.display = 'flex';

        try {
            const response = await fetch('{% url "scan:medicine_lookup" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({ barcode: detectedBarcode })
            });

            const data = await response.json();

            if (data.found && data.medicine_url) {
                // Redirect to pre-filled form
                window.location.href = data.medicine_url;
            } else {
                // Show not found message
                progressEl.style.display = 'none';
                alert('Medicine not found in database. You can still fill in the details manually.');
                closeScanner();
            }
        } catch (err) {
            console.error('Lookup error:', err);
            progressEl.style.display = 'none';
            alert('Error looking up medicine. Please try again.');
            resetScanner();
        }
    }
});
</script>
{% endif %}
{% endblock %}
