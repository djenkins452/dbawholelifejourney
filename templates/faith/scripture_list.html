{% extends "base.html" %}

{% block title %}Scripture Library - Faith - Whole Life Journey{% endblock %}

{% block content %}
<div class="container">
    <div class="page-header">
        <div>
            <h1 class="page-title">Scripture Library</h1>
            <p class="page-subtitle">Look up and save Scripture verses</p>
        </div>
    </div>
    
    <!-- Scripture Lookup Section -->
    <div class="lookup-section card mb-8">
        <h2 class="section-title">Look Up Scripture</h2>
        
        <div class="lookup-form">
            <div class="lookup-row">
                <div class="form-group">
                    <label for="bible-version" class="form-label">Translation</label>
                    <select id="bible-version" class="form-select">
                        <option value="">Loading...</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="bible-book" class="form-label">Book</label>
                    <select id="bible-book" class="form-select" disabled>
                        <option value="">Select translation first</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="bible-chapter" class="form-label">Chapter</label>
                    <select id="bible-chapter" class="form-select" disabled>
                        <option value="">Select book first</option>
                    </select>
                </div>
            </div>
            
            <div class="lookup-row">
                <div class="form-group verse-range">
                    <label class="form-label">Verses (optional)</label>
                    <div class="verse-inputs">
                        <input type="number" id="verse-start" class="form-input" placeholder="From" min="1">
                        <span class="verse-separator">to</span>
                        <input type="number" id="verse-end" class="form-input" placeholder="To" min="1">
                    </div>
                    <p class="form-help">Leave blank for entire chapter</p>
                </div>
                
                <div class="form-group lookup-button-group">
                    <button type="button" id="lookup-btn" class="btn btn-primary" disabled>
                        <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="11" cy="11" r="8"/>
                            <path d="M21 21l-4.35-4.35"/>
                        </svg>
                        Look Up
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Results -->
        <div id="lookup-results" class="lookup-results" style="display: none;">
            <div class="results-header">
                <h3 id="results-reference" class="results-reference"></h3>
                <button type="button" id="save-verse-btn" class="btn btn-secondary btn-sm">
                    <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"/>
                    </svg>
                    Save to Library
                </button>
            </div>
            <div id="results-text" class="results-text"></div>
            <p id="results-copyright" class="results-copyright text-muted text-sm"></p>
        </div>
        
        <div id="lookup-loading" class="lookup-loading" style="display: none;">
            <div class="spinner"></div>
            <p id="loading-message">Loading Scripture...</p>
        </div>
        
        <div id="lookup-error" class="lookup-error" style="display: none;">
            <p class="text-error"></p>
        </div>
    </div>
    
    <!-- Saved Verses Section -->
    <div class="saved-section">
        <div class="section-header">
            <h2 class="section-title">Saved Verses</h2>
            <div class="section-filters">
                <select id="filter-theme" class="form-select form-select-sm">
                    <option value="">All Themes</option>
                    {% for theme in available_themes %}
                    <option value="{{ theme }}" {% if selected_theme == theme %}selected{% endif %}>{{ theme }}</option>
                    {% endfor %}
                </select>
                <select id="filter-book" class="form-select form-select-sm">
                    <option value="">All Books</option>
                    {% for book in available_books %}
                    <option value="{{ book }}" {% if selected_book == book %}selected{% endif %}>{{ book }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
        
        {% if verses %}
        <div class="verse-grid">
            {% for verse in verses %}
            <div class="verse-card">
                <p class="verse-text">{{ verse.text }}</p>
                <p class="verse-reference">{{ verse.reference }}</p>
                {% if verse.themes %}
                <div class="verse-themes">
                    {% for theme in verse.themes %}
                    <span class="theme-tag">{{ theme }}</span>
                    {% endfor %}
                </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
        
        {% if page_obj.has_other_pages %}
        <nav class="pagination mt-6">
            {% if page_obj.has_previous %}
            <a href="?page={{ page_obj.previous_page_number }}" class="btn btn-ghost btn-sm">← Previous</a>
            {% endif %}
            <span class="pagination-info">Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span>
            {% if page_obj.has_next %}
            <a href="?page={{ page_obj.next_page_number }}" class="btn btn-ghost btn-sm">Next →</a>
            {% endif %}
        </nav>
        {% endif %}
        {% else %}
        <div class="empty-state-small">
            <p>No saved verses yet. Use the lookup above to find and save Scripture.</p>
        </div>
        {% endif %}
    </div>
    
    <div class="mt-8 text-center">
        <a href="{% url 'faith:home' %}" class="btn btn-ghost">← Back to Faith</a>
    </div>
</div>

<!-- Save Verse Modal -->
<div id="save-modal" class="modal" style="display: none;">
    <div class="modal-backdrop" onclick="closeSaveModal()"></div>
    <div class="modal-content">
        <div class="modal-header">
            <h3>Save Scripture</h3>
            <button type="button" class="modal-close" onclick="closeSaveModal()">&times;</button>
        </div>
        <form id="save-verse-form" method="post" action="{% url 'faith:scripture_save' %}">
            {% csrf_token %}
            <input type="hidden" name="reference" id="save-reference">
            <input type="hidden" name="text" id="save-text">
            <input type="hidden" name="book_name" id="save-book-name">
            <input type="hidden" name="chapter" id="save-chapter">
            <input type="hidden" name="verse_start" id="save-verse-start">
            <input type="hidden" name="verse_end" id="save-verse-end">
            <input type="hidden" name="translation" id="save-translation">
            
            <div class="form-group">
                <label class="form-label">Reference</label>
                <p id="modal-reference" class="modal-reference"></p>
            </div>
            
            <div class="form-group">
                <label for="save-themes" class="form-label">Themes (optional)</label>
                <input type="text" name="themes" id="save-themes" class="form-input" 
                       placeholder="e.g., faith, hope, love (comma-separated)">
                <p class="form-help">Add themes to help organize your verses</p>
            </div>
            
            <div class="form-group">
                <label for="save-notes" class="form-label">Personal Notes (optional)</label>
                <textarea name="notes" id="save-notes" class="form-textarea" rows="3"
                          placeholder="What does this verse mean to you?"></textarea>
            </div>
            
            <div class="modal-actions">
                <button type="submit" class="btn btn-primary">Save to Library</button>
                <button type="button" class="btn btn-ghost" onclick="closeSaveModal()">Cancel</button>
            </div>
        </form>
    </div>
</div>

<style>
.lookup-section {
    padding: var(--space-6);
}

.section-title {
    font-size: var(--font-size-lg);
    margin-bottom: var(--space-4);
}

.lookup-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: var(--space-4);
    margin-bottom: var(--space-4);
}

.verse-range .verse-inputs {
    display: flex;
    align-items: center;
    gap: var(--space-2);
}

.verse-range .form-input {
    width: 80px;
}

.verse-separator {
    color: var(--color-text-muted);
}

.lookup-button-group {
    display: flex;
    align-items: flex-end;
}

.lookup-results {
    margin-top: var(--space-6);
    padding-top: var(--space-6);
    border-top: 1px solid var(--color-border);
}

.results-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-4);
}

.results-reference {
    font-size: var(--font-size-xl);
    color: var(--color-accent);
    margin: 0;
}

.results-text {
    font-size: var(--font-size-lg);
    line-height: var(--line-height-relaxed);
    background: var(--color-surface);
    padding: var(--space-4);
    border-radius: var(--radius-md);
    border-left: 4px solid var(--color-accent);
}

.results-text .verse-num {
    font-weight: 600;
    color: var(--color-accent);
    font-size: var(--font-size-sm);
    vertical-align: super;
    margin-right: var(--space-1);
}

.results-copyright {
    margin-top: var(--space-3);
    font-style: italic;
}

.lookup-loading {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: var(--space-8);
    color: var(--color-text-muted);
}

.spinner {
    width: 40px;
    height: 40px;
    border: 3px solid var(--color-border);
    border-top-color: var(--color-accent);
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-bottom: var(--space-3);
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

.lookup-error {
    padding: var(--space-4);
    background: color-mix(in srgb, var(--color-error) 10%, transparent);
    border-radius: var(--radius-md);
    margin-top: var(--space-4);
}

.section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-4);
    flex-wrap: wrap;
    gap: var(--space-3);
}

.section-filters {
    display: flex;
    gap: var(--space-2);
}

.verse-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: var(--space-4);
}

.verse-card {
    background: var(--color-background);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-lg);
    padding: var(--space-4);
}

.verse-text {
    font-size: var(--font-size-base);
    line-height: var(--line-height-relaxed);
    margin-bottom: var(--space-3);
}

.verse-reference {
    font-weight: 600;
    color: var(--color-accent);
    margin-bottom: var(--space-2);
}

.verse-themes {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-1);
}

.theme-tag {
    font-size: var(--font-size-xs);
    padding: var(--space-1) var(--space-2);
    background: var(--color-surface);
    border-radius: var(--radius-sm);
    color: var(--color-text-muted);
}

.empty-state-small {
    text-align: center;
    padding: var(--space-8);
    color: var(--color-text-muted);
}

/* Modal */
.modal {
    position: fixed;
    inset: 0;
    z-index: 1000;
    display: flex;
    align-items: center;
    justify-content: center;
}

.modal-backdrop {
    position: absolute;
    inset: 0;
    background: rgba(0, 0, 0, 0.5);
}

.modal-content {
    position: relative;
    background: var(--color-background);
    border-radius: var(--radius-lg);
    padding: var(--space-6);
    max-width: 500px;
    width: 90%;
    max-height: 90vh;
    overflow-y: auto;
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-4);
}

.modal-header h3 {
    margin: 0;
}

.modal-close {
    background: none;
    border: none;
    font-size: var(--font-size-2xl);
    cursor: pointer;
    color: var(--color-text-muted);
    line-height: 1;
}

.modal-reference {
    font-weight: 600;
    color: var(--color-accent);
}

.modal-actions {
    display: flex;
    gap: var(--space-3);
    margin-top: var(--space-6);
}

.pagination {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: var(--space-4);
}

.pagination-info {
    color: var(--color-text-muted);
    font-size: var(--font-size-sm);
}
</style>

<script>
const API_KEY = '{{ api_key }}';
const API_BASE = 'https://rest.api.bible/v1';

let currentBibleId = '';
let currentBookId = '';
let currentChapterId = '';
let currentVerseData = null;
let booksData = [];

// Debug: Check if API key is present
console.log('Bible API Key present:', API_KEY ? 'Yes' : 'No (missing!)');

// Show/hide loading
function showLoading(message) {
    document.getElementById('loading-message').textContent = message || 'Loading...';
    document.getElementById('lookup-loading').style.display = 'flex';
}

function hideLoading() {
    document.getElementById('lookup-loading').style.display = 'none';
}

function showError(message) {
    const errorDiv = document.getElementById('lookup-error');
    errorDiv.querySelector('p').textContent = message;
    errorDiv.style.display = 'block';
}

function hideError() {
    document.getElementById('lookup-error').style.display = 'none';
}

// Fetch available Bibles
async function fetchBibles() {
    const versionSelect = document.getElementById('bible-version');
    
    if (!API_KEY) {
        versionSelect.innerHTML = '<option value="">API Key not configured</option>';
        showError('Bible API key is not configured. Please add BIBLE_API_KEY to your settings.');
        return;
    }
    
    try {
        console.log('Fetching Bibles...');
        const response = await fetch(`${API_BASE}/bibles?language=eng`, {
            headers: { 'api-key': API_KEY }
        });
        
        if (!response.ok) {
            throw new Error(`API returned ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        console.log('Bibles loaded:', data.data?.length || 0);
        
        versionSelect.innerHTML = '<option value="">Select Translation</option>';
        
        const bibles = data.data || [];
        
        // Sort by name
        bibles.sort((a, b) => a.name.localeCompare(b.name));
        
        bibles.forEach(bible => {
            const option = document.createElement('option');
            option.value = bible.id;
            option.textContent = `${bible.abbreviation} - ${bible.name}`;
            versionSelect.appendChild(option);
        });
        
        versionSelect.disabled = false;
    } catch (error) {
        console.error('Error fetching Bibles:', error);
        versionSelect.innerHTML = '<option value="">Error loading translations</option>';
        showError('Could not load Bible translations. Check console for details. Error: ' + error.message);
    }
}

// Fetch books for selected Bible
async function fetchBooks(bibleId) {
    currentBibleId = bibleId;
    const bookSelect = document.getElementById('bible-book');
    const chapterSelect = document.getElementById('bible-chapter');
    
    bookSelect.innerHTML = '<option value="">Loading books...</option>';
    bookSelect.disabled = true;
    chapterSelect.innerHTML = '<option value="">Select book first</option>';
    chapterSelect.disabled = true;
    document.getElementById('lookup-btn').disabled = true;
    
    try {
        const response = await fetch(`${API_BASE}/bibles/${bibleId}/books`, {
            headers: { 'api-key': API_KEY }
        });
        
        if (!response.ok) {
            throw new Error(`API returned ${response.status}`);
        }
        
        const data = await response.json();
        booksData = data.data || [];
        
        bookSelect.innerHTML = '<option value="">Select Book</option>';
        booksData.forEach(book => {
            const option = document.createElement('option');
            option.value = book.id;
            option.textContent = book.name;
            bookSelect.appendChild(option);
        });
        
        bookSelect.disabled = false;
    } catch (error) {
        console.error('Error fetching books:', error);
        bookSelect.innerHTML = '<option value="">Error loading books</option>';
        showError('Could not load books. Error: ' + error.message);
    }
}

// Fetch chapters for selected book
async function fetchChapters(bookId) {
    currentBookId = bookId;
    const chapterSelect = document.getElementById('bible-chapter');
    
    chapterSelect.innerHTML = '<option value="">Loading chapters...</option>';
    chapterSelect.disabled = true;
    document.getElementById('lookup-btn').disabled = true;
    
    try {
        const response = await fetch(`${API_BASE}/bibles/${currentBibleId}/books/${bookId}/chapters`, {
            headers: { 'api-key': API_KEY }
        });
        
        if (!response.ok) {
            throw new Error(`API returned ${response.status}`);
        }
        
        const data = await response.json();
        const chapters = data.data || [];
        
        chapterSelect.innerHTML = '<option value="">Select Chapter</option>';
        chapters.forEach(chapter => {
            // Skip intro chapters
            if (chapter.number && chapter.number !== 'intro') {
                const option = document.createElement('option');
                option.value = chapter.id;
                option.textContent = `Chapter ${chapter.number}`;
                chapterSelect.appendChild(option);
            }
        });
        
        chapterSelect.disabled = false;
    } catch (error) {
        console.error('Error fetching chapters:', error);
        chapterSelect.innerHTML = '<option value="">Error loading chapters</option>';
        showError('Could not load chapters. Error: ' + error.message);
    }
}

// Look up Scripture
async function lookupScripture() {
    const chapterId = document.getElementById('bible-chapter').value;
    const verseStart = document.getElementById('verse-start').value;
    const verseEnd = document.getElementById('verse-end').value;
    
    if (!chapterId) {
        alert('Please select a chapter');
        return;
    }
    
    currentChapterId = chapterId;
    
    // Show loading
    document.getElementById('lookup-results').style.display = 'none';
    hideError();
    showLoading('Loading Scripture...');
    
    try {
        let endpoint;
        let passageId;
        
        if (verseStart) {
            // Specific verse(s)
            const bookChapter = chapterId; // e.g., "GEN.1"
            if (verseEnd && verseEnd !== verseStart) {
                passageId = `${bookChapter}.${verseStart}-${bookChapter}.${verseEnd}`;
            } else {
                passageId = `${bookChapter}.${verseStart}`;
            }
            endpoint = `${API_BASE}/bibles/${currentBibleId}/passages/${passageId}?content-type=text&include-notes=false&include-titles=false&include-chapter-numbers=false&include-verse-numbers=true`;
        } else {
            // Whole chapter
            endpoint = `${API_BASE}/bibles/${currentBibleId}/chapters/${chapterId}?content-type=text&include-notes=false&include-titles=false&include-chapter-numbers=false&include-verse-numbers=true`;
        }
        
        console.log('Fetching:', endpoint);
        
        const response = await fetch(endpoint, {
            headers: { 'api-key': API_KEY }
        });
        
        if (!response.ok) {
            throw new Error(`API returned ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.data) {
            displayResults(data.data);
        } else {
            throw new Error('No data returned');
        }
    } catch (error) {
        console.error('Error looking up Scripture:', error);
        hideLoading();
        showError('Error loading Scripture. Please try again. Error: ' + error.message);
    }
}

// Display results
function displayResults(data) {
    hideLoading();
    document.getElementById('lookup-results').style.display = 'block';
    
    const reference = data.reference || data.id;
    document.getElementById('results-reference').textContent = reference;
    
    // Format the text with verse numbers
    let text = data.content || '';
    // Clean up whitespace
    text = text.replace(/\s+/g, ' ').trim();
    // Style verse numbers
    text = text.replace(/\[(\d+)\]/g, '<span class="verse-num">$1</span>');
    
    document.getElementById('results-text').innerHTML = text;
    document.getElementById('results-copyright').textContent = data.copyright || '';
    
    // Store for saving
    const bookName = document.getElementById('bible-book').options[document.getElementById('bible-book').selectedIndex].text;
    const chapterNum = document.getElementById('bible-chapter').options[document.getElementById('bible-chapter').selectedIndex].text.replace('Chapter ', '');
    const translation = document.getElementById('bible-version').options[document.getElementById('bible-version').selectedIndex].text;
    
    currentVerseData = {
        reference: reference,
        text: text.replace(/<[^>]*>/g, ''), // Strip HTML for saving
        bookName: bookName,
        chapter: chapterNum,
        verseStart: document.getElementById('verse-start').value || '1',
        verseEnd: document.getElementById('verse-end').value || '',
        translation: translation
    };
}

// Save modal functions
function openSaveModal() {
    if (!currentVerseData) return;
    
    document.getElementById('modal-reference').textContent = currentVerseData.reference;
    document.getElementById('save-reference').value = currentVerseData.reference;
    document.getElementById('save-text').value = currentVerseData.text;
    document.getElementById('save-book-name').value = currentVerseData.bookName;
    document.getElementById('save-chapter').value = currentVerseData.chapter;
    document.getElementById('save-verse-start').value = currentVerseData.verseStart;
    document.getElementById('save-verse-end').value = currentVerseData.verseEnd;
    document.getElementById('save-translation').value = currentVerseData.translation;
    
    document.getElementById('save-modal').style.display = 'flex';
}

function closeSaveModal() {
    document.getElementById('save-modal').style.display = 'none';
}

// Event listeners
document.addEventListener('DOMContentLoaded', function() {
    // Start by fetching Bibles
    fetchBibles();
    
    document.getElementById('bible-version').addEventListener('change', function() {
        if (this.value) {
            fetchBooks(this.value);
        } else {
            document.getElementById('bible-book').innerHTML = '<option value="">Select translation first</option>';
            document.getElementById('bible-book').disabled = true;
            document.getElementById('bible-chapter').innerHTML = '<option value="">Select book first</option>';
            document.getElementById('bible-chapter').disabled = true;
        }
    });
    
    document.getElementById('bible-book').addEventListener('change', function() {
        if (this.value) {
            fetchChapters(this.value);
        } else {
            document.getElementById('bible-chapter').innerHTML = '<option value="">Select book first</option>';
            document.getElementById('bible-chapter').disabled = true;
        }
    });
    
    document.getElementById('bible-chapter').addEventListener('change', function() {
        document.getElementById('lookup-btn').disabled = !this.value;
    });
    
    document.getElementById('lookup-btn').addEventListener('click', lookupScripture);
    
    document.getElementById('save-verse-btn').addEventListener('click', openSaveModal);
    
    // Filter handlers
    document.getElementById('filter-theme')?.addEventListener('change', function() {
        const url = new URL(window.location);
        if (this.value) {
            url.searchParams.set('theme', this.value);
        } else {
            url.searchParams.delete('theme');
        }
        window.location = url;
    });
    
    document.getElementById('filter-book')?.addEventListener('change', function() {
        const url = new URL(window.location);
        if (this.value) {
            url.searchParams.set('book', this.value);
        } else {
            url.searchParams.delete('book');
        }
        window.location = url;
    });
    
    // Close modal on escape
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            closeSaveModal();
        }
    });
});
</script>
{% endblock %}