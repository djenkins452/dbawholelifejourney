{% extends "base.html" %}
{% load static %}
{% load tz %}

{% block title %}Medicine History - Whole Life Journey{% endblock %}

{% block content %}
<div class="container">
    <nav class="breadcrumb mb-4">
        <a href="{% url 'health:home' %}">Health</a>
        <span>/</span>
        <a href="{% url 'health:medicine_home' %}">Medicines</a>
        <span>/</span>
        <span>History</span>
    </nav>

    <div class="page-header">
        <h1 class="page-title">Medicine History</h1>
    </div>

    <!-- Filters -->
    <form method="get" class="filters-form mb-6">
        <div class="filter-row">
            <div class="filter-group">
                <label for="medicine">Medicine</label>
                <select name="medicine" id="medicine" class="form-select">
                    <option value="">All Medicines</option>
                    {% for medicine in medicines %}
                    <option value="{{ medicine.pk }}" {% if selected_medicine == medicine.pk|stringformat:"s" %}selected{% endif %}>
                        {{ medicine.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="filter-group">
                <label for="start">Start Date</label>
                <input type="date" name="start" id="start" value="{{ request.GET.start }}" class="form-input">
            </div>
            <div class="filter-group">
                <label for="end">End Date</label>
                <input type="date" name="end" id="end" value="{{ request.GET.end }}" class="form-input">
            </div>
            <div class="filter-actions">
                <button type="submit" class="btn btn-primary btn-sm">Filter</button>
                <a href="{% url 'health:medicine_history' %}" class="btn btn-secondary btn-sm">Clear</a>
            </div>
        </div>
    </form>

    {% if logs %}
    <div class="history-list">
        {% regroup logs by scheduled_date as logs_by_date %}
        {% for date_group in logs_by_date %}
        <div class="date-group">
            <h2 class="date-header">{{ date_group.grouper|date:"l, F j, Y" }}</h2>
            <div class="log-items">
                {% for log in date_group.list %}
                <div class="log-item log-{{ log.log_status }}">
                    <div class="log-medicine">
                        <a href="{% url 'health:medicine_detail' pk=log.medicine.pk %}">{{ log.medicine.name }}</a>
                        <span class="log-dose">{{ log.medicine.dose }}</span>
                    </div>
                    <div class="log-time">
                        {% if log.scheduled_time %}
                        {{ log.scheduled_time|time:"g:i A" }}
                        {% elif log.is_prn_dose %}
                        PRN
                        {% endif %}
                    </div>
                    <div class="log-status-badge">
                        {{ log.get_log_status_display }}
                    </div>
                    {% if log.taken_at %}
                    <div class="log-taken">
                        Taken at {% timezone user_timezone %}{{ log.taken_at|time:"g:i A" }}{% endtimezone %}
                    </div>
                    {% endif %}
                    {% if log.prn_reason %}
                    <div class="log-reason">{{ log.prn_reason }}</div>
                    {% endif %}
                    {% if log.notes %}
                    <div class="log-notes">{{ log.notes }}</div>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        </div>
        {% endfor %}
    </div>

    {% if page_obj.has_other_pages %}
    <nav class="pagination mt-6">
        {% if page_obj.has_previous %}
        <a href="?page={{ page_obj.previous_page_number }}{% if selected_medicine %}&medicine={{ selected_medicine }}{% endif %}{% if request.GET.start %}&start={{ request.GET.start }}{% endif %}{% if request.GET.end %}&end={{ request.GET.end }}{% endif %}" class="btn btn-secondary btn-sm">Previous</a>
        {% endif %}
        <span class="page-info">Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span>
        {% if page_obj.has_next %}
        <a href="?page={{ page_obj.next_page_number }}{% if selected_medicine %}&medicine={{ selected_medicine }}{% endif %}{% if request.GET.start %}&start={{ request.GET.start }}{% endif %}{% if request.GET.end %}&end={{ request.GET.end }}{% endif %}" class="btn btn-secondary btn-sm">Next</a>
        {% endif %}
    </nav>
    {% endif %}

    {% else %}
    <div class="empty-state">
        <p class="text-muted">No medicine logs found{% if selected_medicine or request.GET.start or request.GET.end %} matching your filters{% endif %}.</p>
    </div>
    {% endif %}
</div>

<style>
.filters-form {
    padding: var(--space-4);
    background: var(--color-surface);
    border-radius: var(--radius-lg);
}

.filter-row {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-4);
    align-items: flex-end;
}

.filter-group {
    display: flex;
    flex-direction: column;
    gap: var(--space-1);
}

.filter-group label {
    font-size: var(--font-size-sm);
    font-weight: 500;
}

.filter-actions {
    display: flex;
    gap: var(--space-2);
}

.history-list {
    display: flex;
    flex-direction: column;
    gap: var(--space-6);
}

.date-group {
    background: var(--color-background);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-lg);
    overflow: hidden;
}

.date-header {
    padding: var(--space-3) var(--space-4);
    background: var(--color-surface);
    font-size: var(--font-size-base);
    font-weight: 600;
    border-bottom: 1px solid var(--color-border);
}

.log-items {
    padding: var(--space-2);
}

.log-item {
    display: grid;
    grid-template-columns: 1fr auto auto auto;
    gap: var(--space-3);
    align-items: center;
    padding: var(--space-3);
    border-radius: var(--radius-md);
    margin-bottom: var(--space-1);
}

.log-item:last-child {
    margin-bottom: 0;
}

.log-item.log-taken {
    background: color-mix(in srgb, var(--color-success, #10b981) 8%, transparent);
}

.log-item.log-late {
    background: color-mix(in srgb, var(--color-warning, #f59e0b) 8%, transparent);
}

.log-item.log-missed {
    background: color-mix(in srgb, var(--color-error, #ef4444) 8%, transparent);
}

.log-item.log-skipped {
    background: var(--color-surface);
}

.log-medicine {
    display: flex;
    flex-direction: column;
    gap: var(--space-1);
}

.log-medicine a {
    font-weight: 500;
}

.log-dose {
    font-size: var(--font-size-sm);
    color: var(--color-text-muted);
}

.log-time {
    font-size: var(--font-size-sm);
    color: var(--color-text-muted);
}

.log-status-badge {
    padding: var(--space-1) var(--space-2);
    border-radius: var(--radius-sm);
    font-size: var(--font-size-sm);
    font-weight: 500;
}

.log-taken .log-status-badge {
    color: var(--color-success, #10b981);
}

.log-late .log-status-badge {
    color: var(--color-warning, #f59e0b);
}

.log-missed .log-status-badge {
    color: var(--color-error, #ef4444);
}

.log-skipped .log-status-badge {
    color: var(--color-text-muted);
}

.log-taken-info {
    font-size: var(--font-size-sm);
    color: var(--color-text-muted);
}

.log-reason,
.log-notes {
    grid-column: 1 / -1;
    font-size: var(--font-size-sm);
    color: var(--color-text-muted);
    padding-top: var(--space-2);
    border-top: 1px solid var(--color-border);
}

.pagination {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: var(--space-4);
}

.page-info {
    font-size: var(--font-size-sm);
    color: var(--color-text-muted);
}

@media (max-width: 640px) {
    .filter-row {
        flex-direction: column;
        align-items: stretch;
    }

    .log-item {
        grid-template-columns: 1fr;
        gap: var(--space-2);
    }
}
</style>
{% endblock %}
