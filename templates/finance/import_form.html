{% extends "base.html" %}

{% block title %}Import Transactions - Finance - Whole Life Journey{% endblock %}

{% block content %}
<div class="container container-sm">
    <div class="page-header">
        <h1 class="page-title">Import Transactions</h1>
        <p class="page-subtitle">Upload a file exported from your bank to import transactions</p>
    </div>

    <form method="post" enctype="multipart/form-data" class="form-card">
        {% csrf_token %}

        <div class="form-group">
            <label for="id_account">Target Account</label>
            {{ form.account }}
            <p class="form-help">{{ form.account.help_text }}</p>
        </div>

        <div class="form-group">
            <label for="id_file">Transaction File</label>
            <div class="file-upload-zone" id="dropzone">
                {{ form.file }}
                <div class="file-upload-info">
                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                        <polyline points="17,8 12,3 7,8"></polyline>
                        <line x1="12" y1="3" x2="12" y2="15"></line>
                    </svg>
                    <span>Drop file here or click to browse</span>
                    <span class="file-formats">Supported: CSV, OFX, QFX, QIF</span>
                </div>
            </div>
            {% if form.file.errors %}
            <p class="form-error">{{ form.file.errors.0 }}</p>
            {% endif %}
        </div>

        <div class="form-group">
            <label for="id_notes">Notes (Optional)</label>
            {{ form.notes }}
        </div>

        <div class="import-tips">
            <h3>Tips for Successful Import</h3>
            <ul>
                <li>Export transactions from your bank's website as CSV, OFX, or QFX</li>
                <li>Most banks offer a "Download" or "Export" option in the transactions section</li>
                <li>Duplicate transactions will be automatically skipped</li>
                <li>You can review and edit transactions after import</li>
            </ul>
        </div>

        <div class="form-actions">
            <button type="submit" class="btn btn-primary">
                <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                    <polyline points="17,8 12,3 7,8"></polyline>
                    <line x1="12" y1="3" x2="12" y2="15"></line>
                </svg>
                Import Transactions
            </button>
            <a href="{% url 'finance:transaction_list' %}" class="btn btn-secondary">Cancel</a>
        </div>
    </form>

    {% if recent_imports %}
    <div class="recent-imports">
        <h2>Recent Imports</h2>
        <div class="import-history-list">
            {% for import in recent_imports %}
            <a href="{% url 'finance:import_detail' import.pk %}" class="import-item">
                <div class="import-info">
                    <span class="import-filename">{{ import.original_filename }}</span>
                    <span class="import-meta">
                        {{ import.account.name }} &bull; {{ import.created_at|date:"M j, Y g:i A" }}
                    </span>
                </div>
                <div class="import-status status-{{ import.import_status }}">
                    {{ import.get_import_status_display }}
                </div>
            </a>
            {% endfor %}
        </div>
        <a href="{% url 'finance:import_list' %}" class="view-all-link">View all imports &rarr;</a>
    </div>
    {% endif %}
</div>

<style>
.container-sm { max-width: 600px; }

.page-subtitle {
    color: var(--color-text-secondary);
    margin-top: var(--space-2);
}

.form-card {
    background: var(--color-background);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-lg);
    padding: var(--space-6);
    margin-bottom: var(--space-6);
}

.form-group {
    margin-bottom: var(--space-4);
}

.form-group > label {
    display: block;
    margin-bottom: var(--space-2);
    font-weight: 500;
}

.form-help {
    font-size: 0.875rem;
    color: var(--color-text-secondary);
    margin-top: var(--space-1);
}

.form-error {
    color: var(--color-error);
    font-size: 0.875rem;
    margin-top: var(--space-1);
}

.file-upload-zone {
    position: relative;
    border: 2px dashed var(--color-border);
    border-radius: var(--radius-md);
    padding: var(--space-8);
    text-align: center;
    cursor: pointer;
    transition: all 0.2s ease;
}

.file-upload-zone:hover,
.file-upload-zone.dragover {
    border-color: var(--color-accent);
    background: color-mix(in srgb, var(--color-accent) 5%, transparent);
}

.file-upload-zone.has-file {
    border-color: var(--color-success);
    border-style: solid;
    background: color-mix(in srgb, var(--color-success) 5%, transparent);
}

.file-upload-zone.has-file .file-upload-info .icon {
    color: var(--color-success);
}

.file-upload-zone input[type="file"] {
    position: absolute;
    inset: 0;
    opacity: 0;
    cursor: pointer;
}

.file-upload-info {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: var(--space-2);
    color: var(--color-text-secondary);
}

.file-upload-info .icon {
    width: 48px;
    height: 48px;
    color: var(--color-accent);
}

.file-formats {
    font-size: 0.75rem;
}

.import-tips {
    background: color-mix(in srgb, var(--color-accent) 10%, transparent);
    border-radius: var(--radius-md);
    padding: var(--space-4);
    margin-bottom: var(--space-4);
}

.import-tips h3 {
    font-size: 0.875rem;
    margin-bottom: var(--space-2);
}

.import-tips ul {
    margin: 0;
    padding-left: var(--space-4);
    font-size: 0.875rem;
    color: var(--color-text-secondary);
}

.import-tips li {
    margin-bottom: var(--space-1);
}

.form-actions {
    display: flex;
    gap: var(--space-3);
    margin-top: var(--space-6);
    padding-top: var(--space-4);
    border-top: 1px solid var(--color-border);
}

.btn .icon {
    width: 18px;
    height: 18px;
    margin-right: var(--space-2);
}

.recent-imports h2 {
    font-size: 1.125rem;
    margin-bottom: var(--space-4);
}

.import-history-list {
    display: flex;
    flex-direction: column;
    gap: var(--space-2);
    margin-bottom: var(--space-3);
}

.import-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--space-3);
    background: var(--color-surface);
    border-radius: var(--radius-md);
    text-decoration: none;
    color: inherit;
    transition: background 0.2s ease;
}

.import-item:hover {
    background: var(--color-background);
}

.import-info {
    display: flex;
    flex-direction: column;
    gap: var(--space-1);
}

.import-filename {
    font-weight: 500;
}

.import-meta {
    font-size: 0.75rem;
    color: var(--color-text-secondary);
}

.import-status {
    font-size: 0.75rem;
    font-weight: 500;
    padding: var(--space-1) var(--space-2);
    border-radius: var(--radius-sm);
}

.status-completed {
    background: color-mix(in srgb, var(--color-success) 20%, transparent);
    color: var(--color-success);
}

.status-failed {
    background: color-mix(in srgb, var(--color-error) 20%, transparent);
    color: var(--color-error);
}

.status-partial {
    background: color-mix(in srgb, var(--color-warning) 20%, transparent);
    color: var(--color-warning);
}

.status-processing, .status-pending {
    background: color-mix(in srgb, var(--color-accent) 20%, transparent);
    color: var(--color-accent);
}

.view-all-link {
    font-size: 0.875rem;
    color: var(--color-accent);
}
</style>

<script>
// Drag and drop functionality
const dropzone = document.getElementById('dropzone');
const fileInput = dropzone.querySelector('input[type="file"]');

// Prevent default drag behaviors on document to avoid browser opening the file
['dragenter', 'dragover', 'dragleave', 'drop'].forEach(event => {
    document.addEventListener(event, (e) => {
        e.preventDefault();
        e.stopPropagation();
    });
});

// Highlight dropzone on dragenter/dragover
['dragenter', 'dragover'].forEach(event => {
    dropzone.addEventListener(event, (e) => {
        e.preventDefault();
        e.stopPropagation();
        dropzone.classList.add('dragover');
    });
});

// Remove highlight on dragleave
dropzone.addEventListener('dragleave', (e) => {
    e.preventDefault();
    e.stopPropagation();
    dropzone.classList.remove('dragover');
});

// Handle the actual drop - assign files to input
dropzone.addEventListener('drop', (e) => {
    e.preventDefault();
    e.stopPropagation();
    dropzone.classList.remove('dragover');

    const files = e.dataTransfer.files;
    if (files.length > 0) {
        // Assign dropped files to the file input
        fileInput.files = files;
        // Update the display text
        updateFileDisplay(files[0].name);
    }
});

// Update display when file is selected via click
fileInput.addEventListener('change', (e) => {
    if (e.target.files.length > 0) {
        updateFileDisplay(e.target.files[0].name);
    }
});

// Helper function to update the file name display
function updateFileDisplay(filename) {
    const info = dropzone.querySelector('.file-upload-info span');
    info.textContent = filename;
    // Add a visual indicator that a file is selected
    dropzone.classList.add('has-file');
}
</script>
{% endblock %}
