{% extends "base.html" %}
{% load static %}
{% load safe_urls %}

{% block title %}Preferences - Whole Life Journey{% endblock %}

{% block content %}
<div class="content-container">
    <nav class="breadcrumb mb-4">
        <a href="{% url 'users:preferences' %}">Settings</a>
        <span>/</span>
        <span>Preferences</span>
    </nav>

    <div class="page-header">
        <div>
            <h1 class="page-title">Preferences</h1>
            <p class="page-subtitle">Customize your Whole Life Journey experience</p>
        </div>
        <button type="submit" form="preferences-form" class="btn btn-primary">Save Changes</button>
    </div>
    
    <form method="post" id="preferences-form">
        {% csrf_token %}
        
        <!-- Theme Section -->
        <div class="card mb-6">
            <h2 class="card-title">Appearance</h2>
            <p class="text-muted mb-4">Choose a visual theme that resonates with you.</p>
            
            <div class="form-group">
                <label for="id_theme" class="form-label">Theme</label>
                <select name="theme" id="id_theme" class="form-select">
                    {% for value, label in form.fields.theme.choices %}
                        <option value="{{ value }}" {% if form.theme.value == value %}selected{% endif %}>
                            {{ label }}
                        </option>
                    {% endfor %}
                </select>
                <p class="form-help">Each theme shapes the visual feel of your experience.</p>
            </div>
            
            <div class="form-group">
                <label for="id_accent_color" class="form-label">Custom Accent Color (Optional)</label>
                <div class="color-input-wrapper">
                    <input 
                        type="color" 
                        name="accent_color" 
                        id="id_accent_color" 
                        class="form-color"
                        value="{{ form.accent_color.value|default:'#6366f1' }}"
                    >
                    <input 
                        type="text" 
                        id="accent_color_text"
                        class="form-input form-color-text"
                        value="{{ form.accent_color.value|default:'' }}"
                        placeholder="Leave blank for theme default"
                        readonly
                    >
                    <button type="button" class="btn btn-ghost btn-sm" onclick="clearAccentColor()">Clear</button>
                </div>
                <p class="form-help">Override the theme's accent color with your own choice.</p>
            </div>
            
            <div class="text-right">
                <a href="{% url 'users:theme_selection' %}" class="btn btn-secondary btn-sm">
                    Preview All Themes ‚Üí
                </a>
            </div>
        </div>
        
        <!-- Modules Section -->
        <div class="card mb-6">
            <h2 class="card-title">Modules</h2>
            <p class="text-muted mb-4">Enable or disable life areas you want to track.</p>
            
            <!-- Active Modules -->
            <div class="module-section">
                <h3 class="module-section-title">Active Modules</h3>
                
                <div class="toggle-option">
                    <div class="toggle-info">
                        <div class="module-header">
                            <span class="module-icon">üìù</span>
                            <h4>Journal</h4>
                            <span class="module-status status-active">Active</span>
                        </div>
                        <p class="text-muted text-sm">
                            Daily reflections, guided prompts, mood tracking, and personal entries.
                        </p>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" name="journal_enabled" {% if form.journal_enabled.value %}checked{% endif %}>
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                
                <div class="toggle-option">
                    <div class="toggle-info">
                        <div class="module-header">
                            <span class="module-icon">‚úùÔ∏è</span>
                            <h4>Faith</h4>
                            <span class="module-status status-active">Active</span>
                        </div>
                        <p class="text-muted text-sm">
                            Scripture reading, prayer requests, faith milestones, and Christian encouragement throughout the app.
                        </p>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" name="faith_enabled" {% if form.faith_enabled.value %}checked{% endif %}>
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                
                <div class="toggle-option">
                    <div class="toggle-info">
                        <div class="module-header">
                            <span class="module-icon">‚ù§Ô∏è</span>
                            <h4>Health</h4>
                            <span class="module-status status-active">Active</span>
                        </div>
                        <p class="text-muted text-sm">
                            Track weight, fasting windows, heart rate, blood glucose, and view health trends over time.
                        </p>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" name="health_enabled" {% if form.health_enabled.value %}checked{% endif %}>
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                
                <div class="toggle-option">
                    <div class="toggle-info">
                        <div class="module-header">
                            <span class="module-icon">üè†</span>
                            <h4>Life</h4>
                            <span class="module-status status-active">Active</span>
                        </div>
                        <p class="text-muted text-sm">
                            Projects, tasks, calendar, inventory, pets, recipes, maintenance logs, and document storage.
                        </p>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" name="life_enabled" {% if form.life_enabled.value %}checked{% endif %}>
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                
                <div class="toggle-option">
                    <div class="toggle-info">
                        <div class="module-header">
                            <span class="module-icon">üß≠</span>
                            <h4>Purpose</h4>
                            <span class="module-status status-active">Active</span>
                        </div>
                        <p class="text-muted text-sm">
                            Annual direction, Word of the Year, life goals, change intentions, and seasonal reflections.
                        </p>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" name="purpose_enabled" {% if form.purpose_enabled.value %}checked{% endif %}>
                        <span class="toggle-slider"></span>
                    </label>
                </div>
            </div>
            
            <!-- Coming Soon Modules -->
            <div class="module-section mt-6">
                <h3 class="module-section-title">Coming Soon</h3>
                <p class="text-muted text-sm mb-4">These modules are in development. You'll be notified when they launch.</p>

                <div class="toggle-option disabled">
                    <div class="toggle-info">
                        <div class="module-header">
                            <span class="module-icon">üí∞</span>
                            <h4>Finances</h4>
                            <span class="module-status status-coming">Coming Soon</span>
                        </div>
                        <p class="text-muted text-sm">
                            Budget tracking, expense categories, savings goals, and financial insights.
                        </p>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" name="finances_enabled" disabled>
                        <span class="toggle-slider"></span>
                    </label>
                </div>

                <div class="toggle-option disabled">
                    <div class="toggle-info">
                        <div class="module-header">
                            <span class="module-icon">üë•</span>
                            <h4>Relationships</h4>
                            <span class="module-status status-coming">Coming Soon</span>
                        </div>
                        <p class="text-muted text-sm">
                            Track meaningful connections, remember important dates, and nurture relationships.
                        </p>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" name="relationships_enabled" disabled>
                        <span class="toggle-slider"></span>
                    </label>
                </div>

                <div class="toggle-option disabled">
                    <div class="toggle-info">
                        <div class="module-header">
                            <span class="module-icon">üîÑ</span>
                            <h4>Habits</h4>
                            <span class="module-status status-coming">Coming Soon</span>
                        </div>
                        <p class="text-muted text-sm">
                            Build positive habits with streaks, reminders, and progress tracking.
                        </p>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" name="habits_enabled" disabled>
                        <span class="toggle-slider"></span>
                    </label>
                </div>
            </div>
        </div>
        
        <!-- AI Features Section -->
        <div class="card mb-6">
            <h2 class="card-title">AI Features</h2>
            <p class="text-muted mb-4">AI-powered insights and encouragement for your journey.</p>

            <div class="toggle-option">
                <div class="toggle-info">
                    <div class="module-header">
                        <span class="module-icon">ü§ñ</span>
                        <h4>AI Insights</h4>
                        {% if form.ai_enabled.value %}<span class="module-status status-active">Active</span>{% endif %}
                    </div>
                    <p class="text-muted text-sm">
                        AI-powered pattern recognition, personalized encouragement, and reflective prompts based on your journey.
                        AI provides thoughts to consider ‚Äî never medical, financial, or spiritual advice.
                    </p>
                </div>
                <label class="toggle-switch">
                    <input type="checkbox" name="ai_enabled" id="ai_enabled_toggle" {% if form.ai_enabled.value %}checked{% endif %}>
                    <span class="toggle-slider"></span>
                </label>
            </div>

            <div class="toggle-option" id="ai-data-consent-option" {% if not form.ai_enabled.value %}style="display: none;"{% endif %}>
                <div class="toggle-info">
                    <div class="module-header">
                        <span class="module-icon">üîí</span>
                        <h4>AI Data Processing Consent</h4>
                        {% if form.ai_data_consent.value %}<span class="module-status status-active">Granted</span>{% endif %}
                    </div>
                    <p class="text-muted text-sm">
                        <strong>Required for AI features.</strong> I consent to having my personal data (journal entries, health metrics, goals, etc.)
                        processed by AI to provide personalized insights. Data is sent to OpenAI's API for analysis.
                        Images from camera scanning are processed in real-time and <strong>never stored</strong>.
                    </p>
                </div>
                <label class="toggle-switch">
                    <input type="checkbox" name="ai_data_consent" id="ai_data_consent_toggle" {% if form.ai_data_consent.value %}checked{% endif %}>
                    <span class="toggle-slider"></span>
                </label>
            </div>
            
            <!-- AI Coaching Style (shown when AI is enabled) -->
            <div id="ai-coaching-section" class="ai-coaching-section {% if not form.ai_enabled.value %}hidden{% endif %}">
                <h3 class="module-section-title mt-6">AI Coaching Style</h3>
                <p class="text-muted text-sm mb-4">
                    Choose how you'd like the AI to communicate with you. This affects the tone of insights, encouragements, and accountability nudges.
                </p>
                
                <div class="coaching-style-options">
                    {% for style in coaching_styles %}
                    <label class="coaching-style-card {% if form.ai_coaching_style.value == style.key or not form.ai_coaching_style.value and style.is_default %}selected{% endif %}">
                        <input type="radio" name="ai_coaching_style" value="{{ style.key }}"
                               {% if form.ai_coaching_style.value == style.key or not form.ai_coaching_style.value and style.is_default %}checked{% endif %}>
                        <div class="card-content">
                            <div class="card-icon">{{ style.icon }}</div>
                            <div class="card-text">
                                <div class="card-title">{{ style.name }}</div>
                                <div class="card-description">{{ style.description }}</div>
                            </div>
                        </div>
                    </label>
                    {% empty %}
                    <!-- Fallback if no styles in database -->
                    <label class="coaching-style-card selected">
                        <input type="radio" name="ai_coaching_style" value="supportive" checked>
                        <div class="card-content">
                            <div class="card-icon">ü§ù</div>
                            <div class="card-text">
                                <div class="card-title">Supportive Partner</div>
                                <div class="card-description">Balanced warmth with gentle accountability.</div>
                            </div>
                        </div>
                    </label>
                    {% endfor %}
                </div>
            </div>

            <!-- AI Personal Profile (shown when AI is enabled and consent given) -->
            <div id="ai-profile-section" class="ai-profile-section {% if not form.ai_enabled.value or not form.ai_data_consent.value %}hidden{% endif %}">
                <h3 class="module-section-title mt-6">Personal AI Profile</h3>
                <p class="text-muted text-sm mb-4">
                    Help the AI understand you better by sharing relevant details about yourself.
                    This information personalizes insights, encouragement, and suggestions.
                    <strong>Only share what you're comfortable with.</strong>
                </p>

                <div class="form-group">
                    <label for="id_ai_profile" class="form-label">About You</label>
                    <textarea
                        name="ai_profile"
                        id="id_ai_profile"
                        class="form-textarea"
                        rows="6"
                        maxlength="2000"
                        placeholder="Tell the AI about yourself to personalize your experience...

Examples:
‚Ä¢ Age and life stage (e.g., 'I'm in my 40s with two teenagers')
‚Ä¢ Family situation (e.g., 'married, work-from-home parent')
‚Ä¢ Health focus (e.g., 'managing blood pressure, trying to lose 20lbs')
‚Ä¢ Faith journey (e.g., 'growing Christian seeking deeper prayer life')
‚Ä¢ Interests (e.g., 'love hiking, cooking, woodworking')
‚Ä¢ Work/career (e.g., 'software developer, often stressed about deadlines')"
                    >{{ form.ai_profile.value|default:'' }}</textarea>
                    <div class="form-help-row">
                        <p class="form-help">This information is used only to personalize AI responses. It is never shared externally.</p>
                        <span class="char-counter" id="ai-profile-counter">
                            <span id="ai-profile-length">{{ form.ai_profile.value|length|default:0 }}</span>/2000
                        </span>
                    </div>
                </div>

                <div class="ai-profile-tips">
                    <h4 class="tips-title">Tips for a great profile:</h4>
                    <ul class="tips-list">
                        <li>Be specific about your current life situation and goals</li>
                        <li>Mention health conditions relevant to your wellness journey</li>
                        <li>Share your communication preferences (e.g., "I respond well to direct feedback")</li>
                        <li>Include what motivates you and what you're working on</li>
                    </ul>
                </div>
            </div>

            <!-- Personal Assistant Section (shown when AI is enabled and consent given) -->
            <div id="personal-assistant-section" class="personal-assistant-section {% if not form.ai_enabled.value or not form.ai_data_consent.value %}hidden{% endif %}">
                <h3 class="module-section-title mt-6">Personal Assistant</h3>
                <p class="text-muted text-sm mb-4">
                    Your AI-powered daily coach that helps you live the life you said you want to live.
                    Generates daily priorities, celebrates wins, and provides gentle accountability.
                </p>

                <div class="toggle-option">
                    <div class="toggle-info">
                        <div class="module-header">
                            <span class="module-icon">üéØ</span>
                            <h4>Personal Assistant</h4>
                            {% if form.personal_assistant_enabled.value %}<span class="module-status status-active">Active</span>{% endif %}
                        </div>
                        <p class="text-muted text-sm">
                            Enable Personal Assistant for AI-powered daily guidance, priorities, and coaching.
                            <br><em>Requires AI Features to be enabled.</em>
                        </p>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" name="personal_assistant_enabled" id="personal_assistant_toggle" {% if form.personal_assistant_enabled.value %}checked{% endif %}>
                        <span class="toggle-slider"></span>
                    </label>
                </div>

                <div class="toggle-option" id="personal-assistant-consent-option" {% if not form.personal_assistant_enabled.value %}style="display: none;"{% endif %}>
                    <div class="toggle-info">
                        <div class="module-header">
                            <span class="module-icon">üìã</span>
                            <h4>Personal Assistant Data Consent</h4>
                            {% if form.personal_assistant_consent.value %}<span class="module-status status-active">Granted</span>{% endif %}
                        </div>
                        <p class="text-muted text-sm">
                            <strong>Required for Personal Assistant.</strong> The Personal Assistant goes beyond basic AI insights by analyzing your complete journey ‚Äî
                            journal entries, tasks, goals, prayers, health metrics, and life events ‚Äî to provide personalized daily guidance.
                            By consenting, you allow deeper AI analysis of your personal data to generate priorities, detect patterns, and offer accountability.
                            This data is processed by OpenAI's API. You can revoke consent at any time.
                        </p>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" name="personal_assistant_consent" id="personal_assistant_consent_toggle" {% if form.personal_assistant_consent.value %}checked{% endif %}>
                        <span class="toggle-slider"></span>
                    </label>
                </div>

                <div class="personal-assistant-info" id="personal-assistant-info" {% if not form.personal_assistant_enabled.value or not form.personal_assistant_consent.value %}style="display: none;"{% endif %}>
                    <div class="info-box info-box-success">
                        <h4>What the Personal Assistant Does:</h4>
                        <ul class="tips-list">
                            <li><strong>Daily Priorities:</strong> Suggests 3-5 priorities based on your goals, tasks, and patterns</li>
                            <li><strong>Celebrates Wins:</strong> Recognizes your achievements and progress</li>
                            <li><strong>Gentle Nudges:</strong> Reminds you about commitments and intentions</li>
                            <li><strong>Trend Analysis:</strong> Detects patterns and offers insights over time</li>
                            <li><strong>Reflection Prompts:</strong> Provides personalized journaling questions</li>
                        </ul>
                        <p class="mt-3">
                            <a href="{% url 'ai:dashboard' %}" class="btn btn-primary btn-sm">Open Personal Assistant</a>
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Faith Settings Section (shown when Faith module is enabled) -->
        <div class="card mb-6" id="faith-settings-section" {% if not form.faith_enabled.value %}style="display: none;"{% endif %}>
            <h2 class="card-title">Faith Settings</h2>
            <p class="text-muted mb-4">Configure your Faith module preferences.</p>

            <div class="form-group">
                <label for="bible-translation-select" class="form-label">Default Bible Translation</label>
                <select id="bible-translation-select" class="form-select">
                    <option value="">Loading translations...</option>
                </select>
                <input type="hidden" name="default_bible_translation" id="id_default_bible_translation"
                       value="{{ form.default_bible_translation.value|default:'' }}">
                <p class="form-help">This translation will be pre-selected when you look up Scripture. You can still change it on the Scripture page.</p>
                <p class="form-help mt-2"><strong>Note:</strong> Your favorite one is probably missing since this application uses a free version. Once this application reaches enough users to justify the cost, WLJ will invest in the paid version that will give you the more popular translations available today.</p>
            </div>
        </div>

        <!-- Location Section -->
        <div class="card mb-6">
            <h2 class="card-title">Location</h2>
            <p class="text-muted mb-4">Used for weather context (optional).</p>
            
            <!-- US ZIP Code Lookup -->
            <div class="form-group">
                <label for="zip_code" class="form-label">
                    ZIP Code (US only)
                    <span class="form-label-hint">‚Äî auto-fills city</span>
                </label>
                <div class="zip-input-wrapper">
                    <input 
                        type="text" 
                        id="zip_code" 
                        class="form-input"
                        placeholder="e.g., 37201"
                        maxlength="5"
                        pattern="[0-9]{5}"
                    >
                    <button type="button" class="btn btn-secondary btn-sm" onclick="lookupZip()">
                        Lookup
                    </button>
                </div>
                <p class="form-help" id="zip_status"></p>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="id_location_city" class="form-label">City</label>
                    <input 
                        type="text" 
                        name="location_city" 
                        id="id_location_city" 
                        class="form-input"
                        value="{{ form.location_city.value|default:'' }}"
                        placeholder="e.g., Nashville"
                    >
                </div>
                
                <div class="form-group">
                    <label for="id_location_state" class="form-label">State/Country</label>
                    <input 
                        type="text" 
                        name="location_country" 
                        id="id_location_country" 
                        class="form-input"
                        value="{{ form.location_country.value|default:'' }}"
                        placeholder="e.g., Tennessee, US"
                    >
                </div>
            </div>
            
            <div class="form-group">
                <label for="id_timezone" class="form-label">Timezone</label>
                <select name="timezone" id="id_timezone" class="form-select">
                    {% for value, label in form.fields.timezone.widget.choices %}
                        <option value="{{ value }}" {% if form.timezone.value == value %}selected{% endif %}>
                            {{ label }}
                        </option>
                    {% endfor %}
                </select>
            </div>
        </div>

        <!-- Notifications Section -->
        <div class="card mb-6">
            <h2 class="card-title">Notifications</h2>
            <p class="text-muted mb-4">Control how the app communicates with you.</p>

            <div class="toggle-option">
                <div class="toggle-info">
                    <div class="module-header">
                        <span class="module-icon">üì¢</span>
                        <h4>What's New Updates</h4>
                        {% if form.show_whats_new.value %}<span class="module-status status-active">Active</span>{% endif %}
                    </div>
                    <p class="text-muted text-sm">
                        Show a popup when new features, improvements, or fixes are released.
                        You can always view all updates from the <a href="{% url 'core:whats_new_list' %}">What's New</a> page.
                    </p>
                </div>
                <label class="toggle-switch">
                    <input type="checkbox" name="show_whats_new" {% if form.show_whats_new.value %}checked{% endif %}>
                    <span class="toggle-slider"></span>
                </label>
            </div>
        </div>

        <!-- SMS Notifications Section -->
        <div class="card mb-6" id="sms-section">
            <h2 class="card-title">SMS Notifications</h2>
            <p class="text-muted mb-4">Get text message reminders for medicine, tasks, and events. Standard SMS rates may apply.</p>

            <!-- Phone Number Section -->
            <div class="sms-phone-section mb-4">
                <h3 class="module-section-title">Phone Number</h3>

                <div class="form-group">
                    <label for="sms_phone_number" class="form-label">
                        Phone Number
                        <span class="form-label-hint">‚Äî E.164 format: +1XXXXXXXXXX</span>
                    </label>
                    <div class="phone-input-wrapper">
                        <input
                            type="tel"
                            id="sms_phone_number"
                            class="form-input"
                            value="{{ form.instance.phone_number }}"
                            placeholder="+1 (555) 123-4567"
                            {% if form.instance.phone_verified %}readonly{% endif %}
                        >
                        {% if form.instance.phone_verified %}
                        <span class="verified-badge">‚úì Verified</span>
                        <button type="button" class="btn btn-ghost btn-sm" onclick="removePhone()">Remove</button>
                        {% else %}
                        <button type="button" class="btn btn-primary btn-sm" id="send-code-btn" onclick="sendVerificationCode()">Verify</button>
                        {% endif %}
                    </div>
                    <p id="phone-status" class="form-help"></p>
                </div>

                <!-- Verification Code Input (hidden until code sent) -->
                <div id="verification-code-section" class="form-group" style="display: none;">
                    <label for="verification_code" class="form-label">Verification Code</label>
                    <div class="verification-input-wrapper">
                        <input
                            type="text"
                            id="verification_code"
                            class="form-input"
                            placeholder="Enter 6-digit code"
                            maxlength="6"
                            pattern="[0-9]{6}"
                        >
                        <button type="button" class="btn btn-primary btn-sm" onclick="checkVerificationCode()">Verify Code</button>
                    </div>
                    <p class="form-help">Enter the 6-digit code sent to your phone.</p>
                </div>
            </div>

            <!-- Master Toggle (only shown if phone is verified) -->
            <div id="sms-toggles-section" {% if not form.instance.phone_verified %}style="display: none;"{% endif %}>
                <div class="toggle-option">
                    <div class="toggle-info">
                        <div class="module-header">
                            <span class="module-icon">üì±</span>
                            <h4>Enable SMS Notifications</h4>
                            {% if form.sms_enabled.value %}<span class="module-status status-active">Active</span>{% endif %}
                        </div>
                        <p class="text-muted text-sm">
                            Master toggle for all SMS notifications. You can respond to texts with shortcuts:
                            <strong>D</strong>=Done, <strong>R</strong>=Remind, <strong>N</strong>=Skip.
                        </p>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" name="sms_enabled" id="sms_enabled_toggle" {% if form.sms_enabled.value %}checked{% endif %}>
                        <span class="toggle-slider"></span>
                    </label>
                </div>

                <!-- SMS Consent -->
                <div class="toggle-option" id="sms-consent-option" {% if not form.sms_enabled.value %}style="display: none;"{% endif %}>
                    <div class="toggle-info">
                        <div class="module-header">
                            <span class="module-icon">üìã</span>
                            <h4>SMS Consent</h4>
                            {% if form.sms_consent.value %}<span class="module-status status-active">Granted</span>{% endif %}
                        </div>
                        <p class="text-muted text-sm">
                            <strong>Required.</strong> I consent to receive SMS text messages from Whole Life Journey for reminders and notifications.
                            Standard message and data rates may apply. You can opt out at any time by disabling SMS notifications.
                        </p>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" name="sms_consent" id="sms_consent_toggle" {% if form.sms_consent.value %}checked{% endif %}>
                        <span class="toggle-slider"></span>
                    </label>
                </div>

                <!-- Category Toggles (only shown if consent is given) -->
                <div id="sms-categories-section" {% if not form.sms_consent.value %}style="display: none;"{% endif %}>
                    <h3 class="module-section-title mt-6">What to text about</h3>

                    <div class="toggle-option">
                        <div class="toggle-info">
                            <div class="module-header">
                                <span class="module-icon">üíä</span>
                                <h4>Medicine Reminders</h4>
                            </div>
                            <p class="text-muted text-sm">
                                Get reminders when it's time to take your medications.
                            </p>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" name="sms_medicine_reminders" {% if form.sms_medicine_reminders.value %}checked{% endif %}>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>

                    <div class="toggle-option">
                        <div class="toggle-info">
                            <div class="module-header">
                                <span class="module-icon">üì¶</span>
                                <h4>Medicine Refill Alerts</h4>
                            </div>
                            <p class="text-muted text-sm">
                                Get alerts when your medicine supply is running low.
                            </p>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" name="sms_medicine_refill_alerts" {% if form.sms_medicine_refill_alerts.value %}checked{% endif %}>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>

                    <div class="toggle-option">
                        <div class="toggle-info">
                            <div class="module-header">
                                <span class="module-icon">‚úÖ</span>
                                <h4>Task Reminders</h4>
                            </div>
                            <p class="text-muted text-sm">
                                Get reminders when tasks are due today.
                            </p>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" name="sms_task_reminders" {% if form.sms_task_reminders.value %}checked{% endif %}>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>

                    <div class="toggle-option">
                        <div class="toggle-info">
                            <div class="module-header">
                                <span class="module-icon">üìÖ</span>
                                <h4>Event Reminders</h4>
                            </div>
                            <p class="text-muted text-sm">
                                Get reminders 30 minutes before calendar events.
                            </p>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" name="sms_event_reminders" {% if form.sms_event_reminders.value %}checked{% endif %}>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>

                    <div class="toggle-option">
                        <div class="toggle-info">
                            <div class="module-header">
                                <span class="module-icon">üôè</span>
                                <h4>Daily Prayer Reminders</h4>
                            </div>
                            <p class="text-muted text-sm">
                                Get a morning reminder to pray.
                            </p>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" name="sms_prayer_reminders" {% if form.sms_prayer_reminders.value %}checked{% endif %}>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>

                    <div class="toggle-option">
                        <div class="toggle-info">
                            <div class="module-header">
                                <span class="module-icon">‚è±Ô∏è</span>
                                <h4>Fasting Reminders</h4>
                            </div>
                            <p class="text-muted text-sm">
                                Get reminders about your fasting windows.
                            </p>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" name="sms_fasting_reminders" {% if form.sms_fasting_reminders.value %}checked{% endif %}>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>

                    <!-- Quiet Hours -->
                    <h3 class="module-section-title mt-6">Quiet Hours</h3>

                    <div class="toggle-option">
                        <div class="toggle-info">
                            <div class="module-header">
                                <span class="module-icon">üåô</span>
                                <h4>Enable Quiet Hours</h4>
                            </div>
                            <p class="text-muted text-sm">
                                Don't send SMS during nighttime hours. Messages will be delayed until quiet hours end.
                            </p>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" name="sms_quiet_hours_enabled" id="sms_quiet_hours_toggle" {% if form.sms_quiet_hours_enabled.value %}checked{% endif %}>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>

                    <div class="quiet-hours-times" id="quiet-hours-times" {% if not form.sms_quiet_hours_enabled.value %}style="display: none;"{% endif %}>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="sms_quiet_start" class="form-label">Quiet Start</label>
                                <input
                                    type="time"
                                    name="sms_quiet_start"
                                    id="sms_quiet_start"
                                    class="form-input"
                                    value="{{ form.sms_quiet_start.value|time:'H:i' }}"
                                >
                            </div>
                            <div class="form-group">
                                <label for="sms_quiet_end" class="form-label">Quiet End</label>
                                <input
                                    type="time"
                                    name="sms_quiet_end"
                                    id="sms_quiet_end"
                                    class="form-input"
                                    value="{{ form.sms_quiet_end.value|time:'H:i' }}"
                                >
                            </div>
                        </div>
                    </div>

                    <!-- SMS History Link -->
                    <div class="text-right mt-4">
                        <a href="{% url 'sms:history' %}" class="btn btn-secondary btn-sm">
                            View SMS History ‚Üí
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Security Section -->
        <div class="card mb-6" id="security-section">
            <h2 class="card-title">Security</h2>
            <p class="text-muted mb-4">Manage login and authentication options.</p>

            <div class="toggle-option" id="biometric-option">
                <div class="toggle-info">
                    <div class="module-header">
                        <span class="module-icon">üîê</span>
                        <h4>Biometric Login</h4>
                        {% if form.biometric_login_enabled.value %}<span class="module-status status-active">Enabled</span>{% endif %}
                    </div>
                    <p class="text-muted text-sm" id="biometric-description">
                        Use Face ID, Touch ID, or device biometrics for quick, secure login on this device.
                        <span id="biometric-support-status"></span>
                    </p>
                    <div id="biometric-credentials-list" class="mt-3" style="display: none;">
                        <!-- Registered devices will be listed here -->
                    </div>
                </div>
                <div id="biometric-toggle-wrapper">
                    <label class="toggle-switch" id="biometric-toggle-label">
                        <input type="checkbox" name="biometric_login_enabled" id="biometric_toggle" {% if form.biometric_login_enabled.value %}checked{% endif %}>
                        <span class="toggle-slider"></span>
                    </label>
                </div>
            </div>

            <div id="biometric-setup-section" style="display: none;" class="mt-4 p-4 bg-surface border rounded-md">
                <h4 class="text-base font-semibold mb-2">Set Up Biometric Login</h4>
                <p class="text-muted text-sm mb-3">
                    To enable biometric login, we'll register this device's biometric authenticator.
                    Your biometric data never leaves your device.
                </p>
                <button type="button" id="register-biometric-btn" class="btn btn-primary btn-sm">
                    Register This Device
                </button>
                <p id="biometric-status-message" class="text-sm mt-2" style="display: none;"></p>
            </div>
        </div>

        <!-- Health Settings Section (shown when Health module is enabled) -->
        <div class="card mb-6" id="health-settings-section" {% if not form.health_enabled.value %}style="display: none;"{% endif %}>
            <h2 class="card-title">Health Settings</h2>
            <p class="text-muted mb-4">Configure your Health module preferences.</p>

            <div class="form-group">
                <label for="id_default_fasting_type" class="form-label">Default Fasting Type</label>
                <select name="default_fasting_type" id="id_default_fasting_type" class="form-select" onchange="updateFastingDescription()">
                    {% for value, label in form.fields.default_fasting_type.choices %}
                        <option value="{{ value }}" {% if form.default_fasting_type.value == value %}selected{% endif %}>
                            {{ label }}
                        </option>
                    {% endfor %}
                </select>
                <p class="form-help">This will be pre-selected when you start a new fast.</p>
            </div>

            <div class="fasting-description-box" id="fasting-description">
                <p id="fasting-description-text">Select a fasting type to see its description.</p>
            </div>

            <div class="fasting-types-grid">
                <div class="fasting-type-item" data-type="16:8">
                    <strong>16:8</strong>
                    <span>The most popular fasting method. Fast for 16 hours and eat within an 8-hour window.</span>
                </div>
                <div class="fasting-type-item" data-type="18:6">
                    <strong>18:6</strong>
                    <span>A more advanced fast. 18 hours of fasting with a 6-hour eating window.</span>
                </div>
                <div class="fasting-type-item" data-type="20:4">
                    <strong>20:4</strong>
                    <span>Also known as the Warrior Diet. 20 hours fasting with a 4-hour eating window.</span>
                </div>
                <div class="fasting-type-item" data-type="OMAD">
                    <strong>OMAD</strong>
                    <span>One Meal A Day. Fast for approximately 23 hours and consume all daily calories in a single meal.</span>
                </div>
                <div class="fasting-type-item" data-type="24h">
                    <strong>24h</strong>
                    <span>A full 24-hour fast, typically done once or twice per week.</span>
                </div>
                <div class="fasting-type-item" data-type="36h">
                    <strong>36h</strong>
                    <span>An extended fast of 36 hours. More advanced, typically done occasionally.</span>
                </div>
                <div class="fasting-type-item" data-type="custom">
                    <strong>Custom</strong>
                    <span>Set your own fasting duration and schedule.</span>
                </div>
            </div>
        </div>

        <!-- Weight & Nutrition Goals Section (shown when Health module is enabled) -->
        <div class="card mb-6" id="goals-settings-section" {% if not form.health_enabled.value %}style="display: none;"{% endif %}>
            <h2 class="card-title">Weight & Nutrition Goals</h2>
            <p class="text-muted mb-4">Set your personal weight and nutrition targets. Track your progress on the dashboard.</p>

            <!-- Weight Goal Section -->
            <div class="goal-section">
                <h3 class="module-section-title">
                    <span class="goal-icon">‚öñÔ∏è</span> Weight Goal
                </h3>
                <p class="text-muted text-sm mb-4">Set your target weight and when you want to achieve it.</p>

                <div class="form-row form-row-3">
                    <div class="form-group">
                        <label for="id_weight_goal" class="form-label">Target Weight</label>
                        <input
                            type="number"
                            name="weight_goal"
                            id="id_weight_goal"
                            class="form-input"
                            value="{{ form.weight_goal.value|default:'' }}"
                            placeholder="e.g., 180"
                            step="0.1"
                            min="50"
                            max="500"
                        >
                    </div>

                    <div class="form-group">
                        <label for="id_weight_goal_unit" class="form-label">Unit</label>
                        <select name="weight_goal_unit" id="id_weight_goal_unit" class="form-select">
                            <option value="lb" {% if form.weight_goal_unit.value == 'lb' %}selected{% endif %}>Pounds (lb)</option>
                            <option value="kg" {% if form.weight_goal_unit.value == 'kg' %}selected{% endif %}>Kilograms (kg)</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="id_weight_goal_target_date" class="form-label">Target Date</label>
                        <input
                            type="date"
                            name="weight_goal_target_date"
                            id="id_weight_goal_target_date"
                            class="form-input"
                            value="{{ form.weight_goal_target_date.value|date:'Y-m-d'|default:'' }}"
                        >
                    </div>
                </div>

                <p class="form-help">Leave blank if you don't have a specific weight goal. The dashboard will show your progress once you set a goal and log weight entries.</p>
            </div>

            <!-- Nutrition Goals Section -->
            <div class="goal-section mt-6">
                <h3 class="module-section-title">
                    <span class="goal-icon">üçé</span> Nutrition Goals
                </h3>
                <p class="text-muted text-sm mb-4">
                    Set your daily caloric intake and macro split. Research your personal needs based on your age, activity level, and goals.
                </p>

                <div class="form-group">
                    <label for="id_daily_calorie_goal" class="form-label">Daily Calorie Goal</label>
                    <input
                        type="number"
                        name="daily_calorie_goal"
                        id="id_daily_calorie_goal"
                        class="form-input calorie-input"
                        value="{{ form.daily_calorie_goal.value|default:'' }}"
                        placeholder="e.g., 2000"
                        min="500"
                        max="10000"
                        oninput="updateMacroGrams()"
                    >
                    <p class="form-help">Your target daily caloric intake in calories.</p>
                </div>

                <div class="macro-section mt-4">
                    <label class="form-label">Macro Split (must total 100%)</label>
                    <div class="macro-inputs">
                        <div class="macro-input-group">
                            <label for="id_protein_percentage" class="macro-label">
                                <span class="macro-icon protein">ü•©</span> Protein
                            </label>
                            <div class="macro-input-wrapper">
                                <input
                                    type="number"
                                    name="protein_percentage"
                                    id="id_protein_percentage"
                                    class="form-input macro-input"
                                    value="{{ form.protein_percentage.value|default:'' }}"
                                    placeholder="30"
                                    min="0"
                                    max="100"
                                    oninput="updateMacroTotal()"
                                >
                                <span class="macro-percent">%</span>
                            </div>
                            <span class="macro-grams" id="protein-grams"></span>
                        </div>

                        <div class="macro-input-group">
                            <label for="id_carbs_percentage" class="macro-label">
                                <span class="macro-icon carbs">üçû</span> Carbs
                            </label>
                            <div class="macro-input-wrapper">
                                <input
                                    type="number"
                                    name="carbs_percentage"
                                    id="id_carbs_percentage"
                                    class="form-input macro-input"
                                    value="{{ form.carbs_percentage.value|default:'' }}"
                                    placeholder="40"
                                    min="0"
                                    max="100"
                                    oninput="updateMacroTotal()"
                                >
                                <span class="macro-percent">%</span>
                            </div>
                            <span class="macro-grams" id="carbs-grams"></span>
                        </div>

                        <div class="macro-input-group">
                            <label for="id_fat_percentage" class="macro-label">
                                <span class="macro-icon fat">ü•ë</span> Fat
                            </label>
                            <div class="macro-input-wrapper">
                                <input
                                    type="number"
                                    name="fat_percentage"
                                    id="id_fat_percentage"
                                    class="form-input macro-input"
                                    value="{{ form.fat_percentage.value|default:'' }}"
                                    placeholder="30"
                                    min="0"
                                    max="100"
                                    oninput="updateMacroTotal()"
                                >
                                <span class="macro-percent">%</span>
                            </div>
                            <span class="macro-grams" id="fat-grams"></span>
                        </div>
                    </div>

                    <div class="macro-total-row mt-3">
                        <span class="macro-total-label">Total:</span>
                        <span id="macro-total" class="macro-total-value">0%</span>
                        <span id="macro-status" class="macro-status"></span>
                    </div>
                </div>

                <div class="nutrition-tips mt-4">
                    <h4 class="tips-title">Common Macro Splits:</h4>
                    <div class="macro-presets">
                        <button type="button" class="btn btn-ghost btn-sm macro-preset" onclick="setMacroPreset(30, 40, 30)">
                            Balanced (30/40/30)
                        </button>
                        <button type="button" class="btn btn-ghost btn-sm macro-preset" onclick="setMacroPreset(40, 30, 30)">
                            High Protein (40/30/30)
                        </button>
                        <button type="button" class="btn btn-ghost btn-sm macro-preset" onclick="setMacroPreset(30, 20, 50)">
                            Low Carb (30/20/50)
                        </button>
                        <button type="button" class="btn btn-ghost btn-sm macro-preset" onclick="setMacroPreset(20, 5, 75)">
                            Keto (20/5/75)
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Integrations Section -->
        <div class="card mb-6">
            <h2 class="card-title">Integrations</h2>
            <p class="text-muted mb-4">Connect external services to enhance your experience.</p>

            <div class="integration-item">
                <div class="integration-icon">
                    <svg viewBox="0 0 24 24" width="32" height="32" fill="none" stroke="currentColor" stroke-width="1.5">
                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                        <line x1="16" y1="2" x2="16" y2="6"/>
                        <line x1="8" y1="2" x2="8" y2="6"/>
                        <line x1="3" y1="10" x2="21" y2="10"/>
                    </svg>
                </div>
                <div class="integration-info">
                    <h4>Google Calendar</h4>
                    <p class="text-muted text-sm">
                        Sync your events between Whole Life Journey and Google Calendar.
                    </p>
                    {% if google_calendar_connected %}
                    <p class="integration-status integration-connected">
                        <svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                            <polyline points="22 4 12 14.01 9 11.01"/>
                        </svg>
                        Connected{% if google_calendar_name %} ‚Äî {{ google_calendar_name }}{% endif %}
                    </p>
                    {% else %}
                    <p class="integration-status integration-disconnected">
                        Not connected
                    </p>
                    {% endif %}
                </div>
                <div class="integration-actions">
                    <a href="{% safe_url 'life:google_calendar_settings' fallback='/life/' %}" class="btn btn-secondary btn-sm">
                        {% if google_calendar_connected %}Manage{% else %}Connect{% endif %}
                    </a>
                </div>
            </div>
        </div>
        
        <!-- Save -->
        <div class="form-actions">
            <button type="submit" class="btn btn-primary">
                Save Preferences
            </button>
        </div>
    </form>
</div>

<style>
.module-section-title {
    font-size: var(--font-size-sm);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--color-text-muted);
    margin-bottom: var(--space-4);
    padding-bottom: var(--space-2);
    border-bottom: 1px solid var(--color-border);
}

.toggle-option {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    padding: var(--space-4);
    margin-bottom: var(--space-3);
    background: var(--color-surface);
    border-radius: var(--radius-md);
    border: 1px solid var(--color-border);
}

.toggle-option:last-child {
    margin-bottom: 0;
}

.toggle-option.disabled {
    opacity: 0.7;
}

.toggle-info {
    flex: 1;
    padding-right: var(--space-4);
}

.module-header {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    margin-bottom: var(--space-2);
}

.module-icon {
    font-size: var(--font-size-xl);
}

.module-header h4 {
    font-size: var(--font-size-base);
    margin: 0;
}

.module-status {
    font-size: var(--font-size-xs);
    padding: var(--space-1) var(--space-2);
    border-radius: var(--radius-full);
    font-weight: 500;
}

.toggle-switch {
    position: relative;
    display: inline-block;
    width: 48px;
    height: 28px;
    flex-shrink: 0;
}

.toggle-switch input {
    opacity: 0;
    width: 0;
    height: 0;
}

.toggle-slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: var(--color-border);
    transition: var(--transition-fast);
    border-radius: var(--radius-full);
}

.toggle-slider:before {
    position: absolute;
    content: "";
    height: 20px;
    width: 20px;
    left: 4px;
    bottom: 4px;
    background-color: white;
    transition: var(--transition-fast);
    border-radius: var(--radius-full);
}

.toggle-switch input:checked + .toggle-slider {
    background-color: var(--color-accent);
}

.toggle-switch input:checked + .toggle-slider:before {
    transform: translateX(20px);
}

.color-input-wrapper {
    display: flex;
    align-items: center;
    gap: var(--space-2);
}

.form-color {
    width: 50px;
    height: 38px;
    padding: 0;
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    cursor: pointer;
}

.form-color-text {
    flex: 1;
    max-width: 150px;
}

.zip-input-wrapper {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    max-width: 250px;
}

.zip-input-wrapper .form-input {
    flex: 1;
}

.form-label-hint {
    font-weight: normal;
    color: var(--color-text-muted);
    font-size: var(--font-size-sm);
}

.form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: var(--space-4);
}

@media (max-width: 640px) {
    .form-row {
        grid-template-columns: 1fr;
    }
    
    .toggle-option {
        flex-direction: column;
        gap: var(--space-3);
    }
    
    .toggle-info {
        padding-right: 0;
    }
}

/* Integrations */
.integration-item {
    display: flex;
    align-items: flex-start;
    gap: var(--space-4);
    padding: var(--space-4);
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    margin-bottom: var(--space-3);
}

.integration-item:last-child {
    margin-bottom: 0;
}

.integration-icon {
    width: 48px;
    height: 48px;
    background: var(--color-background);
    border-radius: var(--radius-md);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--color-accent);
    flex-shrink: 0;
}

.integration-info {
    flex: 1;
}

.integration-info h4 {
    font-size: var(--font-size-base);
    font-weight: 600;
    margin: 0 0 var(--space-1) 0;
}

.integration-status {
    display: flex;
    align-items: center;
    gap: var(--space-1);
    font-size: var(--font-size-sm);
    margin-top: var(--space-2);
}

.integration-connected {
    color: var(--color-success, #10b981);
}

.integration-disconnected {
    color: var(--color-text-muted);
}

.integration-actions {
    flex-shrink: 0;
}

.integration-coming-soon {
    opacity: 0.6;
}

.coming-soon-badge {
    display: inline-block;
    font-size: var(--font-size-xs);
    background: var(--color-border);
    color: var(--color-text-muted);
    padding: var(--space-1) var(--space-2);
    border-radius: var(--radius-sm);
    margin-top: var(--space-2);
}

@media (max-width: 640px) {
    .integration-item {
        flex-direction: column;
        text-align: center;
    }
    
    .integration-actions {
        width: 100%;
    }
    
    .integration-actions .btn {
        width: 100%;
    }
}

/* AI Coaching Style Cards */
.ai-coaching-section {
    margin-top: var(--space-4);
    padding-top: var(--space-4);
    border-top: 1px solid var(--color-border);
}

.ai-coaching-section.hidden {
    display: none;
}

.coaching-style-options {
    display: grid;
    grid-template-columns: 1fr;
    gap: var(--space-3);
}

@media (min-width: 640px) {
    .coaching-style-options {
        grid-template-columns: repeat(2, 1fr);
    }
}

@media (min-width: 1024px) {
    .coaching-style-options {
        grid-template-columns: repeat(3, 1fr);
    }
}

@media (min-width: 1280px) {
    .coaching-style-options {
        grid-template-columns: repeat(4, 1fr);
    }
}

.coaching-style-card {
    display: block;
    cursor: pointer;
    border: 2px solid var(--color-border);
    border-radius: var(--radius-lg);
    padding: var(--space-4);
    transition: all var(--transition-fast);
    background: var(--color-background);
}

.coaching-style-card:hover {
    border-color: var(--color-accent);
    background: var(--color-surface);
}

.coaching-style-card.selected,
.coaching-style-card:has(input:checked) {
    border-color: var(--color-accent);
    background: color-mix(in srgb, var(--color-accent) 5%, var(--color-background));
    box-shadow: 0 0 0 3px color-mix(in srgb, var(--color-accent) 15%, transparent);
}

.coaching-style-card input[type="radio"] {
    position: absolute;
    opacity: 0;
    pointer-events: none;
}

.card-content {
    display: flex;
    flex-direction: column;
    text-align: center;
}

.card-icon {
    font-size: 2rem;
    line-height: 1;
    margin: 0 auto var(--space-2);
}

.card-text {
    flex: 1;
}

.card-title {
    font-weight: 600;
    font-size: var(--font-size-base);
    color: var(--color-text);
    margin-bottom: var(--space-1);
}

.card-description {
    color: var(--color-text-muted);
    font-size: var(--font-size-sm);
    line-height: var(--line-height-relaxed);
}

/* AI Profile Section */
.ai-profile-section {
    margin-top: var(--space-4);
    padding-top: var(--space-4);
    border-top: 1px solid var(--color-border);
}

.ai-profile-section.hidden {
    display: none;
}

.form-textarea {
    width: 100%;
    padding: var(--space-3);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    background: var(--color-background);
    color: var(--color-text);
    font-family: inherit;
    font-size: var(--font-size-base);
    line-height: var(--line-height-relaxed);
    resize: vertical;
    min-height: 120px;
}

.form-textarea:focus {
    outline: none;
    border-color: var(--color-accent);
    box-shadow: 0 0 0 3px color-mix(in srgb, var(--color-accent) 15%, transparent);
}

.form-textarea::placeholder {
    color: var(--color-text-muted);
    opacity: 0.7;
}

.form-help-row {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-top: var(--space-2);
    gap: var(--space-4);
}

.char-counter {
    font-size: var(--font-size-xs);
    color: var(--color-text-muted);
    white-space: nowrap;
}

.ai-profile-tips {
    margin-top: var(--space-4);
    padding: var(--space-4);
    background: color-mix(in srgb, var(--color-accent) 5%, var(--color-background));
    border-radius: var(--radius-md);
    border: 1px solid color-mix(in srgb, var(--color-accent) 20%, transparent);
}

.tips-title {
    font-size: var(--font-size-sm);
    font-weight: 600;
    color: var(--color-text);
    margin: 0 0 var(--space-2) 0;
}

.tips-list {
    margin: 0;
    padding-left: var(--space-5);
    font-size: var(--font-size-sm);
    color: var(--color-text-muted);
}

.tips-list li {
    margin-bottom: var(--space-1);
}

.tips-list li:last-child {
    margin-bottom: 0;
}

/* Personal Assistant Section */
.personal-assistant-section {
    margin-top: var(--space-4);
    padding-top: var(--space-4);
    border-top: 1px solid var(--color-border);
}

.personal-assistant-section.hidden {
    display: none;
}

.info-box {
    padding: var(--space-4);
    border-radius: var(--radius-md);
    margin-top: var(--space-3);
}

.info-box-success {
    background: color-mix(in srgb, #10b981 10%, var(--color-background));
    border: 1px solid color-mix(in srgb, #10b981 30%, var(--color-border));
}

.info-box h4 {
    font-size: var(--font-size-sm);
    font-weight: 600;
    color: var(--color-text);
    margin: 0 0 var(--space-2) 0;
}

/* Fasting Settings */
.fasting-description-box {
    background: linear-gradient(135deg,
        color-mix(in srgb, #10b981 10%, var(--color-surface)) 0%,
        var(--color-surface) 100%);
    border: 1px solid color-mix(in srgb, #10b981 30%, var(--color-border));
    border-left: 4px solid #10b981;
    border-radius: var(--radius-md);
    padding: var(--space-3);
    margin-bottom: var(--space-4);
}

.fasting-description-box p {
    margin: 0;
    font-size: var(--font-size-sm);
    color: var(--color-text);
}

.fasting-types-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: var(--space-3);
}

.fasting-type-item {
    background: var(--color-background);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    padding: var(--space-3);
    cursor: pointer;
    transition: all var(--transition-fast);
}

.fasting-type-item:hover {
    border-color: #10b981;
}

.fasting-type-item.active {
    border-color: #10b981;
    background: color-mix(in srgb, #10b981 5%, var(--color-background));
}

.fasting-type-item strong {
    display: block;
    color: #059669;
    margin-bottom: var(--space-1);
}

.fasting-type-item span {
    font-size: var(--font-size-xs);
    color: var(--color-text-muted);
    line-height: 1.4;
}

/* Weight & Nutrition Goals Styles */
.goal-section {
    padding-top: var(--space-2);
}

.goal-section .module-section-title {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    text-transform: none;
    font-size: var(--font-size-base);
    font-weight: 600;
    color: var(--color-text);
}

.goal-icon {
    font-size: 1.25rem;
}

.form-row-3 {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: var(--space-4);
}

@media (max-width: 768px) {
    .form-row-3 {
        grid-template-columns: 1fr;
    }
}

.calorie-input {
    max-width: 200px;
}

.macro-section {
    background: var(--color-background);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    padding: var(--space-4);
}

.macro-inputs {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: var(--space-4);
}

@media (max-width: 768px) {
    .macro-inputs {
        grid-template-columns: 1fr;
    }
}

.macro-input-group {
    display: flex;
    flex-direction: column;
    gap: var(--space-2);
}

.macro-label {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    font-weight: 500;
    font-size: var(--font-size-sm);
}

.macro-icon {
    font-size: 1.25rem;
}

.macro-input-wrapper {
    display: flex;
    align-items: center;
    gap: var(--space-1);
}

.macro-input {
    width: 80px;
    text-align: center;
}

.macro-percent {
    font-weight: 500;
    color: var(--color-text-muted);
}

.macro-grams {
    font-size: var(--font-size-xs);
    color: var(--color-text-muted);
}

.macro-total-row {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    padding-top: var(--space-3);
    border-top: 1px solid var(--color-border);
}

.macro-total-label {
    font-weight: 600;
}

.macro-total-value {
    font-weight: 700;
    font-size: var(--font-size-lg);
}

.macro-total-value.valid {
    color: var(--color-success, #10b981);
}

.macro-total-value.invalid {
    color: var(--color-error, #ef4444);
}

.macro-status {
    font-size: var(--font-size-sm);
}

.macro-status.valid {
    color: var(--color-success, #10b981);
}

.macro-status.invalid {
    color: var(--color-error, #ef4444);
}

.nutrition-tips {
    background: color-mix(in srgb, var(--color-accent) 5%, var(--color-background));
    border: 1px solid color-mix(in srgb, var(--color-accent) 20%, transparent);
    border-radius: var(--radius-md);
    padding: var(--space-4);
}

.macro-presets {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-2);
    margin-top: var(--space-2);
}

.macro-preset {
    font-size: var(--font-size-xs);
}

/* SMS Notifications Styles */
.phone-input-wrapper,
.verification-input-wrapper {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    max-width: 400px;
}

.phone-input-wrapper .form-input,
.verification-input-wrapper .form-input {
    flex: 1;
}

.verified-badge {
    color: var(--color-success, #10b981);
    font-weight: 600;
    font-size: var(--font-size-sm);
    display: inline-flex;
    align-items: center;
    gap: var(--space-1);
}

.quiet-hours-times {
    margin-top: var(--space-3);
    padding: var(--space-4);
    background: var(--color-background);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
}

.quiet-hours-times .form-row {
    max-width: 300px;
}
</style>

<script src="{% static 'js/timezone-lookup.js' %}"></script>
<script>
// Accent color handling
document.getElementById('id_accent_color').addEventListener('input', function(e) {
    document.getElementById('accent_color_text').value = e.target.value;
});

function clearAccentColor() {
    document.getElementById('id_accent_color').value = '#6366f1';
    document.getElementById('accent_color_text').value = '';
}

// AI coaching style, data consent, and profile toggle visibility
function updateAIProfileVisibility() {
    const aiEnabled = document.getElementById('ai_enabled_toggle').checked;
    const consentEnabled = document.getElementById('ai_data_consent_toggle').checked;
    const profileSection = document.getElementById('ai-profile-section');

    if (profileSection) {
        if (aiEnabled && consentEnabled) {
            profileSection.classList.remove('hidden');
        } else {
            profileSection.classList.add('hidden');
        }
    }
}

// Personal Assistant visibility and toggle logic
function updatePersonalAssistantVisibility() {
    const aiEnabled = document.getElementById('ai_enabled_toggle').checked;
    const consentEnabled = document.getElementById('ai_data_consent_toggle').checked;
    const paSection = document.getElementById('personal-assistant-section');
    const paToggle = document.getElementById('personal_assistant_toggle');
    const paConsentOption = document.getElementById('personal-assistant-consent-option');
    const paConsentToggle = document.getElementById('personal_assistant_consent_toggle');
    const paInfo = document.getElementById('personal-assistant-info');

    if (paSection) {
        if (aiEnabled && consentEnabled) {
            paSection.classList.remove('hidden');
        } else {
            paSection.classList.add('hidden');
            // Also uncheck Personal Assistant when AI is disabled
            if (paToggle) paToggle.checked = false;
            if (paConsentToggle) paConsentToggle.checked = false;
        }
    }

    // Show/hide consent option based on Personal Assistant toggle
    if (paConsentOption && paToggle) {
        paConsentOption.style.display = paToggle.checked ? 'flex' : 'none';
    }

    // Show/hide info box based on both toggles
    if (paInfo && paToggle && paConsentToggle) {
        paInfo.style.display = (paToggle.checked && paConsentToggle.checked) ? 'block' : 'none';
    }
}

document.getElementById('ai_enabled_toggle').addEventListener('change', function() {
    const coachingSection = document.getElementById('ai-coaching-section');
    const dataConsentOption = document.getElementById('ai-data-consent-option');
    if (this.checked) {
        coachingSection.classList.remove('hidden');
        if (dataConsentOption) dataConsentOption.style.display = 'flex';
    } else {
        coachingSection.classList.add('hidden');
        if (dataConsentOption) dataConsentOption.style.display = 'none';
    }
    updateAIProfileVisibility();
    updatePersonalAssistantVisibility();
});

// Data consent toggle also affects profile and Personal Assistant visibility
document.getElementById('ai_data_consent_toggle').addEventListener('change', function() {
    updateAIProfileVisibility();
    updatePersonalAssistantVisibility();
});

// Personal Assistant toggle
const personalAssistantToggle = document.getElementById('personal_assistant_toggle');
if (personalAssistantToggle) {
    personalAssistantToggle.addEventListener('change', function() {
        updatePersonalAssistantVisibility();
    });
}

// Personal Assistant consent toggle
const paConsentToggle = document.getElementById('personal_assistant_consent_toggle');
if (paConsentToggle) {
    paConsentToggle.addEventListener('change', function() {
        updatePersonalAssistantVisibility();
    });
}

// Character counter for AI profile
const aiProfileTextarea = document.getElementById('id_ai_profile');
const aiProfileLengthSpan = document.getElementById('ai-profile-length');
if (aiProfileTextarea && aiProfileLengthSpan) {
    aiProfileTextarea.addEventListener('input', function() {
        aiProfileLengthSpan.textContent = this.value.length;
    });
}

// Coaching style card selection
document.querySelectorAll('.coaching-style-card input[type="radio"]').forEach(radio => {
    radio.addEventListener('change', function() {
        document.querySelectorAll('.coaching-style-card').forEach(card => {
            card.classList.remove('selected');
        });
        if (this.checked) {
            this.closest('.coaching-style-card').classList.add('selected');
        }
    });
});

// Faith settings section visibility
const faithToggle = document.querySelector('input[name="faith_enabled"]');
if (faithToggle) {
    faithToggle.addEventListener('change', function() {
        const faithSection = document.getElementById('faith-settings-section');
        if (faithSection) {
            faithSection.style.display = this.checked ? 'block' : 'none';
        }
    });
}

// Health settings section visibility (including goals section)
const healthToggle = document.querySelector('input[name="health_enabled"]');
if (healthToggle) {
    healthToggle.addEventListener('change', function() {
        const healthSection = document.getElementById('health-settings-section');
        const goalsSection = document.getElementById('goals-settings-section');
        if (healthSection) {
            healthSection.style.display = this.checked ? 'block' : 'none';
        }
        if (goalsSection) {
            goalsSection.style.display = this.checked ? 'block' : 'none';
        }
    });
}

// Macro percentage calculations
function updateMacroTotal() {
    const protein = parseInt(document.getElementById('id_protein_percentage').value) || 0;
    const carbs = parseInt(document.getElementById('id_carbs_percentage').value) || 0;
    const fat = parseInt(document.getElementById('id_fat_percentage').value) || 0;

    const total = protein + carbs + fat;
    const totalEl = document.getElementById('macro-total');
    const statusEl = document.getElementById('macro-status');

    if (totalEl) {
        totalEl.textContent = total + '%';
        totalEl.classList.remove('valid', 'invalid');
        statusEl.classList.remove('valid', 'invalid');

        if (total === 100) {
            totalEl.classList.add('valid');
            statusEl.textContent = '‚úì Perfect!';
            statusEl.classList.add('valid');
        } else if (total > 0) {
            totalEl.classList.add('invalid');
            if (total < 100) {
                statusEl.textContent = `Need ${100 - total}% more`;
            } else {
                statusEl.textContent = `${total - 100}% over`;
            }
            statusEl.classList.add('invalid');
        } else {
            statusEl.textContent = '';
        }
    }

    updateMacroGrams();
}

function updateMacroGrams() {
    const calories = parseInt(document.getElementById('id_daily_calorie_goal').value) || 0;
    const protein = parseInt(document.getElementById('id_protein_percentage').value) || 0;
    const carbs = parseInt(document.getElementById('id_carbs_percentage').value) || 0;
    const fat = parseInt(document.getElementById('id_fat_percentage').value) || 0;

    // Calculate grams: Protein & Carbs = 4 cal/g, Fat = 9 cal/g
    const proteinGrams = calories > 0 && protein > 0 ? Math.round((calories * protein / 100) / 4) : 0;
    const carbsGrams = calories > 0 && carbs > 0 ? Math.round((calories * carbs / 100) / 4) : 0;
    const fatGrams = calories > 0 && fat > 0 ? Math.round((calories * fat / 100) / 9) : 0;

    const proteinEl = document.getElementById('protein-grams');
    const carbsEl = document.getElementById('carbs-grams');
    const fatEl = document.getElementById('fat-grams');

    if (proteinEl) proteinEl.textContent = proteinGrams > 0 ? `‚âà ${proteinGrams}g` : '';
    if (carbsEl) carbsEl.textContent = carbsGrams > 0 ? `‚âà ${carbsGrams}g` : '';
    if (fatEl) fatEl.textContent = fatGrams > 0 ? `‚âà ${fatGrams}g` : '';
}

function setMacroPreset(protein, carbs, fat) {
    document.getElementById('id_protein_percentage').value = protein;
    document.getElementById('id_carbs_percentage').value = carbs;
    document.getElementById('id_fat_percentage').value = fat;
    updateMacroTotal();
}

// Initialize macro calculations on page load
document.addEventListener('DOMContentLoaded', function() {
    updateMacroTotal();
});

// Fasting type descriptions and UI
const fastingDescriptions = {
    "16:8": "The most popular fasting method. Fast for 16 hours and eat within an 8-hour window. Example: Eat between 12pm-8pm.",
    "18:6": "A more advanced fast. 18 hours of fasting with a 6-hour eating window. Example: Eat between 1pm-7pm.",
    "20:4": "Also known as the Warrior Diet. 20 hours fasting with a 4-hour eating window. Example: Eat between 4pm-8pm.",
    "OMAD": "One Meal A Day. Fast for approximately 23 hours and consume all daily calories in a single meal.",
    "24h": "A full 24-hour fast, typically done once or twice per week. Example: Dinner to dinner.",
    "36h": "An extended fast of 36 hours. More advanced, typically done occasionally for deeper benefits.",
    "custom": "Set your own fasting duration and schedule."
};

function updateFastingDescription() {
    const select = document.getElementById('id_default_fasting_type');
    const descBox = document.getElementById('fasting-description-text');
    if (!select || !descBox) return;

    const selectedType = select.value;
    if (fastingDescriptions[selectedType]) {
        descBox.textContent = fastingDescriptions[selectedType];
    } else {
        descBox.textContent = 'Select a fasting type to see its description.';
    }

    // Highlight the corresponding grid item
    document.querySelectorAll('.fasting-type-item').forEach(item => {
        if (item.dataset.type === selectedType) {
            item.classList.add('active');
        } else {
            item.classList.remove('active');
        }
    });
}

// Make fasting type items clickable
document.querySelectorAll('.fasting-type-item').forEach(item => {
    item.addEventListener('click', function() {
        const type = this.dataset.type;
        const select = document.getElementById('id_default_fasting_type');
        if (select) {
            select.value = type;
            updateFastingDescription();
        }
    });
});

// Initialize fasting description on load
document.addEventListener('DOMContentLoaded', function() {
    updateFastingDescription();
});

// Bible translation loading for preferences
// Security: API key is kept server-side, accessed via proxy
const API_PROXY_BASE = '/faith/api/bible';
const savedTranslation = document.getElementById('id_default_bible_translation')?.value || '';

async function loadBibleTranslations() {
    const select = document.getElementById('bible-translation-select');
    if (!select) return;

    try {
        // First check if API is configured (server-side)
        const statusResponse = await fetch(`${API_PROXY_BASE}/status/`);
        const statusData = await statusResponse.json();

        if (!statusData.configured) {
            select.innerHTML = '<option value="">API not configured</option>';
            return;
        }

        const response = await fetch(`${API_PROXY_BASE}/bibles/`);

        if (!response.ok) {
            throw new Error('Failed to load translations');
        }

        const data = await response.json();
        const bibles = data.data || [];

        // Sort and deduplicate by abbreviation
        const seen = new Set();
        const uniqueBibles = [];
        bibles.sort((a, b) => a.name.localeCompare(b.name));

        for (const bible of bibles) {
            const key = bible.abbreviation || bible.name;
            if (!seen.has(key)) {
                seen.add(key);
                uniqueBibles.push(bible);
            }
        }

        select.innerHTML = '<option value="">Select a translation</option>';
        uniqueBibles.forEach(bible => {
            const option = document.createElement('option');
            option.value = bible.id;
            option.textContent = `${bible.abbreviation} - ${bible.name}`;
            if (bible.id === savedTranslation) {
                option.selected = true;
            }
            select.appendChild(option);
        });

        // Sync select with hidden input
        select.addEventListener('change', function() {
            document.getElementById('id_default_bible_translation').value = this.value;
        });

    } catch (error) {
        console.error('Error loading Bible translations:', error);
        select.innerHTML = '<option value="">Error loading translations</option>';
    }
}

// Load translations when page loads (if faith section visible)
document.addEventListener('DOMContentLoaded', function() {
    const faithSection = document.getElementById('faith-settings-section');
    if (faithSection && faithSection.style.display !== 'none') {
        loadBibleTranslations();
    }

    // Also load when faith is toggled on
    const faithToggle = document.querySelector('input[name="faith_enabled"]');
    if (faithToggle) {
        faithToggle.addEventListener('change', function() {
            if (this.checked) {
                loadBibleTranslations();
            }
        });
    }
});
// SMS Notifications toggle logic
const smsEnabledToggle = document.getElementById('sms_enabled_toggle');
const smsConsentToggle = document.getElementById('sms_consent_toggle');
const smsQuietHoursToggle = document.getElementById('sms_quiet_hours_toggle');

if (smsEnabledToggle) {
    smsEnabledToggle.addEventListener('change', function() {
        const consentOption = document.getElementById('sms-consent-option');
        const categoriesSection = document.getElementById('sms-categories-section');
        if (this.checked) {
            if (consentOption) consentOption.style.display = 'flex';
        } else {
            if (consentOption) consentOption.style.display = 'none';
            if (categoriesSection) categoriesSection.style.display = 'none';
            if (smsConsentToggle) smsConsentToggle.checked = false;
        }
    });
}

if (smsConsentToggle) {
    smsConsentToggle.addEventListener('change', function() {
        const categoriesSection = document.getElementById('sms-categories-section');
        if (categoriesSection) {
            categoriesSection.style.display = this.checked ? 'block' : 'none';
        }
    });
}

if (smsQuietHoursToggle) {
    smsQuietHoursToggle.addEventListener('change', function() {
        const quietHoursTimes = document.getElementById('quiet-hours-times');
        if (quietHoursTimes) {
            quietHoursTimes.style.display = this.checked ? 'block' : 'none';
        }
    });
}

// Phone verification functions
async function sendVerificationCode() {
    const phoneInput = document.getElementById('sms_phone_number');
    const statusEl = document.getElementById('phone-status');
    const sendBtn = document.getElementById('send-code-btn');
    const codeSection = document.getElementById('verification-code-section');

    let phone = phoneInput.value.trim();

    // Basic phone normalization - add +1 if not present
    if (phone && !phone.startsWith('+')) {
        phone = '+1' + phone.replace(/\D/g, '');
    }

    if (!phone || phone.length < 10) {
        statusEl.textContent = 'Please enter a valid phone number';
        statusEl.style.color = 'var(--color-error, #ef4444)';
        return;
    }

    sendBtn.disabled = true;
    sendBtn.textContent = 'Sending...';
    statusEl.textContent = '';

    try {
        const response = await fetch('/sms/api/verify/send/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({ phone_number: phone })
        });

        const data = await response.json();

        if (data.success) {
            statusEl.textContent = 'Verification code sent! Check your phone.';
            statusEl.style.color = 'var(--color-success, #10b981)';
            codeSection.style.display = 'block';
            phoneInput.value = phone;  // Update to normalized format
        } else {
            statusEl.textContent = data.error || 'Failed to send code';
            statusEl.style.color = 'var(--color-error, #ef4444)';
        }
    } catch (error) {
        statusEl.textContent = 'Network error. Please try again.';
        statusEl.style.color = 'var(--color-error, #ef4444)';
    } finally {
        sendBtn.disabled = false;
        sendBtn.textContent = 'Verify';
    }
}

async function checkVerificationCode() {
    const codeInput = document.getElementById('verification_code');
    const statusEl = document.getElementById('phone-status');

    const code = codeInput.value.trim();

    if (!code || code.length !== 6) {
        statusEl.textContent = 'Please enter the 6-digit code';
        statusEl.style.color = 'var(--color-error, #ef4444)';
        return;
    }

    statusEl.textContent = 'Verifying...';

    try {
        const response = await fetch('/sms/api/verify/check/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({ code: code })
        });

        const data = await response.json();

        if (data.success) {
            statusEl.textContent = 'Phone verified successfully!';
            statusEl.style.color = 'var(--color-success, #10b981)';
            // Reload to show verified state
            setTimeout(() => location.reload(), 1000);
        } else {
            statusEl.textContent = data.error || 'Invalid code';
            statusEl.style.color = 'var(--color-error, #ef4444)';
        }
    } catch (error) {
        statusEl.textContent = 'Network error. Please try again.';
        statusEl.style.color = 'var(--color-error, #ef4444)';
    }
}

async function removePhone() {
    if (!confirm('Are you sure you want to remove your phone number? This will disable all SMS notifications.')) {
        return;
    }

    try {
        const response = await fetch('/sms/api/phone/remove/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        });

        const data = await response.json();

        if (data.success) {
            location.reload();
        } else {
            alert(data.error || 'Failed to remove phone number');
        }
    } catch (error) {
        alert('Network error. Please try again.');
    }
}
</script>
<script src="{% static 'js/biometric.js' %}"></script>
{% endblock %}