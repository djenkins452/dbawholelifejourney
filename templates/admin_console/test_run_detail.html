{% extends "base.html" %}
{% load static %}

{% block title %}Test Run Details - Admin Console
</div>
{% endblock %}

{% block content %}
<div class="container">
<div class="space-y-6">
    <!-- Header -->
    <div class="flex justify-between items-center">
        <div>
            <a href="{% url 'admin_console:test_run_list' %}" class="text-sm text-muted hover:text-primary mb-2 inline-block">&larr; Back to Test History</a>
            <h1 class="text-2xl font-bold">Test Run Details</h1>
            <p class="text-muted">{{ test_run.run_at|date:"F d, Y \a\t H:i:s" }}</p>
        </div>
        <div>
            <a href="{% url 'admin_console:test_run_delete' test_run.pk %}" class="btn btn-danger">Delete Run</a>
        </div>
    </div>

    <!-- Summary Card -->
    <div class="card p-6">
        <h2 class="text-lg font-semibold mb-4">Summary</h2>

        <div class="grid grid-cols-2 md:grid-cols-6 gap-4 mb-6">
            <div>
                <div class="text-2xl font-bold">{{ test_run.total_tests }}</div>
                <div class="text-sm text-muted">Total Tests</div>
            </div>
            <div>
                <div class="text-2xl font-bold text-green-600">{{ test_run.passed }}</div>
                <div class="text-sm text-muted">Passed</div>
            </div>
            <div>
                <div class="text-2xl font-bold {% if test_run.failed > 0 %}text-red-600{% endif %}">{{ test_run.failed }}</div>
                <div class="text-sm text-muted">Failed</div>
            </div>
            <div>
                <div class="text-2xl font-bold {% if test_run.errors > 0 %}text-orange-600{% endif %}">{{ test_run.errors }}</div>
                <div class="text-sm text-muted">Errors</div>
            </div>
            <div>
                <div class="text-2xl font-bold">{{ test_run.pass_rate }}%</div>
                <div class="text-sm text-muted">Pass Rate</div>
            </div>
            <div>
                <div class="text-2xl font-bold">{{ test_run.duration_seconds|floatformat:1 }}s</div>
                <div class="text-sm text-muted">Duration</div>
            </div>
        </div>

        <div class="flex items-center gap-4 text-sm">
            <div>
                <span class="font-medium">Status:</span>
                {% if test_run.status == 'passed' %}
                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800 ml-1">
                    All Passed
                </span>
                {% elif test_run.status == 'failed' %}
                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-red-100 text-red-800 ml-1">
                    Some Failed
                </span>
                {% else %}
                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-orange-100 text-orange-800 ml-1">
                    Has Errors
                </span>
                {% endif %}
            </div>
            {% if test_run.git_branch %}
            <div>
                <span class="font-medium">Branch:</span>
                <code class="bg-surface px-2 py-1 rounded text-xs ml-1">{{ test_run.git_branch }}</code>
            </div>
            {% endif %}
            {% if test_run.git_commit %}
            <div>
                <span class="font-medium">Commit:</span>
                <code class="bg-surface px-2 py-1 rounded text-xs ml-1">{{ test_run.git_commit }}</code>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Results by App -->
    <div class="card">
        <div class="p-4 border-b">
            <h2 class="text-lg font-semibold">Results by App</h2>
        </div>

        <div class="divide-y">
            {% for detail in details %}
            <div class="p-4 {% if detail.failed > 0 or detail.errors > 0 %}bg-red-50{% endif %}">
                <div class="flex justify-between items-center">
                    <div class="flex items-center gap-3">
                        {% if detail.status == 'passed' %}
                        <span class="w-8 h-8 flex items-center justify-center rounded-full bg-green-100 text-green-600">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                            </svg>
                        </span>
                        {% else %}
                        <span class="w-8 h-8 flex items-center justify-center rounded-full bg-red-100 text-red-600">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                            </svg>
                        </span>
                        {% endif %}
                        <div>
                            <div class="font-medium">{{ detail.app_name }}</div>
                            <div class="text-sm text-muted">
                                {{ detail.passed }} passed
                                {% if detail.failed > 0 %}, <span class="text-red-600">{{ detail.failed }} failed</span>{% endif %}
                                {% if detail.errors > 0 %}, <span class="text-orange-600">{{ detail.errors }} errors</span>{% endif %}
                            </div>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="text-lg font-bold">{{ detail.total }}</div>
                        <div class="text-xs text-muted">tests</div>
                    </div>
                </div>

                <!-- Failed/Error Test Names -->
                {% if detail.failed_tests_list or detail.error_tests_list %}
                <div class="mt-3 pt-3 border-t border-red-200">
                    {% if detail.failed_tests_list %}
                    <div class="mb-2">
                        <div class="text-sm font-medium text-red-600 mb-1">Failed Tests:</div>
                        <ul class="text-sm text-red-700 space-y-1">
                            {% for test in detail.failed_tests_list %}
                            <li class="font-mono text-xs bg-red-100 px-2 py-1 rounded">{{ test }}</li>
                            {% endfor %}
                        </ul>
                    </div>
                    {% endif %}
                    {% if detail.error_tests_list %}
                    <div>
                        <div class="text-sm font-medium text-orange-600 mb-1">Error Tests:</div>
                        <ul class="text-sm text-orange-700 space-y-1">
                            {% for test in detail.error_tests_list %}
                            <li class="font-mono text-xs bg-orange-100 px-2 py-1 rounded">{{ test }}</li>
                            {% endfor %}
                        </ul>
                    </div>
                    {% endif %}
                </div>
                {% endif %}

                <!-- Error Details -->
                {% if detail.error_details %}
                <details class="mt-3">
                    <summary class="text-sm text-red-600 cursor-pointer hover:underline">View Error Details</summary>
                    <pre class="mt-2 p-3 bg-gray-900 text-gray-100 text-xs rounded overflow-x-auto">{{ detail.error_details }}</pre>
                </details>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Apps Tested -->
    <div class="card p-4">
        <h3 class="font-medium mb-2">Apps Tested</h3>
        <div class="flex flex-wrap gap-2">
            {% for app in test_run.apps_list %}
            <code class="text-xs bg-surface px-2 py-1 rounded">{{ app }}</code>
            {% endfor %}
        </div>
    </div>
</div>

</div>
{% endblock %}
