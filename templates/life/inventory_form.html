{% extends "base.html" %}

{% block title %}{% if object %}Edit Item{% else %}Add Item{% endif %} - Inventory{% endblock %}

{% block content %}
<div class="container">
    <nav class="breadcrumb mb-4">
        <a href="{% url 'life:home' %}">Life</a>
        <span>/</span>
        <a href="{% url 'life:inventory_list' %}">Inventory</a>
        <span>/</span>
        <span>{% if object %}Edit{% else %}Add{% endif %}</span>
    </nav>

    <div class="form-page">
        <div class="form-header">
            <h1 class="page-title">{% if object %}Edit Item{% else %}Add to Inventory{% endif %}</h1>
            <p class="page-subtitle">Document your belongings for insurance and peace of mind</p>
        </div>

        {% if not object %}
        <!-- Barcode Scanner Section (only for new items) -->
        <div class="scan-section">
            <div class="scan-header">
                <span class="scan-icon">ðŸ“·</span>
                <div class="scan-info">
                    <strong>Scan Product Barcode</strong>
                    <span class="scan-hint">Quickly fill in product details by scanning a barcode</span>
                </div>
            </div>
            <button type="button" id="startBarcodeScanner" class="btn btn-outline">
                <span class="btn-icon">ðŸ“±</span>
                Scan Barcode
            </button>
            {% if source == 'barcode_scan' and barcode_from_scan %}
            <div class="scan-success">
                <span class="success-icon">âœ“</span>
                Form pre-filled from barcode: {{ barcode_from_scan }}
            </div>
            {% endif %}
        </div>

        <!-- Barcode Scanner Modal -->
        <div id="barcodeScannerModal" class="scanner-modal" style="display: none;">
            <div class="scanner-modal-content">
                <div class="scanner-header">
                    <h3>Scan Product Barcode</h3>
                    <button type="button" id="closeBarcodeScanner" class="close-btn">&times;</button>
                </div>
                <div class="scanner-body">
                    <div id="scannerPreview" class="scanner-preview">
                        <video id="barcodeVideo" playsinline></video>
                        <div class="scanner-overlay">
                            <div class="scanner-target"></div>
                        </div>
                    </div>
                    <div id="scannerStatus" class="scanner-status">
                        Point your camera at a barcode
                    </div>
                    <div id="scannerResult" class="scanner-result" style="display: none;">
                        <div class="result-content">
                            <span class="result-label">Barcode detected:</span>
                            <span id="detectedBarcode" class="result-barcode"></span>
                        </div>
                        <div class="result-actions">
                            <button type="button" id="lookupBarcode" class="btn btn-primary btn-sm">Look Up Product</button>
                            <button type="button" id="rescanBarcode" class="btn btn-outline btn-sm">Scan Again</button>
                        </div>
                    </div>
                    <div id="lookupProgress" class="lookup-progress" style="display: none;">
                        <div class="spinner"></div>
                        <span>Looking up product...</span>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <form method="post" enctype="multipart/form-data" class="life-form">
            {% csrf_token %}
            
            <div class="form-section">
                <div class="form-group">
                    <label for="id_name" class="form-label">Item Name</label>
                    <input type="text" name="name" id="id_name" class="form-input" 
                           value="{{ form.name.value|default:'' }}" required
                           placeholder="e.g., Samsung 65 inch TV">
                </div>
                
                <div class="form-group">
                    <label for="id_description" class="form-label">Description</label>
                    <textarea name="description" id="id_description" class="form-textarea" rows="2"
                              placeholder="Additional details about this item...">{{ form.description.value|default:'' }}</textarea>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="id_category" class="form-label">Category</label>
                        <input type="text" name="category" id="id_category" class="form-input"
                               value="{{ form.category.value|default:'' }}" required
                               placeholder="e.g., Electronics"
                               list="category-list">
                        <datalist id="category-list">
                            <option value="Electronics">
                            <option value="Furniture">
                            <option value="Appliances">
                            <option value="Jewelry">
                            <option value="Clothing">
                            <option value="Tools">
                            <option value="Sports Equipment">
                            <option value="Musical Instruments">
                            <option value="Art">
                            <option value="Collectibles">
                        </datalist>
                    </div>
                    
                    <div class="form-group">
                        <label for="id_location" class="form-label">Location in Home</label>
                        <input type="text" name="location" id="id_location" class="form-input"
                               value="{{ form.location.value|default:'' }}"
                               placeholder="e.g., Living Room"
                               list="location-list">
                        <datalist id="location-list">
                            <option value="Living Room">
                            <option value="Bedroom">
                            <option value="Kitchen">
                            <option value="Garage">
                            <option value="Office">
                            <option value="Basement">
                            <option value="Attic">
                        </datalist>
                    </div>
                </div>
            </div>
            
            <div class="form-section">
                <h2 class="form-section-title">Value & Purchase Info</h2>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="id_purchase_date" class="form-label">Purchase Date</label>
                        <input type="date" name="purchase_date" id="id_purchase_date" class="form-input"
                               value="{{ form.purchase_date.value|date:'Y-m-d'|default:'' }}">
                    </div>
                    
                    <div class="form-group">
                        <label for="id_purchase_price" class="form-label">Purchase Price ($)</label>
                        <input type="number" name="purchase_price" id="id_purchase_price" class="form-input"
                               value="{{ form.purchase_price.value|default:'' }}"
                               step="0.01" min="0" placeholder="0.00">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="id_estimated_value" class="form-label">Current Estimated Value ($)</label>
                        <input type="number" name="estimated_value" id="id_estimated_value" class="form-input"
                               value="{{ form.estimated_value.value|default:'' }}"
                               step="0.01" min="0" placeholder="0.00">
                        <p class="form-help">What would it cost to replace today?</p>
                    </div>
                    
                    <div class="form-group">
                        <label for="id_condition" class="form-label">Condition</label>
                        <select name="condition" id="id_condition" class="form-select">
                            <option value="new" {% if form.condition.value == 'new' %}selected{% endif %}>New</option>
                            <option value="excellent" {% if form.condition.value == 'excellent' %}selected{% endif %}>Excellent</option>
                            <option value="good" {% if form.condition.value == 'good' or not form.condition.value %}selected{% endif %}>Good</option>
                            <option value="fair" {% if form.condition.value == 'fair' %}selected{% endif %}>Fair</option>
                            <option value="poor" {% if form.condition.value == 'poor' %}selected{% endif %}>Poor</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <div class="form-section">
                <h2 class="form-section-title">Product Details</h2>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="id_brand" class="form-label">Brand</label>
                        <input type="text" name="brand" id="id_brand" class="form-input"
                               value="{{ form.brand.value|default:'' }}"
                               placeholder="e.g., Samsung">
                    </div>
                    
                    <div class="form-group">
                        <label for="id_model_number" class="form-label">Model Number</label>
                        <input type="text" name="model_number" id="id_model_number" class="form-input"
                               value="{{ form.model_number.value|default:'' }}">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="id_serial_number" class="form-label">Serial Number</label>
                    <input type="text" name="serial_number" id="id_serial_number" class="form-input"
                           value="{{ form.serial_number.value|default:'' }}">
                </div>
            </div>
            
            <div class="form-section">
                <h2 class="form-section-title">Warranty</h2>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="id_warranty_expiration" class="form-label">Warranty Expiration</label>
                        <input type="date" name="warranty_expiration" id="id_warranty_expiration" class="form-input"
                               value="{{ form.warranty_expiration.value|date:'Y-m-d'|default:'' }}">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="id_warranty_info" class="form-label">Warranty Details</label>
                    <textarea name="warranty_info" id="id_warranty_info" class="form-textarea" rows="2"
                              placeholder="Coverage details, provider contact, etc.">{{ form.warranty_info.value|default:'' }}</textarea>
                </div>
            </div>
            
            <div class="form-section">
                <div class="form-group">
                    <label for="id_notes" class="form-label">Notes</label>
                    <textarea name="notes" id="id_notes" class="form-textarea" rows="2"
                              placeholder="Any other information...">{{ form.notes.value|default:'' }}</textarea>
                </div>
            </div>
            
            <div class="form-actions">
                <button type="submit" class="btn btn-primary">
                    {% if object %}Save Changes{% else %}Add Item{% endif %}
                </button>
                <a href="{% url 'life:inventory_list' %}" class="btn btn-ghost">Cancel</a>
            </div>
        </form>
    </div>
</div>

<style>
.breadcrumb {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    font-size: var(--font-size-sm);
    color: var(--color-text-muted);
}

.breadcrumb a {
    color: var(--color-accent);
}

.form-page {
    max-width: 700px;
}

.form-section {
    background: var(--color-background);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-lg);
    padding: var(--space-6);
    margin-bottom: var(--space-6);
}

.form-section-title {
    font-size: var(--font-size-base);
    margin: 0 0 var(--space-4) 0;
    padding-bottom: var(--space-3);
    border-bottom: 1px solid var(--color-border);
}

.form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: var(--space-4);
}

@media (max-width: 640px) {
    .form-row {
        grid-template-columns: 1fr;
    }
}

.form-actions {
    display: flex;
    gap: var(--space-3);
}

/* Barcode Scanner Styles */
.scan-section {
    background: linear-gradient(135deg, var(--color-accent-light) 0%, var(--color-background) 100%);
    border: 2px dashed var(--color-accent);
    border-radius: var(--radius-lg);
    padding: var(--space-4);
    margin-bottom: var(--space-6);
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: var(--space-4);
}

.scan-header {
    display: flex;
    align-items: center;
    gap: var(--space-3);
}

.scan-icon {
    font-size: 2rem;
}

.scan-info {
    display: flex;
    flex-direction: column;
    gap: var(--space-1);
}

.scan-hint {
    font-size: var(--font-size-sm);
    color: var(--color-text-muted);
}

.scan-success {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    color: var(--color-success);
    font-size: var(--font-size-sm);
    margin-top: var(--space-2);
}

.success-icon {
    background: var(--color-success);
    color: white;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
}

/* Scanner Modal */
.scanner-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    z-index: 1000;
    display: flex;
    align-items: center;
    justify-content: center;
}

.scanner-modal-content {
    background: var(--color-background);
    border-radius: var(--radius-lg);
    max-width: 500px;
    width: 90%;
    max-height: 90vh;
    overflow: hidden;
}

.scanner-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--space-4);
    border-bottom: 1px solid var(--color-border);
}

.scanner-header h3 {
    margin: 0;
}

.close-btn {
    background: none;
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
    color: var(--color-text-muted);
}

.scanner-body {
    padding: var(--space-4);
}

.scanner-preview {
    position: relative;
    width: 100%;
    aspect-ratio: 4/3;
    background: #000;
    border-radius: var(--radius);
    overflow: hidden;
}

.scanner-preview video {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.scanner-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
}

.scanner-target {
    width: 70%;
    height: 30%;
    border: 2px solid var(--color-accent);
    border-radius: var(--radius);
    box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.5);
}

.scanner-status {
    text-align: center;
    padding: var(--space-3);
    color: var(--color-text-muted);
}

.scanner-result {
    background: var(--color-success-light);
    border: 1px solid var(--color-success);
    border-radius: var(--radius);
    padding: var(--space-3);
    margin-top: var(--space-3);
}

.result-content {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    margin-bottom: var(--space-3);
}

.result-barcode {
    font-family: monospace;
    font-weight: bold;
    font-size: var(--font-size-lg);
}

.result-actions {
    display: flex;
    gap: var(--space-2);
}

.lookup-progress {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-2);
    padding: var(--space-4);
    color: var(--color-text-muted);
}

.spinner {
    width: 20px;
    height: 20px;
    border: 2px solid var(--color-border);
    border-top-color: var(--color-accent);
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

@media (max-width: 640px) {
    .scan-section {
        flex-direction: column;
        align-items: stretch;
        text-align: center;
    }

    .scan-header {
        flex-direction: column;
    }
}
</style>

{% if not object %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const startBtn = document.getElementById('startBarcodeScanner');
    const modal = document.getElementById('barcodeScannerModal');
    const closeBtn = document.getElementById('closeBarcodeScanner');
    const video = document.getElementById('barcodeVideo');
    const statusEl = document.getElementById('scannerStatus');
    const resultEl = document.getElementById('scannerResult');
    const detectedBarcodeEl = document.getElementById('detectedBarcode');
    const lookupBtn = document.getElementById('lookupBarcode');
    const rescanBtn = document.getElementById('rescanBarcode');
    const progressEl = document.getElementById('lookupProgress');

    let stream = null;
    let barcodeDetector = null;
    let detectedBarcode = '';
    let isScanning = false;

    // Check if BarcodeDetector is available
    const hasBarcodeDetector = 'BarcodeDetector' in window;

    startBtn.addEventListener('click', openScanner);
    closeBtn.addEventListener('click', closeScanner);
    lookupBtn.addEventListener('click', lookupProduct);
    rescanBtn.addEventListener('click', resetScanner);

    // Close modal when clicking outside
    modal.addEventListener('click', function(e) {
        if (e.target === modal) {
            closeScanner();
        }
    });

    async function openScanner() {
        modal.style.display = 'flex';
        resultEl.style.display = 'none';
        progressEl.style.display = 'none';
        statusEl.textContent = 'Starting camera...';

        try {
            stream = await navigator.mediaDevices.getUserMedia({
                video: {
                    facingMode: 'environment',
                    width: { ideal: 1280 },
                    height: { ideal: 720 }
                }
            });
            video.srcObject = stream;
            await video.play();

            if (hasBarcodeDetector) {
                barcodeDetector = new BarcodeDetector({
                    formats: ['ean_13', 'ean_8', 'upc_a', 'upc_e', 'code_128', 'code_39']
                });
                statusEl.textContent = 'Point your camera at a barcode';
                startDetection();
            } else {
                statusEl.textContent = 'Barcode detection not supported. Enter barcode manually.';
                showManualEntry();
            }
        } catch (err) {
            console.error('Camera error:', err);
            statusEl.textContent = 'Could not access camera. Please check permissions.';
        }
    }

    function closeScanner() {
        modal.style.display = 'none';
        isScanning = false;
        if (stream) {
            stream.getTracks().forEach(track => track.stop());
            stream = null;
        }
    }

    async function startDetection() {
        isScanning = true;
        while (isScanning && stream) {
            try {
                const barcodes = await barcodeDetector.detect(video);
                if (barcodes.length > 0) {
                    detectedBarcode = barcodes[0].rawValue;
                    showDetectedBarcode(detectedBarcode);
                    isScanning = false;

                    // Vibrate on detection (if supported)
                    if ('vibrate' in navigator) {
                        navigator.vibrate(100);
                    }
                }
            } catch (err) {
                console.error('Detection error:', err);
            }
            await new Promise(r => setTimeout(r, 200)); // Check every 200ms
        }
    }

    function showDetectedBarcode(barcode) {
        detectedBarcodeEl.textContent = barcode;
        resultEl.style.display = 'block';
        statusEl.style.display = 'none';
    }

    function resetScanner() {
        resultEl.style.display = 'none';
        statusEl.style.display = 'block';
        statusEl.textContent = 'Point your camera at a barcode';
        detectedBarcode = '';
        startDetection();
    }

    function showManualEntry() {
        // Create manual entry input
        const manualInput = document.createElement('div');
        manualInput.innerHTML = `
            <div style="margin-top: var(--space-3);">
                <input type="text" id="manualBarcode" class="form-input"
                       placeholder="Enter barcode number" pattern="[0-9]*">
                <button type="button" id="submitManualBarcode" class="btn btn-primary btn-sm"
                        style="margin-top: var(--space-2);">Look Up</button>
            </div>
        `;
        statusEl.parentNode.insertBefore(manualInput, statusEl.nextSibling);

        document.getElementById('submitManualBarcode').addEventListener('click', function() {
            detectedBarcode = document.getElementById('manualBarcode').value;
            if (detectedBarcode) {
                lookupProduct();
            }
        });
    }

    async function lookupProduct() {
        if (!detectedBarcode) return;

        resultEl.style.display = 'none';
        progressEl.style.display = 'flex';

        try {
            const response = await fetch('{% url "scan:product_lookup" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({ barcode: detectedBarcode })
            });

            const data = await response.json();

            if (data.found && data.inventory_url) {
                // Redirect to pre-filled form
                window.location.href = data.inventory_url;
            } else {
                // Show not found message but pre-fill barcode info
                progressEl.style.display = 'none';
                alert('Product not found in database. You can still fill in the details manually.');
                closeScanner();
            }
        } catch (err) {
            console.error('Lookup error:', err);
            progressEl.style.display = 'none';
            alert('Error looking up product. Please try again.');
            resetScanner();
        }
    }
});
</script>
{% endif %}
{% endblock %}
