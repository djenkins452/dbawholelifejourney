{% extends "base.html" %}
{% load static %}

{% block title %}Dashboard - Whole Life Journey{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/dashboard.css' %}">
{% endblock %}

{% block content %}
<div class="container">
    <!-- Header -->
    <header class="dashboard-header">
        <div class="greeting">
            <h1>{{ greeting }}, {{ user.get_short_name }}.</h1>
            <p class="current-date">{{ current_date|date:"l, F j, Y" }}</p>
        </div>
        
        <!-- Quick Stats -->
        <div class="quick-stats">
            {% if quick_stats.journal_streak > 0 %}
            <a href="{% url 'journal:entry_list' %}" class="quick-stat quick-stat-link" title="Journal Streak - Click to view entries">
                <span class="stat-icon">ğŸ”¥</span>
                <span class="stat-value">{{ quick_stats.journal_streak }}</span>
            </a>
            {% endif %}
            {% if quick_stats.tasks_today > 0 %}
            <a href="{% url 'life:task_list' %}" class="quick-stat quick-stat-link" title="Tasks Today - Click to view all tasks">
                <span class="stat-icon">âœ“</span>
                <span class="stat-value">{{ quick_stats.tasks_today }}</span>
            </a>
            {% endif %}
            {% if faith_enabled and quick_stats.active_prayers > 0 %}
            <a href="{% url 'faith:prayer_list' %}" class="quick-stat quick-stat-link" title="Active Prayers - Click to view prayer list">
                <span class="stat-icon">ğŸ™</span>
                <span class="stat-value">{{ quick_stats.active_prayers }}</span>
            </a>
            {% endif %}
            {% if health_enabled and quick_stats.medicine_doses_today > 0 %}
            <a href="{% url 'health:medicine_home' %}" class="quick-stat quick-stat-link" title="Medicines: {{ quick_stats.medicine_doses_taken }}/{{ quick_stats.medicine_doses_today }} taken - Click to open tracker">
                <span class="stat-icon">ğŸ’Š</span>
                <span class="stat-value">{{ quick_stats.medicine_doses_taken }}/{{ quick_stats.medicine_doses_today }}</span>
            </a>
            {% endif %}
            {% if health_enabled and quick_stats.workouts_week > 0 %}
            <a href="{% url 'health:workout_list' %}" class="quick-stat quick-stat-link" title="Workouts This Week - Click to view all workouts">
                <span class="stat-icon">ğŸ’ª</span>
                <span class="stat-value">{{ quick_stats.workouts_week }}</span>
            </a>
            {% endif %}
        </div>
    </header>

    <!-- Memory Verse (if faith enabled and user has one set) -->
    {% if faith_enabled and user_data.memory_verse %}
    <section class="memory-verse-section">
        <div class="memory-verse-card">
            <div class="memory-verse-header">
                <div class="memory-verse-badge">
                    <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor">
                        <path d="M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2Z"/>
                    </svg>
                    Memory Verse
                </div>
                <a href="{% url 'faith:scripture_list' %}" class="memory-verse-link" title="Manage Scripture">
                    <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9 18l6-6-6-6"/>
                    </svg>
                </a>
            </div>
            <blockquote class="memory-verse-text">{{ user_data.memory_verse.text }}</blockquote>
            <p class="memory-verse-reference">â€” {{ user_data.memory_verse.reference }}</p>
        </div>
    </section>
    {% endif %}

    {% if ai_enabled and ai_insights %}
    <!-- AI Insight Card (Main Focus) -->
    <section class="ai-insight-hero">
        <div class="ai-insight-content">
            <div class="ai-badge">
                <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 2a10 10 0 1 0 10 10A10 10 0 0 0 12 2zm0 18a8 8 0 1 1 8-8 8 8 0 0 1-8 8z"/>
                    <path d="M12 6v6l4 2"/>
                </svg>
                Today's Insight
            </div>
            <p class="ai-insight-text">{{ ai_insights.daily_insight }}</p>
        </div>
    </section>
    
    <!-- Celebrations (if any) -->
    {% if ai_insights.celebrations %}
    <section class="celebrations-section">
        <div class="celebrations-grid">
            {% for celebration in ai_insights.celebrations %}
            {% if celebration.type == 'streak' %}
            <a href="{% url 'journal:entry_list' %}" class="celebration-card celebration-link celebration-{{ celebration.type }}" title="Click to view journal entries">
            {% elif celebration.type == 'tasks' %}
            <a href="{% url 'life:task_list' %}" class="celebration-card celebration-link celebration-{{ celebration.type }}" title="Click to view tasks">
            {% elif celebration.type == 'medicine' %}
            <a href="{% url 'health:medicine_home' %}" class="celebration-card celebration-link celebration-{{ celebration.type }}" title="Click to view medicines">
            {% elif celebration.type == 'workout' %}
            <a href="{% url 'health:workout_list' %}" class="celebration-card celebration-link celebration-{{ celebration.type }}" title="Click to view workouts">
            {% elif celebration.type == 'faith' %}
            <a href="{% url 'faith:prayer_list' %}" class="celebration-card celebration-link celebration-{{ celebration.type }}" title="Click to view prayers">
            {% elif celebration.type == 'health' %}
            <a href="{% url 'health:weight_list' %}" class="celebration-card celebration-link celebration-{{ celebration.type }}" title="Click to view weight history">
            {% elif celebration.type == 'scan' %}
            <a href="{% url 'scan:home' %}" class="celebration-card celebration-link celebration-{{ celebration.type }}" title="Click to open camera scan">
            {% else %}
            <div class="celebration-card celebration-{{ celebration.type }}">
            {% endif %}
                <div class="celebration-title">{{ celebration.title }}</div>
                <div class="celebration-detail">{{ celebration.detail }}</div>
            {% if celebration.type == 'streak' or celebration.type == 'tasks' or celebration.type == 'medicine' or celebration.type == 'workout' or celebration.type == 'faith' or celebration.type == 'health' or celebration.type == 'scan' %}
            </a>
            {% else %}
            </div>
            {% endif %}
            {% endfor %}
        </div>
    </section>
    {% endif %}
    
    <!-- Accountability Nudges (if any) -->
    {% if ai_insights.nudges %}
    <section class="nudges-section">
        {% for nudge in ai_insights.nudges %}
        <div class="nudge-card nudge-{{ nudge.type }}">
            {% if nudge.type == 'journal' %}
            <div class="nudge-content">
                <span class="nudge-icon">ğŸ“</span>
                <div class="nudge-text">
                    <span class="nudge-message">It's been {{ nudge.days }} days since you journaled.</span>
                </div>
            </div>
            <a href="{{ nudge.action_url }}" class="btn btn-primary btn-sm">{{ nudge.action_text }}</a>
            {% elif nudge.type == 'tasks' %}
            <div class="nudge-content">
                <span class="nudge-icon">âš ï¸</span>
                <div class="nudge-text">
                    <span class="nudge-message">You have {{ nudge.count }} overdue task{{ nudge.count|pluralize }}.</span>
                </div>
            </div>
            <a href="{{ nudge.action_url }}" class="btn btn-secondary btn-sm">{{ nudge.action_text }}</a>
            {% elif nudge.type == 'goals' %}
            <div class="nudge-content">
                <span class="nudge-icon">ğŸ¯</span>
                <div class="nudge-text">
                    <span class="nudge-message">No active goals set. What are you working toward?</span>
                </div>
            </div>
            <a href="{{ nudge.action_url }}" class="btn btn-secondary btn-sm">{{ nudge.action_text }}</a>
            {% elif nudge.type == 'medicine' %}
            <div class="nudge-content">
                <span class="nudge-icon">ğŸ’Š</span>
                <div class="nudge-text">
                    <span class="nudge-message">{{ nudge.count }} medicine dose{{ nudge.count|pluralize }} pending today.</span>
                </div>
            </div>
            <a href="{{ nudge.action_url }}" class="btn btn-primary btn-sm">{{ nudge.action_text }}</a>
            {% elif nudge.type == 'medicine_adherence' %}
            <div class="nudge-content">
                <span class="nudge-icon">ğŸ“‰</span>
                <div class="nudge-text">
                    <span class="nudge-message">Medicine adherence at {{ nudge.adherence }}% this week.</span>
                </div>
            </div>
            <a href="{{ nudge.action_url }}" class="btn btn-secondary btn-sm">{{ nudge.action_text }}</a>
            {% elif nudge.type == 'refill_requested' %}
            <div class="nudge-content">
                <span class="nudge-icon">ğŸ“‹</span>
                <div class="nudge-text">
                    <span class="nudge-message">Refill requested for {{ nudge.count }} medicine{{ nudge.count|pluralize }}.</span>
                </div>
            </div>
            <a href="{{ nudge.action_url }}" class="btn btn-secondary btn-sm">{{ nudge.action_text }}</a>
            {% elif nudge.type == 'refill' %}
            <div class="nudge-content">
                <span class="nudge-icon">ğŸ””</span>
                <div class="nudge-text">
                    <span class="nudge-message">{{ nudge.count }} medicine{{ nudge.count|pluralize }} need{{ nudge.count|pluralize:"s," }} refill.</span>
                </div>
            </div>
            <a href="{{ nudge.action_url }}" class="btn btn-secondary btn-sm">{{ nudge.action_text }}</a>
            {% elif nudge.type == 'workout' %}
            <div class="nudge-content">
                <span class="nudge-icon">ğŸ‹ï¸</span>
                <div class="nudge-text">
                    <span class="nudge-message">It's been {{ nudge.days }} days since your last workout.</span>
                </div>
            </div>
            <a href="{{ nudge.action_url }}" class="btn btn-secondary btn-sm">{{ nudge.action_text }}</a>
            {% endif %}
        </div>
        {% endfor %}
    </section>
    {% endif %}
    
    <!-- Weekly Summary (if available) -->
    {% if ai_insights.weekly_summary %}
    <section class="weekly-summary-section">
        <div class="summary-header">
            <h3>
                <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                    <line x1="16" y1="2" x2="16" y2="6"/>
                    <line x1="8" y1="2" x2="8" y2="6"/>
                    <line x1="3" y1="10" x2="21" y2="10"/>
                </svg>
                Your Week
            </h3>
        </div>
        <p class="summary-text">{{ ai_insights.weekly_summary }}</p>
    </section>
    {% endif %}
    
    {% else %}
    <!-- Fallback: Daily Encouragement (when AI disabled) -->
    <section class="encouragement-card">
        {% if encouragement %}
            <p class="encouragement-message">{{ encouragement.message }}</p>
            {% if encouragement.scripture_reference and faith_enabled %}
                <p class="scripture-reference">â€” {{ encouragement.scripture_reference }}</p>
            {% endif %}
        {% else %}
            <p class="encouragement-message">
                Take a moment to breathe. You're exactly where you need to be.
            </p>
        {% endif %}
    </section>
    {% endif %}

    <!-- Current Fast Widget (if active) -->
    {% if health_enabled and user_data.active_fast %}
    <section class="current-fast-section">
        <div class="fast-card">
            <div class="fast-header">
                <div class="fast-icon-wrapper">
                    <span class="fast-icon">ğŸ•</span>
                </div>
                <div class="fast-title-area">
                    <span class="fast-badge">Fasting Now</span>
                    <span class="fast-type">{{ user_data.active_fast.get_fasting_type_display }}</span>
                </div>
            </div>
            <div class="fast-timer-container">
                <div class="fast-timer"
                     id="fast-timer"
                     data-started="{{ user_data.active_fast.started_at|date:'c' }}"
                     data-target="{{ user_data.active_fast.target_hours|default:'0' }}">
                    <span class="timer-value" id="timer-hours">--</span>
                    <span class="timer-separator">:</span>
                    <span class="timer-value" id="timer-minutes">--</span>
                    <span class="timer-separator">:</span>
                    <span class="timer-value" id="timer-seconds">--</span>
                </div>
                <span class="timer-label">hours : minutes : seconds</span>
            </div>
            {% if user_data.active_fast.target_hours %}
            <div class="fast-progress-container">
                <div class="fast-progress-bar">
                    <div class="fast-progress-fill" id="fast-progress" style="width: {{ user_data.active_fast.progress_percent|floatformat:0 }}%"></div>
                </div>
                <div class="fast-progress-labels">
                    <span class="progress-current" id="progress-hours">{{ user_data.active_fast.duration_display }}</span>
                    <span class="progress-target">Target: {{ user_data.active_fast.target_hours }}h</span>
                </div>
            </div>
            {% endif %}
            <div class="fast-actions">
                <form method="post" action="{% url 'health:fasting_end' user_data.active_fast.pk %}" class="inline-form"
                      onsubmit="return confirm('End your fast now?');">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-primary btn-sm fast-end-btn">End Fast</button>
                </form>
                <a href="{% url 'health:fasting_list' %}" class="btn btn-secondary btn-sm">View Details</a>
            </div>
        </div>
    </section>
    {% endif %}

    <!-- Quick Actions Grid -->
    <section class="quick-actions-section">
        <h2 class="section-title">Quick Actions</h2>
        <div class="quick-actions-grid">
            {% if journal_enabled %}
            <a href="{% url 'journal:entry_create' %}" class="quick-action-card">
                <span class="action-icon">ğŸ“</span>
                <span class="action-label">New Journal Entry</span>
            </a>
            {% endif %}
            
            {% if faith_enabled %}
            <a href="{% url 'faith:prayer_create' %}" class="quick-action-card">
                <span class="action-icon">ğŸ™</span>
                <span class="action-label">Add Prayer</span>
            </a>
            {% endif %}
            
            {% if health_enabled %}
            <a href="{% url 'health:weight_create' %}" class="quick-action-card">
                <span class="action-icon">âš–ï¸</span>
                <span class="action-label">Log Weight</span>
            </a>
            {% if not user_data.fasting_active %}
            <a href="{% url 'health:fasting_start' %}" class="quick-action-card">
                <span class="action-icon">ğŸ•</span>
                <span class="action-label">Start Fast</span>
            </a>
            {% else %}
            <a href="{% url 'health:fasting_list' %}" class="quick-action-card action-active">
                <span class="action-icon">ğŸ•</span>
                <span class="action-label">Fasting Now</span>
            </a>
            {% endif %}
            {% endif %}
            
            {% if life_enabled %}
            <a href="{% url 'life:task_create' %}" class="quick-action-card">
                <span class="action-icon">âœ“</span>
                <span class="action-label">Add Task</span>
            </a>
            {% endif %}
            
            {% if purpose_enabled %}
            <a href="{% url 'purpose:goal_create' %}" class="quick-action-card">
                <span class="action-icon">ğŸ¯</span>
                <span class="action-label">Add Goal</span>
            </a>
            {% endif %}

            {% if ai_enabled %}
            <a href="{% url 'scan:home' %}" class="quick-action-card">
                <span class="action-icon">ğŸ“·</span>
                <span class="action-label">Scan</span>
            </a>
            {% endif %}
        </div>
    </section>
    
    <!-- Module Navigation Cards -->
    <section class="modules-section">
        <h2 class="section-title">Your Modules</h2>
        <div class="modules-grid">
            {% if journal_enabled %}
            <a href="{% url 'journal:entry_list' %}" class="module-nav-card">
                <div class="module-icon">ğŸ“</div>
                <div class="module-info">
                    <h3>Journal</h3>
                    <p>{{ user_data.journal_total|default:0 }} entries</p>
                </div>
                <svg class="module-arrow" viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M9 18l6-6-6-6"/>
                </svg>
            </a>
            {% endif %}
            
            {% if faith_enabled %}
            <a href="{% url 'faith:home' %}" class="module-nav-card">
                <div class="module-icon">âœï¸</div>
                <div class="module-info">
                    <h3>Faith</h3>
                    <p>{{ user_data.active_prayers|default:0 }} active prayers</p>
                </div>
                <svg class="module-arrow" viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M9 18l6-6-6-6"/>
                </svg>
            </a>
            {% endif %}
            
            {% if health_enabled %}
            <a href="{% url 'health:home' %}" class="module-nav-card {% if user_data.weight_progress or user_data.nutrition_progress %}has-goals{% endif %}">
                <div class="module-icon">â¤ï¸</div>
                <div class="module-info">
                    <h3>Health</h3>
                    <p>{% if user_data.latest_weight %}{{ user_data.latest_weight.value }} {{ user_data.latest_weight.unit }}{% else %}Start tracking{% endif %}</p>
                    {% if user_data.weight_progress %}
                    <div class="goal-progress-mini">
                        <div class="progress-bar-mini">
                            <div class="progress-fill-mini" style="width: {{ user_data.weight_progress.progress_percent|floatformat:0 }}%"></div>
                        </div>
                        <span class="progress-label-mini">
                            {% if user_data.weight_progress.remaining > 0 %}
                                {{ user_data.weight_progress.remaining|floatformat:1 }} {{ user_data.weight_progress.unit }} to go
                            {% elif user_data.weight_progress.remaining < 0 %}
                                {{ user_data.weight_progress.remaining|floatformat:1|slice:"1:" }} {{ user_data.weight_progress.unit }} to gain
                            {% else %}
                                Goal reached!
                            {% endif %}
                        </span>
                    </div>
                    {% endif %}
                </div>
                <svg class="module-arrow" viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M9 18l6-6-6-6"/>
                </svg>
            </a>
            {% endif %}
            
            {% if life_enabled %}
            <a href="{% url 'life:home' %}" class="module-nav-card">
                <div class="module-icon">ğŸ </div>
                <div class="module-info">
                    <h3>Life</h3>
                    <p>{{ user_data.incomplete_tasks|default:0 }} tasks</p>
                </div>
                <svg class="module-arrow" viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M9 18l6-6-6-6"/>
                </svg>
            </a>
            {% endif %}
            
            {% if purpose_enabled %}
            <a href="{% url 'purpose:home' %}" class="module-nav-card">
                <div class="module-icon">ğŸ§­</div>
                <div class="module-info">
                    <h3>Purpose</h3>
                    <p>{% if user_data.annual_direction %}{{ user_data.word_of_year|default:"Direction set" }}{% else %}Set your direction{% endif %}</p>
                </div>
                <svg class="module-arrow" viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M9 18l6-6-6-6"/>
                </svg>
            </a>
            {% endif %}
        </div>
    </section>

    <!-- Today's Medicine Schedule (if health enabled and has medicines) -->
    {% if health_enabled and user_data.todays_medicine_schedule %}
    <section class="medicine-schedule-section">
        <div class="section-header">
            <h2 class="section-title">Today's Medicines</h2>
            <a href="{% url 'health:medicine_home' %}" class="section-link">Open Tracker</a>
        </div>
        <div class="medicine-schedule-list">
            {% for item in user_data.todays_medicine_schedule %}
            <div class="medicine-schedule-item {% if item.taken %}taken{% elif item.missed %}missed{% elif item.skipped %}skipped{% endif %}">
                <div class="medicine-time">{{ item.schedule.scheduled_time|time:"g:i A" }}</div>
                <div class="medicine-info">
                    <span class="medicine-name">{{ item.medicine.name }}</span>
                    <span class="medicine-dose">{{ item.medicine.dose }}</span>
                </div>
                <div class="medicine-status">
                    {% if item.taken %}
                    <span class="status-badge status-taken">âœ“ Taken</span>
                    {% elif item.missed %}
                    <span class="status-badge status-missed">âœ— Missed</span>
                    {% elif item.skipped %}
                    <span class="status-badge status-skipped">â€” Skipped</span>
                    {% else %}
                    <span class="status-badge status-pending">Pending</span>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
    </section>
    {% endif %}

    <!-- Today's Nutrition Progress (if health enabled and has nutrition goals) -->
    {% if health_enabled and user_data.nutrition_progress %}
    <section class="nutrition-progress-section">
        <div class="section-header">
            <h2 class="section-title">Today's Nutrition</h2>
            <a href="{% url 'health:food_entry_create' %}" class="section-link">Log Food</a>
        </div>
        <div class="nutrition-progress-card">
            <div class="calorie-summary">
                <div class="calorie-value">{{ user_data.nutrition_progress.calories.current|default:0 }}</div>
                <div class="calorie-goal">of {{ user_data.nutrition_progress.calories.goal }} calories</div>
                {% if user_data.nutrition_progress.calories.remaining > 0 %}
                <div class="calorie-remaining">{{ user_data.nutrition_progress.calories.remaining }} remaining</div>
                {% elif user_data.nutrition_progress.calories.remaining < 0 %}
                <div class="calorie-remaining" style="color: var(--color-error, #ef4444);">{{ user_data.nutrition_progress.calories.remaining|slice:"1:" }} over</div>
                {% else %}
                <div class="calorie-remaining">Goal reached!</div>
                {% endif %}
            </div>

            <div class="macro-progress-grid">
                <div class="macro-progress-item">
                    <div class="macro-progress-label">
                        <span>ğŸ¥©</span> Protein
                    </div>
                    <div class="macro-progress-bar">
                        <div class="macro-progress-fill protein" style="width: {{ user_data.nutrition_progress.protein.progress_percent|default:0|floatformat:0 }}%"></div>
                    </div>
                    <div class="macro-progress-value">
                        {{ user_data.nutrition_progress.protein.current_g|floatformat:0 }}g / {{ user_data.nutrition_progress.protein.goal_g|default:"-" }}g
                    </div>
                </div>

                <div class="macro-progress-item">
                    <div class="macro-progress-label">
                        <span>ğŸ</span> Carbs
                    </div>
                    <div class="macro-progress-bar">
                        <div class="macro-progress-fill carbs" style="width: {{ user_data.nutrition_progress.carbs.progress_percent|default:0|floatformat:0 }}%"></div>
                    </div>
                    <div class="macro-progress-value">
                        {{ user_data.nutrition_progress.carbs.current_g|floatformat:0 }}g / {{ user_data.nutrition_progress.carbs.goal_g|default:"-" }}g
                    </div>
                </div>

                <div class="macro-progress-item">
                    <div class="macro-progress-label">
                        <span>ğŸ¥‘</span> Fat
                    </div>
                    <div class="macro-progress-bar">
                        <div class="macro-progress-fill fat" style="width: {{ user_data.nutrition_progress.fat.progress_percent|default:0|floatformat:0 }}%"></div>
                    </div>
                    <div class="macro-progress-value">
                        {{ user_data.nutrition_progress.fat.current_g|floatformat:0 }}g / {{ user_data.nutrition_progress.fat.goal_g|default:"-" }}g
                    </div>
                </div>
            </div>
        </div>
    </section>
    {% endif %}

    <!-- Recent Workouts (if health enabled and has workouts) -->
    {% if health_enabled and user_data.recent_workouts %}
    <section class="recent-workouts-section">
        <div class="section-header">
            <h2 class="section-title">Recent Workouts</h2>
            <a href="{% url 'health:workout_list' %}" class="section-link">View All</a>
        </div>
        <div class="workouts-list">
            {% for workout in user_data.recent_workouts %}
            <a href="{% url 'health:workout_detail' workout.pk %}" class="workout-item">
                <div class="workout-date">
                    <span class="date-month">{{ workout.date|date:"M" }}</span>
                    <span class="date-day">{{ workout.date|date:"j" }}</span>
                </div>
                <div class="workout-info">
                    <span class="workout-name">{% if workout.name %}{{ workout.name }}{% else %}Workout{% endif %}</span>
                    <span class="workout-meta">
                        {{ workout.exercise_count }} exercise{{ workout.exercise_count|pluralize }}
                        {% if workout.duration_minutes %} â€¢ {{ workout.duration_minutes }} min{% endif %}
                    </span>
                </div>
            </a>
            {% endfor %}
        </div>
        {% if user_data.recent_prs %}
        <div class="recent-prs">
            <h3 class="subsection-title">Recent PRs</h3>
            {% for pr in user_data.recent_prs %}
            <div class="pr-item">
                <span class="pr-icon">ğŸ†</span>
                <span class="pr-exercise">{{ pr.exercise.name }}</span>
                <span class="pr-details">{{ pr.weight }}lbs Ã— {{ pr.reps }}</span>
                <span class="pr-date">{{ pr.achieved_date|date:"M j" }}</span>
            </div>
            {% endfor %}
        </div>
        {% endif %}
    </section>
    {% endif %}

    <!-- Upcoming Events (if any) -->
    {% if life_enabled and user_data.upcoming_events %}
    <section class="upcoming-section">
        <h2 class="section-title">Coming Up</h2>
        <div class="upcoming-list">
            {% for event in user_data.upcoming_events %}
            <div class="upcoming-item">
                <div class="upcoming-date">
                    <span class="date-month">{{ event.start_date|date:"M" }}</span>
                    <span class="date-day">{{ event.start_date|date:"j" }}</span>
                </div>
                <div class="upcoming-info">
                    <span class="upcoming-title">{{ event.title }}</span>
                    {% if event.start_time %}
                    <span class="upcoming-time">{{ event.start_time|time:"g:i A" }}</span>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
    </section>
    {% endif %}

    <!-- Upcoming Celebrations (Significant Events) -->
    {% if life_enabled and user_data.upcoming_significant_events %}
    <section class="celebrations-section">
        <div class="section-header-with-link">
            <h2 class="section-title">Upcoming Celebrations</h2>
            <a href="{% url 'life:significant_event_list' %}" class="section-link">View All</a>
        </div>
        <div class="celebrations-list">
            {% for event in user_data.upcoming_significant_events %}
            <a href="{{ event.get_absolute_url }}" class="celebration-item {% if event.days_until == 0 %}today{% elif event.days_until <= 7 %}soon{% endif %}">
                <span class="celebration-icon">
                    {% if event.event_type == 'birthday' %}ğŸ‚
                    {% elif event.event_type == 'anniversary' %}ğŸ’
                    {% elif event.event_type == 'memorial' %}ğŸ•¯ï¸
                    {% elif event.event_type == 'milestone' %}ğŸ†
                    {% elif event.event_type == 'holiday' %}ğŸ‰
                    {% else %}ğŸ“…{% endif %}
                </span>
                <div class="celebration-info">
                    <span class="celebration-title">{{ event.title }}</span>
                    {% if event.person_name %}
                    <span class="celebration-person">{{ event.person_name }}</span>
                    {% endif %}
                </div>
                <div class="celebration-countdown">
                    {% if event.days_until == 0 %}
                    <span class="countdown-badge today">Today!</span>
                    {% elif event.days_until == 1 %}
                    <span class="countdown-badge tomorrow">Tomorrow</span>
                    {% else %}
                    <span class="countdown-text">{{ event.days_until }} days</span>
                    {% endif %}
                    {% if event.years_display %}
                    <span class="years-badge">{{ event.years_display }}</span>
                    {% endif %}
                </div>
            </a>
            {% endfor %}
        </div>
    </section>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
{% if health_enabled and user_data.active_fast %}
<script>
// ==============================================================================
// File: dashboard fast timer (inline)
// Project: Whole Life Journey - Django 5.x Personal Wellness/Journaling App
// Description: Real-time updating timer for active fasting display on dashboard
// Owner: Danny Jenkins (dannyjenkins71@gmail.com)
// Created: 2025-12-29
// Last Updated: 2025-12-29
// ==============================================================================

(function() {
    'use strict';

    const timerEl = document.getElementById('fast-timer');
    if (!timerEl) return;

    const startedAt = new Date(timerEl.dataset.started);
    const targetHours = parseFloat(timerEl.dataset.target) || 0;

    const hoursEl = document.getElementById('timer-hours');
    const minutesEl = document.getElementById('timer-minutes');
    const secondsEl = document.getElementById('timer-seconds');
    const progressEl = document.getElementById('fast-progress');
    const progressHoursEl = document.getElementById('progress-hours');

    function pad(num) {
        return String(num).padStart(2, '0');
    }

    function formatDuration(hours) {
        if (hours < 1) {
            return Math.floor(hours * 60) + ' min';
        }
        return hours.toFixed(1) + ' hours';
    }

    function updateTimer() {
        const now = new Date();
        const diffMs = now - startedAt;
        const diffSeconds = Math.floor(diffMs / 1000);

        const hours = Math.floor(diffSeconds / 3600);
        const minutes = Math.floor((diffSeconds % 3600) / 60);
        const seconds = diffSeconds % 60;

        hoursEl.textContent = pad(hours);
        minutesEl.textContent = pad(minutes);
        secondsEl.textContent = pad(seconds);

        // Update progress bar if target exists
        if (targetHours > 0 && progressEl) {
            const currentHours = diffSeconds / 3600;
            const percent = Math.min(100, (currentHours / targetHours) * 100);
            progressEl.style.width = percent.toFixed(1) + '%';

            if (progressHoursEl) {
                progressHoursEl.textContent = formatDuration(currentHours);
            }
        }
    }

    // Initial update
    updateTimer();

    // Update every second
    setInterval(updateTimer, 1000);
})();
</script>
{% endif %}
{% endblock %}
