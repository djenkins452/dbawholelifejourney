{% extends "base.html" %}
{% load static %}
{% load safe_urls %}

{% block title %}Preferences - Whole Life Journey{% endblock %}

{% block content %}
<div class="content-container">
    <nav class="breadcrumb mb-4">
        <a href="{% url 'users:preferences' %}">Settings</a>
        <span>/</span>
        <span>Preferences</span>
    </nav>

    <div class="page-header">
        <div>
            <h1 class="page-title">Preferences</h1>
            <p class="page-subtitle">Customize your Whole Life Journey experience</p>
        </div>
        <button type="submit" form="preferences-form" class="btn btn-primary">Save Changes</button>
    </div>
    
    <form method="post" id="preferences-form">
        {% csrf_token %}
        
        <!-- Theme Section -->
        <div class="card mb-6">
            <h2 class="card-title">Appearance</h2>
            <p class="text-muted mb-4">Choose a visual theme that resonates with you.</p>
            
            <div class="form-group">
                <label for="id_theme" class="form-label">Theme</label>
                <select name="theme" id="id_theme" class="form-select">
                    {% for value, label in form.fields.theme.choices %}
                        <option value="{{ value }}" {% if form.theme.value == value %}selected{% endif %}>
                            {{ label }}
                        </option>
                    {% endfor %}
                </select>
                <p class="form-help">Each theme shapes the visual feel of your experience.</p>
            </div>
            
            <div class="form-group">
                <label for="id_accent_color" class="form-label">Custom Accent Color (Optional)</label>
                <div class="color-input-wrapper">
                    <input 
                        type="color" 
                        name="accent_color" 
                        id="id_accent_color" 
                        class="form-color"
                        value="{{ form.accent_color.value|default:'#6366f1' }}"
                    >
                    <input 
                        type="text" 
                        id="accent_color_text"
                        class="form-input form-color-text"
                        value="{{ form.accent_color.value|default:'' }}"
                        placeholder="Leave blank for theme default"
                        readonly
                    >
                    <button type="button" class="btn btn-ghost btn-sm" onclick="clearAccentColor()">Clear</button>
                </div>
                <p class="form-help">Override the theme's accent color with your own choice.</p>
            </div>
            
            <div class="text-right">
                <a href="{% url 'users:theme_selection' %}" class="btn btn-secondary btn-sm">
                    Preview All Themes ‚Üí
                </a>
            </div>
        </div>
        
        <!-- Modules Section -->
        <div class="card mb-6">
            <h2 class="card-title">Modules</h2>
            <p class="text-muted mb-4">Enable or disable life areas you want to track.</p>
            
            <!-- Active Modules -->
            <div class="module-section">
                <h3 class="module-section-title">Active Modules</h3>
                
                <div class="toggle-option">
                    <div class="toggle-info">
                        <div class="module-header">
                            <span class="module-icon">üìù</span>
                            <h4>Journal</h4>
                            <span class="module-status status-active">Active</span>
                        </div>
                        <p class="text-muted text-sm">
                            Daily reflections, guided prompts, mood tracking, and personal entries.
                        </p>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" name="journal_enabled" {% if form.journal_enabled.value %}checked{% endif %}>
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                
                <div class="toggle-option">
                    <div class="toggle-info">
                        <div class="module-header">
                            <span class="module-icon">‚úùÔ∏è</span>
                            <h4>Faith</h4>
                            <span class="module-status status-active">Active</span>
                        </div>
                        <p class="text-muted text-sm">
                            Scripture reading, prayer requests, faith milestones, and Christian encouragement throughout the app.
                        </p>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" name="faith_enabled" {% if form.faith_enabled.value %}checked{% endif %}>
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                
                <div class="toggle-option">
                    <div class="toggle-info">
                        <div class="module-header">
                            <span class="module-icon">‚ù§Ô∏è</span>
                            <h4>Health</h4>
                            <span class="module-status status-active">Active</span>
                        </div>
                        <p class="text-muted text-sm">
                            Track weight, fasting windows, heart rate, blood glucose, and view health trends over time.
                        </p>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" name="health_enabled" {% if form.health_enabled.value %}checked{% endif %}>
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                
                <div class="toggle-option">
                    <div class="toggle-info">
                        <div class="module-header">
                            <span class="module-icon">üè†</span>
                            <h4>Life</h4>
                            <span class="module-status status-active">Active</span>
                        </div>
                        <p class="text-muted text-sm">
                            Projects, tasks, calendar, inventory, pets, recipes, maintenance logs, and document storage.
                        </p>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" name="life_enabled" {% if form.life_enabled.value %}checked{% endif %}>
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                
                <div class="toggle-option">
                    <div class="toggle-info">
                        <div class="module-header">
                            <span class="module-icon">üß≠</span>
                            <h4>Purpose</h4>
                            <span class="module-status status-active">Active</span>
                        </div>
                        <p class="text-muted text-sm">
                            Annual direction, Word of the Year, life goals, change intentions, and seasonal reflections.
                        </p>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" name="purpose_enabled" {% if form.purpose_enabled.value %}checked{% endif %}>
                        <span class="toggle-slider"></span>
                    </label>
                </div>
            </div>
            
            <!-- Coming Soon Modules -->
            <div class="module-section mt-6">
                <h3 class="module-section-title">Coming Soon</h3>
                <p class="text-muted text-sm mb-4">These modules are in development. You'll be notified when they launch.</p>

                <div class="toggle-option disabled">
                    <div class="toggle-info">
                        <div class="module-header">
                            <span class="module-icon">üí∞</span>
                            <h4>Finances</h4>
                            <span class="module-status status-coming">Coming Soon</span>
                        </div>
                        <p class="text-muted text-sm">
                            Budget tracking, expense categories, savings goals, and financial insights.
                        </p>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" name="finances_enabled" disabled>
                        <span class="toggle-slider"></span>
                    </label>
                </div>

                <div class="toggle-option disabled">
                    <div class="toggle-info">
                        <div class="module-header">
                            <span class="module-icon">üë•</span>
                            <h4>Relationships</h4>
                            <span class="module-status status-coming">Coming Soon</span>
                        </div>
                        <p class="text-muted text-sm">
                            Track meaningful connections, remember important dates, and nurture relationships.
                        </p>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" name="relationships_enabled" disabled>
                        <span class="toggle-slider"></span>
                    </label>
                </div>

                <div class="toggle-option disabled">
                    <div class="toggle-info">
                        <div class="module-header">
                            <span class="module-icon">üîÑ</span>
                            <h4>Habits</h4>
                            <span class="module-status status-coming">Coming Soon</span>
                        </div>
                        <p class="text-muted text-sm">
                            Build positive habits with streaks, reminders, and progress tracking.
                        </p>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" name="habits_enabled" disabled>
                        <span class="toggle-slider"></span>
                    </label>
                </div>
            </div>
        </div>
        
        <!-- AI Features Section -->
        <div class="card mb-6">
            <h2 class="card-title">AI Features</h2>
            <p class="text-muted mb-4">AI-powered insights and encouragement for your journey.</p>

            <div class="toggle-option">
                <div class="toggle-info">
                    <div class="module-header">
                        <span class="module-icon">ü§ñ</span>
                        <h4>AI Insights</h4>
                        {% if form.ai_enabled.value %}<span class="module-status status-active">Active</span>{% endif %}
                    </div>
                    <p class="text-muted text-sm">
                        AI-powered pattern recognition, personalized encouragement, and reflective prompts based on your journey.
                        AI provides thoughts to consider ‚Äî never medical, financial, or spiritual advice.
                    </p>
                </div>
                <label class="toggle-switch">
                    <input type="checkbox" name="ai_enabled" id="ai_enabled_toggle" {% if form.ai_enabled.value %}checked{% endif %}>
                    <span class="toggle-slider"></span>
                </label>
            </div>

            <div class="toggle-option" id="ai-data-consent-option" {% if not form.ai_enabled.value %}style="display: none;"{% endif %}>
                <div class="toggle-info">
                    <div class="module-header">
                        <span class="module-icon">üîí</span>
                        <h4>AI Data Processing Consent</h4>
                        {% if form.ai_data_consent.value %}<span class="module-status status-active">Granted</span>{% endif %}
                    </div>
                    <p class="text-muted text-sm">
                        <strong>Required for AI features.</strong> I consent to having my personal data (journal entries, health metrics, goals, etc.)
                        processed by AI to provide personalized insights. Data is sent to OpenAI's API for analysis.
                        Images from camera scanning are processed in real-time and <strong>never stored</strong>.
                    </p>
                </div>
                <label class="toggle-switch">
                    <input type="checkbox" name="ai_data_consent" id="ai_data_consent_toggle" {% if form.ai_data_consent.value %}checked{% endif %}>
                    <span class="toggle-slider"></span>
                </label>
            </div>
            
            <!-- AI Coaching Style (shown when AI is enabled) -->
            <div id="ai-coaching-section" class="ai-coaching-section {% if not form.ai_enabled.value %}hidden{% endif %}">
                <h3 class="module-section-title mt-6">AI Coaching Style</h3>
                <p class="text-muted text-sm mb-4">
                    Choose how you'd like the AI to communicate with you. This affects the tone of insights, encouragements, and accountability nudges.
                </p>
                
                <div class="coaching-style-options">
                    {% for style in coaching_styles %}
                    <label class="coaching-style-card {% if form.ai_coaching_style.value == style.key or not form.ai_coaching_style.value and style.is_default %}selected{% endif %}">
                        <input type="radio" name="ai_coaching_style" value="{{ style.key }}"
                               {% if form.ai_coaching_style.value == style.key or not form.ai_coaching_style.value and style.is_default %}checked{% endif %}>
                        <div class="card-content">
                            <div class="card-icon">{{ style.icon }}</div>
                            <div class="card-text">
                                <div class="card-title">{{ style.name }}</div>
                                <div class="card-description">{{ style.description }}</div>
                            </div>
                        </div>
                    </label>
                    {% empty %}
                    <!-- Fallback if no styles in database -->
                    <label class="coaching-style-card selected">
                        <input type="radio" name="ai_coaching_style" value="supportive" checked>
                        <div class="card-content">
                            <div class="card-icon">ü§ù</div>
                            <div class="card-text">
                                <div class="card-title">Supportive Partner</div>
                                <div class="card-description">Balanced warmth with gentle accountability.</div>
                            </div>
                        </div>
                    </label>
                    {% endfor %}
                </div>
            </div>

            <!-- AI Personal Profile (shown when AI is enabled and consent given) -->
            <div id="ai-profile-section" class="ai-profile-section {% if not form.ai_enabled.value or not form.ai_data_consent.value %}hidden{% endif %}">
                <h3 class="module-section-title mt-6">Personal AI Profile</h3>
                <p class="text-muted text-sm mb-4">
                    Help the AI understand you better by sharing relevant details about yourself.
                    This information personalizes insights, encouragement, and suggestions.
                    <strong>Only share what you're comfortable with.</strong>
                </p>

                <div class="form-group">
                    <label for="id_ai_profile" class="form-label">About You</label>
                    <textarea
                        name="ai_profile"
                        id="id_ai_profile"
                        class="form-textarea"
                        rows="6"
                        maxlength="2000"
                        placeholder="Tell the AI about yourself to personalize your experience...

Examples:
‚Ä¢ Age and life stage (e.g., 'I'm in my 40s with two teenagers')
‚Ä¢ Family situation (e.g., 'married, work-from-home parent')
‚Ä¢ Health focus (e.g., 'managing blood pressure, trying to lose 20lbs')
‚Ä¢ Faith journey (e.g., 'growing Christian seeking deeper prayer life')
‚Ä¢ Interests (e.g., 'love hiking, cooking, woodworking')
‚Ä¢ Work/career (e.g., 'software developer, often stressed about deadlines')"
                    >{{ form.ai_profile.value|default:'' }}</textarea>
                    <div class="form-help-row">
                        <p class="form-help">This information is used only to personalize AI responses. It is never shared externally.</p>
                        <span class="char-counter" id="ai-profile-counter">
                            <span id="ai-profile-length">{{ form.ai_profile.value|length|default:0 }}</span>/2000
                        </span>
                    </div>
                </div>

                <div class="ai-profile-tips">
                    <h4 class="tips-title">Tips for a great profile:</h4>
                    <ul class="tips-list">
                        <li>Be specific about your current life situation and goals</li>
                        <li>Mention health conditions relevant to your wellness journey</li>
                        <li>Share your communication preferences (e.g., "I respond well to direct feedback")</li>
                        <li>Include what motivates you and what you're working on</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Faith Settings Section (shown when Faith module is enabled) -->
        <div class="card mb-6" id="faith-settings-section" {% if not form.faith_enabled.value %}style="display: none;"{% endif %}>
            <h2 class="card-title">Faith Settings</h2>
            <p class="text-muted mb-4">Configure your Faith module preferences.</p>

            <div class="form-group">
                <label for="bible-translation-select" class="form-label">Default Bible Translation</label>
                <select id="bible-translation-select" class="form-select">
                    <option value="">Loading translations...</option>
                </select>
                <input type="hidden" name="default_bible_translation" id="id_default_bible_translation"
                       value="{{ form.default_bible_translation.value|default:'' }}">
                <p class="form-help">This translation will be pre-selected when you look up Scripture. You can still change it on the Scripture page.</p>
            </div>
        </div>

        <!-- Location Section -->
        <div class="card mb-6">
            <h2 class="card-title">Location</h2>
            <p class="text-muted mb-4">Used for weather context (optional).</p>
            
            <!-- US ZIP Code Lookup -->
            <div class="form-group">
                <label for="zip_code" class="form-label">
                    ZIP Code (US only)
                    <span class="form-label-hint">‚Äî auto-fills city</span>
                </label>
                <div class="zip-input-wrapper">
                    <input 
                        type="text" 
                        id="zip_code" 
                        class="form-input"
                        placeholder="e.g., 37201"
                        maxlength="5"
                        pattern="[0-9]{5}"
                    >
                    <button type="button" class="btn btn-secondary btn-sm" onclick="lookupZip()">
                        Lookup
                    </button>
                </div>
                <p class="form-help" id="zip_status"></p>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="id_location_city" class="form-label">City</label>
                    <input 
                        type="text" 
                        name="location_city" 
                        id="id_location_city" 
                        class="form-input"
                        value="{{ form.location_city.value|default:'' }}"
                        placeholder="e.g., Nashville"
                    >
                </div>
                
                <div class="form-group">
                    <label for="id_location_state" class="form-label">State/Country</label>
                    <input 
                        type="text" 
                        name="location_country" 
                        id="id_location_country" 
                        class="form-input"
                        value="{{ form.location_country.value|default:'' }}"
                        placeholder="e.g., Tennessee, US"
                    >
                </div>
            </div>
            
            <div class="form-group">
                <label for="id_timezone" class="form-label">Timezone</label>
                <select name="timezone" id="id_timezone" class="form-select">
                    {% for value, label in form.fields.timezone.widget.choices %}
                        <option value="{{ value }}" {% if form.timezone.value == value %}selected{% endif %}>
                            {{ label }}
                        </option>
                    {% endfor %}
                </select>
            </div>
        </div>

        <!-- Notifications Section -->
        <div class="card mb-6">
            <h2 class="card-title">Notifications</h2>
            <p class="text-muted mb-4">Control how the app communicates with you.</p>

            <div class="toggle-option">
                <div class="toggle-info">
                    <div class="module-header">
                        <span class="module-icon">üì¢</span>
                        <h4>What's New Updates</h4>
                        {% if form.show_whats_new.value %}<span class="module-status status-active">Active</span>{% endif %}
                    </div>
                    <p class="text-muted text-sm">
                        Show a popup when new features, improvements, or fixes are released.
                        You can always view all updates from the <a href="{% url 'core:whats_new_list' %}">What's New</a> page.
                    </p>
                </div>
                <label class="toggle-switch">
                    <input type="checkbox" name="show_whats_new" {% if form.show_whats_new.value %}checked{% endif %}>
                    <span class="toggle-slider"></span>
                </label>
            </div>
        </div>

        <!-- Security Section -->
        <div class="card mb-6" id="security-section">
            <h2 class="card-title">Security</h2>
            <p class="text-muted mb-4">Manage login and authentication options.</p>

            <div class="toggle-option" id="biometric-option">
                <div class="toggle-info">
                    <div class="module-header">
                        <span class="module-icon">üîê</span>
                        <h4>Biometric Login</h4>
                        {% if form.biometric_login_enabled.value %}<span class="module-status status-active">Enabled</span>{% endif %}
                    </div>
                    <p class="text-muted text-sm" id="biometric-description">
                        Use Face ID, Touch ID, or device biometrics for quick, secure login on this device.
                        <span id="biometric-support-status"></span>
                    </p>
                    <div id="biometric-credentials-list" class="mt-3" style="display: none;">
                        <!-- Registered devices will be listed here -->
                    </div>
                </div>
                <div id="biometric-toggle-wrapper">
                    <label class="toggle-switch" id="biometric-toggle-label">
                        <input type="checkbox" name="biometric_login_enabled" id="biometric_toggle" {% if form.biometric_login_enabled.value %}checked{% endif %}>
                        <span class="toggle-slider"></span>
                    </label>
                </div>
            </div>

            <div id="biometric-setup-section" style="display: none;" class="mt-4 p-4 bg-surface border rounded-md">
                <h4 class="text-base font-semibold mb-2">Set Up Biometric Login</h4>
                <p class="text-muted text-sm mb-3">
                    To enable biometric login, we'll register this device's biometric authenticator.
                    Your biometric data never leaves your device.
                </p>
                <button type="button" id="register-biometric-btn" class="btn btn-primary btn-sm">
                    Register This Device
                </button>
                <p id="biometric-status-message" class="text-sm mt-2" style="display: none;"></p>
            </div>
        </div>

        <!-- Integrations Section -->
        <div class="card mb-6">
            <h2 class="card-title">Integrations</h2>
            <p class="text-muted mb-4">Connect external services to enhance your experience.</p>

            <div class="integration-item">
                <div class="integration-icon">
                    <svg viewBox="0 0 24 24" width="32" height="32" fill="none" stroke="currentColor" stroke-width="1.5">
                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                        <line x1="16" y1="2" x2="16" y2="6"/>
                        <line x1="8" y1="2" x2="8" y2="6"/>
                        <line x1="3" y1="10" x2="21" y2="10"/>
                    </svg>
                </div>
                <div class="integration-info">
                    <h4>Google Calendar</h4>
                    <p class="text-muted text-sm">
                        Sync your events between Whole Life Journey and Google Calendar.
                    </p>
                    {% if google_calendar_connected %}
                    <p class="integration-status integration-connected">
                        <svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                            <polyline points="22 4 12 14.01 9 11.01"/>
                        </svg>
                        Connected{% if google_calendar_name %} ‚Äî {{ google_calendar_name }}{% endif %}
                    </p>
                    {% else %}
                    <p class="integration-status integration-disconnected">
                        Not connected
                    </p>
                    {% endif %}
                </div>
                <div class="integration-actions">
                    <a href="{% safe_url 'life:google_calendar_settings' fallback='/life/' %}" class="btn btn-secondary btn-sm">
                        {% if google_calendar_connected %}Manage{% else %}Connect{% endif %}
                    </a>
                </div>
            </div>
        </div>
        
        <!-- Save -->
        <div class="form-actions">
            <button type="submit" class="btn btn-primary">
                Save Preferences
            </button>
        </div>
    </form>
</div>

<style>
.module-section-title {
    font-size: var(--font-size-sm);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--color-text-muted);
    margin-bottom: var(--space-4);
    padding-bottom: var(--space-2);
    border-bottom: 1px solid var(--color-border);
}

.toggle-option {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    padding: var(--space-4);
    margin-bottom: var(--space-3);
    background: var(--color-surface);
    border-radius: var(--radius-md);
    border: 1px solid var(--color-border);
}

.toggle-option:last-child {
    margin-bottom: 0;
}

.toggle-option.disabled {
    opacity: 0.7;
}

.toggle-info {
    flex: 1;
    padding-right: var(--space-4);
}

.module-header {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    margin-bottom: var(--space-2);
}

.module-icon {
    font-size: var(--font-size-xl);
}

.module-header h4 {
    font-size: var(--font-size-base);
    margin: 0;
}

.module-status {
    font-size: var(--font-size-xs);
    padding: var(--space-1) var(--space-2);
    border-radius: var(--radius-full);
    font-weight: 500;
}

.toggle-switch {
    position: relative;
    display: inline-block;
    width: 48px;
    height: 28px;
    flex-shrink: 0;
}

.toggle-switch input {
    opacity: 0;
    width: 0;
    height: 0;
}

.toggle-slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: var(--color-border);
    transition: var(--transition-fast);
    border-radius: var(--radius-full);
}

.toggle-slider:before {
    position: absolute;
    content: "";
    height: 20px;
    width: 20px;
    left: 4px;
    bottom: 4px;
    background-color: white;
    transition: var(--transition-fast);
    border-radius: var(--radius-full);
}

.toggle-switch input:checked + .toggle-slider {
    background-color: var(--color-accent);
}

.toggle-switch input:checked + .toggle-slider:before {
    transform: translateX(20px);
}

.color-input-wrapper {
    display: flex;
    align-items: center;
    gap: var(--space-2);
}

.form-color {
    width: 50px;
    height: 38px;
    padding: 0;
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    cursor: pointer;
}

.form-color-text {
    flex: 1;
    max-width: 150px;
}

.zip-input-wrapper {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    max-width: 250px;
}

.zip-input-wrapper .form-input {
    flex: 1;
}

.form-label-hint {
    font-weight: normal;
    color: var(--color-text-muted);
    font-size: var(--font-size-sm);
}

.form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: var(--space-4);
}

@media (max-width: 640px) {
    .form-row {
        grid-template-columns: 1fr;
    }
    
    .toggle-option {
        flex-direction: column;
        gap: var(--space-3);
    }
    
    .toggle-info {
        padding-right: 0;
    }
}

/* Integrations */
.integration-item {
    display: flex;
    align-items: flex-start;
    gap: var(--space-4);
    padding: var(--space-4);
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    margin-bottom: var(--space-3);
}

.integration-item:last-child {
    margin-bottom: 0;
}

.integration-icon {
    width: 48px;
    height: 48px;
    background: var(--color-background);
    border-radius: var(--radius-md);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--color-accent);
    flex-shrink: 0;
}

.integration-info {
    flex: 1;
}

.integration-info h4 {
    font-size: var(--font-size-base);
    font-weight: 600;
    margin: 0 0 var(--space-1) 0;
}

.integration-status {
    display: flex;
    align-items: center;
    gap: var(--space-1);
    font-size: var(--font-size-sm);
    margin-top: var(--space-2);
}

.integration-connected {
    color: var(--color-success, #10b981);
}

.integration-disconnected {
    color: var(--color-text-muted);
}

.integration-actions {
    flex-shrink: 0;
}

.integration-coming-soon {
    opacity: 0.6;
}

.coming-soon-badge {
    display: inline-block;
    font-size: var(--font-size-xs);
    background: var(--color-border);
    color: var(--color-text-muted);
    padding: var(--space-1) var(--space-2);
    border-radius: var(--radius-sm);
    margin-top: var(--space-2);
}

@media (max-width: 640px) {
    .integration-item {
        flex-direction: column;
        text-align: center;
    }
    
    .integration-actions {
        width: 100%;
    }
    
    .integration-actions .btn {
        width: 100%;
    }
}

/* AI Coaching Style Cards */
.ai-coaching-section {
    margin-top: var(--space-4);
    padding-top: var(--space-4);
    border-top: 1px solid var(--color-border);
}

.ai-coaching-section.hidden {
    display: none;
}

.coaching-style-options {
    display: grid;
    grid-template-columns: 1fr;
    gap: var(--space-3);
}

@media (min-width: 640px) {
    .coaching-style-options {
        grid-template-columns: repeat(2, 1fr);
    }
}

@media (min-width: 1024px) {
    .coaching-style-options {
        grid-template-columns: repeat(3, 1fr);
    }
}

@media (min-width: 1280px) {
    .coaching-style-options {
        grid-template-columns: repeat(4, 1fr);
    }
}

.coaching-style-card {
    display: block;
    cursor: pointer;
    border: 2px solid var(--color-border);
    border-radius: var(--radius-lg);
    padding: var(--space-4);
    transition: all var(--transition-fast);
    background: var(--color-background);
}

.coaching-style-card:hover {
    border-color: var(--color-accent);
    background: var(--color-surface);
}

.coaching-style-card.selected,
.coaching-style-card:has(input:checked) {
    border-color: var(--color-accent);
    background: color-mix(in srgb, var(--color-accent) 5%, var(--color-background));
    box-shadow: 0 0 0 3px color-mix(in srgb, var(--color-accent) 15%, transparent);
}

.coaching-style-card input[type="radio"] {
    position: absolute;
    opacity: 0;
    pointer-events: none;
}

.card-content {
    display: flex;
    flex-direction: column;
    text-align: center;
}

.card-icon {
    font-size: 2rem;
    line-height: 1;
    margin: 0 auto var(--space-2);
}

.card-text {
    flex: 1;
}

.card-title {
    font-weight: 600;
    font-size: var(--font-size-base);
    color: var(--color-text);
    margin-bottom: var(--space-1);
}

.card-description {
    color: var(--color-text-muted);
    font-size: var(--font-size-sm);
    line-height: var(--line-height-relaxed);
}

/* AI Profile Section */
.ai-profile-section {
    margin-top: var(--space-4);
    padding-top: var(--space-4);
    border-top: 1px solid var(--color-border);
}

.ai-profile-section.hidden {
    display: none;
}

.form-textarea {
    width: 100%;
    padding: var(--space-3);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    background: var(--color-background);
    color: var(--color-text);
    font-family: inherit;
    font-size: var(--font-size-base);
    line-height: var(--line-height-relaxed);
    resize: vertical;
    min-height: 120px;
}

.form-textarea:focus {
    outline: none;
    border-color: var(--color-accent);
    box-shadow: 0 0 0 3px color-mix(in srgb, var(--color-accent) 15%, transparent);
}

.form-textarea::placeholder {
    color: var(--color-text-muted);
    opacity: 0.7;
}

.form-help-row {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-top: var(--space-2);
    gap: var(--space-4);
}

.char-counter {
    font-size: var(--font-size-xs);
    color: var(--color-text-muted);
    white-space: nowrap;
}

.ai-profile-tips {
    margin-top: var(--space-4);
    padding: var(--space-4);
    background: color-mix(in srgb, var(--color-accent) 5%, var(--color-background));
    border-radius: var(--radius-md);
    border: 1px solid color-mix(in srgb, var(--color-accent) 20%, transparent);
}

.tips-title {
    font-size: var(--font-size-sm);
    font-weight: 600;
    color: var(--color-text);
    margin: 0 0 var(--space-2) 0;
}

.tips-list {
    margin: 0;
    padding-left: var(--space-5);
    font-size: var(--font-size-sm);
    color: var(--color-text-muted);
}

.tips-list li {
    margin-bottom: var(--space-1);
}

.tips-list li:last-child {
    margin-bottom: 0;
}
</style>

<script src="{% static 'js/timezone-lookup.js' %}"></script>
<script>
// Accent color handling
document.getElementById('id_accent_color').addEventListener('input', function(e) {
    document.getElementById('accent_color_text').value = e.target.value;
});

function clearAccentColor() {
    document.getElementById('id_accent_color').value = '#6366f1';
    document.getElementById('accent_color_text').value = '';
}

// AI coaching style, data consent, and profile toggle visibility
function updateAIProfileVisibility() {
    const aiEnabled = document.getElementById('ai_enabled_toggle').checked;
    const consentEnabled = document.getElementById('ai_data_consent_toggle').checked;
    const profileSection = document.getElementById('ai-profile-section');

    if (profileSection) {
        if (aiEnabled && consentEnabled) {
            profileSection.classList.remove('hidden');
        } else {
            profileSection.classList.add('hidden');
        }
    }
}

document.getElementById('ai_enabled_toggle').addEventListener('change', function() {
    const coachingSection = document.getElementById('ai-coaching-section');
    const dataConsentOption = document.getElementById('ai-data-consent-option');
    if (this.checked) {
        coachingSection.classList.remove('hidden');
        if (dataConsentOption) dataConsentOption.style.display = 'flex';
    } else {
        coachingSection.classList.add('hidden');
        if (dataConsentOption) dataConsentOption.style.display = 'none';
    }
    updateAIProfileVisibility();
});

// Data consent toggle also affects profile visibility
document.getElementById('ai_data_consent_toggle').addEventListener('change', function() {
    updateAIProfileVisibility();
});

// Character counter for AI profile
const aiProfileTextarea = document.getElementById('id_ai_profile');
const aiProfileLengthSpan = document.getElementById('ai-profile-length');
if (aiProfileTextarea && aiProfileLengthSpan) {
    aiProfileTextarea.addEventListener('input', function() {
        aiProfileLengthSpan.textContent = this.value.length;
    });
}

// Coaching style card selection
document.querySelectorAll('.coaching-style-card input[type="radio"]').forEach(radio => {
    radio.addEventListener('change', function() {
        document.querySelectorAll('.coaching-style-card').forEach(card => {
            card.classList.remove('selected');
        });
        if (this.checked) {
            this.closest('.coaching-style-card').classList.add('selected');
        }
    });
});

// Faith settings section visibility
const faithToggle = document.querySelector('input[name="faith_enabled"]');
if (faithToggle) {
    faithToggle.addEventListener('change', function() {
        const faithSection = document.getElementById('faith-settings-section');
        if (faithSection) {
            faithSection.style.display = this.checked ? 'block' : 'none';
        }
    });
}

// Bible translation loading for preferences
// Security: API key is kept server-side, accessed via proxy
const API_PROXY_BASE = '/faith/api/bible';
const savedTranslation = document.getElementById('id_default_bible_translation')?.value || '';

async function loadBibleTranslations() {
    const select = document.getElementById('bible-translation-select');
    if (!select) return;

    try {
        // First check if API is configured (server-side)
        const statusResponse = await fetch(`${API_PROXY_BASE}/status/`);
        const statusData = await statusResponse.json();

        if (!statusData.configured) {
            select.innerHTML = '<option value="">API not configured</option>';
            return;
        }

        const response = await fetch(`${API_PROXY_BASE}/bibles/`);

        if (!response.ok) {
            throw new Error('Failed to load translations');
        }

        const data = await response.json();
        const bibles = data.data || [];

        // Sort and deduplicate by abbreviation
        const seen = new Set();
        const uniqueBibles = [];
        bibles.sort((a, b) => a.name.localeCompare(b.name));

        for (const bible of bibles) {
            const key = bible.abbreviation || bible.name;
            if (!seen.has(key)) {
                seen.add(key);
                uniqueBibles.push(bible);
            }
        }

        select.innerHTML = '<option value="">Select a translation</option>';
        uniqueBibles.forEach(bible => {
            const option = document.createElement('option');
            option.value = bible.id;
            option.textContent = `${bible.abbreviation} - ${bible.name}`;
            if (bible.id === savedTranslation) {
                option.selected = true;
            }
            select.appendChild(option);
        });

        // Sync select with hidden input
        select.addEventListener('change', function() {
            document.getElementById('id_default_bible_translation').value = this.value;
        });

    } catch (error) {
        console.error('Error loading Bible translations:', error);
        select.innerHTML = '<option value="">Error loading translations</option>';
    }
}

// Load translations when page loads (if faith section visible)
document.addEventListener('DOMContentLoaded', function() {
    const faithSection = document.getElementById('faith-settings-section');
    if (faithSection && faithSection.style.display !== 'none') {
        loadBibleTranslations();
    }

    // Also load when faith is toggled on
    const faithToggle = document.querySelector('input[name="faith_enabled"]');
    if (faithToggle) {
        faithToggle.addEventListener('change', function() {
            if (this.checked) {
                loadBibleTranslations();
            }
        });
    }
});
</script>
<script src="{% static 'js/biometric.js' %}"></script>
{% endblock %}